(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[116],{8868:function(e,t,n){Promise.resolve().then(n.t.bind(n,6685,23)),Promise.resolve().then(n.bind(n,3786)),Promise.resolve().then(n.bind(n,5653))},4230:function(e,t,n){"use strict";n.d(t,{BE:function(){return B},Bk:function(){return i},G:function(){return M},L3:function(){return R},Sl:function(){return y},Vz:function(){return z},Yf:function(){return P},Z2:function(){return A},_Y:function(){return r},gW:function(){return _},jy:function(){return x},lm:function(){return k},n2:function(){return T},or:function(){return E}});var o,l,i,r,a=n(3014),s=n(6350),c=n(7898),u=n(1280),d=n(9073),f=n(9158),h=n(2261),m=n(9234),p=n(9107);function x(e,t,n,o,l,i){let r=e.render,{vecId:u}=w(o),{cx:p}=_(n,o),x=0===u?1:0,y=(0,h.W)(l);if(l===h.Zy.None)return;let g=(0,a.pu)(t,n,o,0),v=(0,a.pu)(t,n,o,p-1)+t.cell,b=(v+g)/2,A=o===f.JU.X?new f.AO(b,n.y+n.dz,n.z+n.dz):new f.AO(n.x,b,n.z+n.dz),k=o===f.JU.X?-1:1,T=(0,m.zG)(e,A),O=2.5*(T=Math.min(T,1)),B=(0,c.Ux)(r.modelFontBuf,y,O),z=o===f.JU.X?B/2+.4*O:o===f.JU.Y?O/2+.4*O:0,E=.3*O,R=O/2*.5,M=(0,h.c6)(l).mul(i),P=new f.AO(n.x,n.y+n.dy,n.z+n.dz+.1).setAt(u,b).withAddAt(x,-k*(O/2+E)),F=0,C=B>v-g-2*z;C&&(F=k*O);let j=d.OO.fromTranslation(P),D=o===f.JU.X?-B/2:o===f.JU.Y?-B/2:0,I=o===f.JU.X?-F-O/2:o===f.JU.Y?-O/2:0;(0,c.Dp)(r.modelFontBuf,y,M,D,I,O,j);let L=n.x,U=n.y+n.dy,S=n.z+n.dz+.1,N=.02*O,X=new f.AO(0,0,1);C&&(z=0);let W=new f.AO(L,U,S).withAddAt(x,-k*(O/2+E)),Z=W.withSetAt(u,g),Y=W.withSetAt(u,v),V=W.withSetAt(u,b-z),G=W.withSetAt(u,b+z);(0,s.j0)(r.lineRender,N,M,Z,V,X),(0,s.j0)(r.lineRender,N,M,Y,G,X),(0,s.j0)(r.lineRender,N,M,Z.withAddAt(x,R),Z.withAddAt(x,-R),X),(0,s.j0)(r.lineRender,N,M,Y.withAddAt(x,R),Y.withAddAt(x,-R),X)}function y(e,t,n,o,l,i,r,s){if(0===s)return;let m=h.Zy[l]+"="+Math.round(i).toFixed(0),p=(0,c.Ux)(e.modelFontBuf,m,2,""),x=(0,a.pu)(t,n,o,Math.floor(i))+t.cell/2,y=(0,a.pu)(t,n,o,Math.ceil(i))+t.cell/2,g=(0,u.t7)(x,y,i-Math.floor(i))+(0,u.JF)(0,r,Math.min(i,1)),v=(0,h.c6)(l).mul(s),b=d.OO.fromTranslation(new f.AO(g,n.y-1,n.z+n.dz));(0,c.Dp)(e.modelFontBuf,m,v,-p/2,-2,2,b,"")}let g={vecId:0,xName:"x",dxName:"dx",cxName:"cx",offXName:"offX",sizeXName:"sizeX"},v={vecId:1,xName:"y",dxName:"dy",cxName:"cy",offXName:"offY",sizeXName:"sizeY"},b={vecId:2,xName:"z",dxName:"dz",cxName:"cz",offXName:"offZ",sizeXName:"sizeZ"};function w(e){return e===f.JU.X?g:e===f.JU.Y?v:b}function _(e,t){var n,o,l,i,r,a;switch(t){case f.JU.X:return{x:e.x,cx:e.cx,dx:e.dx,rangeOffsets:e.rangeOffsetsX,offX:null!==(n=e.offX)&&void 0!==n?n:0,sizeX:null!==(o=e.sizeX)&&void 0!==o?o:e.cx};case f.JU.Y:return{x:e.y,cx:e.cy,dx:e.dy,rangeOffsets:e.rangeOffsetsY,offX:null!==(l=e.offY)&&void 0!==l?l:0,sizeX:null!==(i=e.sizeY)&&void 0!==i?i:e.cy};case f.JU.Z:return{x:e.z,cx:e.cz,dx:e.dz,rangeOffsets:e.rangeOffsetsZ,offX:null!==(r=e.offZ)&&void 0!==r?r:0,sizeX:null!==(a=e.sizeZ)&&void 0!==a?a:e.cz}}}function A(e,t){let n={...t,access:t.access?{...t.access}:void 0};return n.name="",e.cubes.push(n),n}function k(e,t,n,o){let{x:l,cx:i,rangeOffsets:r}=_(t,n);if(i<=1)return t;if(r&&t.subs)for(let l of t.subs){let t=T(e,l,n,o,0);if(t)return t}return T(e,t,n,o,0)}function T(e,t,n,o,l){let i,{offX:r,sizeX:a}=_(t,n),s=[],c=[],d=Math.floor(o)-r;if(d<0||d>=a)return null;if(a<=1)return t;function h(o,l,i){var r;let a=O(e,t,n,o,l,i);return a&&(s.push(a.subBlock),c.push(a.rangeOffset)),null!==(r=null==a?void 0:a.subBlock)&&void 0!==r?r:null}if(0===l)h(0,d,0),i=h(d,d+1,0),h(d+1,a,0);else{let e=(o-d-.5)*.5+.5,t=e+.5<1,n=e-.5>0,r=(0,u.JF)(-l,0,(o-.5)*.5+.5);h(0,d-(t?1:0),r+0),t&&h(d-1,d,r+(0,u.JF)(l,0,e+.5)),i=h(d,d+1,r+(0,u.JF)(l,0,e)),n&&h(d+1,d+2,r+(0,u.JF)(l,0,e-.5)),h(d+(n?2:1),a,r+l)}return s.length>0?(n===f.JU.X&&(t.rangeOffsetsX=c),n===f.JU.Y&&(t.rangeOffsetsY=c),n===f.JU.Z&&(t.rangeOffsetsZ=c),t.subs=s,i):null}function O(e,t,n,o,l,i){var r;let{x:a,cx:s,sizeX:c,offX:u}=_(t,n),{vecId:h,xName:m,dxName:p,offXName:x,sizeXName:y}=w(n);if(o>=l||l<=0||o>=c)return null;let g=d.OO.fromScaleTranslation(new f.AO(1,1,1).setAt(h,(l-o)/c),new f.AO().setAt(h,o/c));return{subBlock:{...t,[p]:(l-o)*e.cell,access:t.access&&{...t.access},localMtx:(null!==(r=t.localMtx)&&void 0!==r?r:new d.OO).mul(g),[m]:a+(o*e.cell+i),[x]:o+u,[y]:l-o},rangeOffset:[l,i]}}function B(e,t,n){let{dx:o}=_(t,n),l=Math.ceil(o/e.cell),i=[],r=[];for(let o=0;o<l;o+=1){let l=O(e,t,n,o,o+1,0);i.push(l.subBlock),r.push(l.rangeOffset)}return n===f.JU.X&&(t.rangeOffsetsX=r),n===f.JU.Y&&(t.rangeOffsetsY=r),n===f.JU.Z&&(t.rangeOffsetsZ=r),t.subs=i,i}function z(e,t,n,o,l){let i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,h=arguments.length>8?arguments[8]:void 0,{modelFontBuf:m,lineRender:p}=e;if(i=i||3,!u){u=new Float32Array(i);for(let e=0;e<i;e+=1)u[e]=e+r}let x=1*t.cell,y=n.y-x-t.cell,g=[],v=0,b=0;for(let e of u){if(b>=i)break;let n=(0,c.Ux)(m,""+e,x),o=Math.max(t.cell,n);g.push({val:e,textOffset:v,w:n,i:b,space:o}),v+=o,b+=1}let w=(0,a.pu)(t,n,f.JU.X,r),_=d.OO.fromTranslation(new f.AO(0,y,0)),A=w-v/2+t.cell*i/2;for(let e of(o=o.mul(l),g)){let l=A+e.textOffset+e.space/2-e.w/2,i=o;if(h){let t=h.mixes[e.i];t>0&&(i=f.T8.lerp(o,h.color2,t))}(0,c.Dp)(m,""+e.val,i,l,0,x,_);let u=l+e.w/2,d=(0,a.pu)(t,n,f.JU.X,e.i+r)+.5*t.cell,g=y+x,v=.1*x,b=Math.max(n.y-.3,g),w=.02*x;(0,s.j0)(p,w,i,new f.AO(u,g+v,0),new f.AO(d,b-v,0),new f.AO(0,0,1))}}function E(e,t,n,o,l,i,r,c,d,h){let m=n.y+n.dy+i,p=o.y-r,x=(0,u.t7)(m,p,h),y=(0,a.pu)(t,n,f.JU.X,c)+.5*t.cell,g=(0,a.pu)(t,o,f.JU.X,d)+.5*t.cell,v=new f.AO(0,0,1),b=.025*t.cell;(0,s.j0)(e.lineRender,b,l,new f.AO(y,m,0),new f.AO(y,x,0),v),(0,s.j0)(e.lineRender,b,l,new f.AO(y,x,0),new f.AO(g,x,0),v),(0,s.j0)(e.lineRender,b,l,new f.AO(g,x,0),new f.AO(g,p,0),v)}function R(e,t,n,o){if(!e.subs)return[];let l=t===f.JU.X?e.rangeOffsetsX:t===f.JU.Y?e.rangeOffsetsY:e.rangeOffsetsZ;n=null===n?null:Math.floor(n),o=null===o?null:Math.floor(o);let i=[],r=0;for(let t=0;t<e.subs.length;t+=1){var a;let s=null==l?void 0:null===(a=l[t])||void 0===a?void 0:a[0];if((0,p.kK)(s))break;(null===n||n<s)&&(null===o||o>=r)&&i.push(e.subs[t]),r=s}return i}function M(e,t,n,o){let{modelFontBuf:l}=e,a=o.color||new f.T8(0,0,0,1),s=o.align||r.Left,u=o.valign||i.Top,h=o.size||1,m=o.face,p=(0,c.Ux)(l,t,h),x=n.x,y=n.y;n.z,s===r.Center?x-=p/2:s===r.Right&&(x-=p),u===i.Middle?y-=h/2:u===i.Bottom&&(y-=h);let g=d.OO.fromTranslation(new f.AO(x,y,0));(0,c.Dp)(l,t,a,0,0,h,g,m)}function P(e,t,n,o,l,i,r){let c=(0,a.pu)(t,n,f.JU.X,l.x)+.5*t.cell,u=(0,a.pu)(t,n,f.JU.Y,l.y)+.5*t.cell,d=(0,a.pu)(t,n,f.JU.Z,n.cz-1)+t.cell,h=(0,a.pu)(t,o,f.JU.X,i.x)+.5*t.cell,m=(0,a.pu)(t,o,f.JU.Y,i.y)+.5*t.cell,p=(0,a.pu)(t,o,f.JU.Z,o.cz-1)+t.cell,x=new f.AO(c,u,d),y=new f.AO(h,m,p),g=x.add(y).mul(.5),v=f.AO.cross(x.sub(y),new f.AO(1.2,1,0)).normalize().mul(10);v.z>d&&(v=v.mul(-1));let b=v.add(g),w=x.dist(b),_=2*Math.asin(x.dist(g)/w),A=f.AO.cross(b.sub(x),b.sub(y)).normalize(),k=x.sub(b),T=x;for(let t=0;t<=20;t++){let n=t/20,o=b.add(k.rotateAbout(A,n*_));(0,s.j0)(e.lineRender,3,r,T,o),T=o}}(o=i||(i={}))[o.Top=0]="Top",o[o.Middle=1]="Middle",o[o.Bottom=2]="Bottom",(l=r||(r={}))[l.Left=0]="Left",l[l.Center=1]="Center",l[l.Right=2]="Right"},9234:function(e,t,n){"use strict";n.d(t,{H4:function(){return c},L7:function(){return a},aT:function(){return r},zG:function(){return s}});var o=n(9073),l=n(9158),i=n(9107);function r(e){for(;e.angle.x<0;)e.angle.x+=360;for(;e.angle.x>360;)e.angle.x-=360;let t=e.angle.z,n=e.angle.x*Math.PI/180,i=e.angle.y*Math.PI/180,r=200*t,a=e.center,s=new l.AO(r*Math.cos(i)*Math.cos(n),r*Math.cos(i)*Math.sin(n),r*Math.sin(i)).add(a);return{lookAt:o.OO.fromLookAt(s,a,new l.AO(0,0,1)),camPos:s}}function a(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.AO.zero,{camera:i}=e,a=new l.bR;for(let e of t.cubes){let t=new l.AO(e.x,e.y,e.z).add(n),o=new l.AO(e.x+e.dx,e.y+e.dy,e.z+e.dz).add(n);a.addInPlace(t),a.addInPlace(o)}a.size().len();let{lookAt:s,camPos:c}=r(i);i.angle.z;let u=o.OO.fromPersp(40,e.render.size.x/e.render.size.y,100,1e7).mul(s),d=new o.OO;d[0]=1,d[5]=0,d[6]=-1,d[9]=-1,d[10]=0,e.camera.modelMtx=d,e.camera.viewMtx=u,e.camera.camPos=c,e.camera.camPosModel=d.invert().mulVec3Affine(c),e.camera.lookAtMtx=s}function s(e,t){return e.camera.camPosModel.dist(t)/e.render.size.y*5}function c(e,t){let n=e.camera.desiredCameraTransition;if(n){if(n.t<1){n.t=(0,i.uZ)(n.t+t.dt/1e3*1.5,0,1);let o=n.initialPos,l=n.targetPos;e.camera.angle=o.angle.lerp(l.angle,n.t),e.camera.center=o.center.lerp(l.center,n.t),t.markDirty()}else e.camera.desiredCameraTransition=void 0}e.camera.desiredCamera&&(e.camera.desiredCameraTransition={t:0,initialPos:{center:e.camera.center,angle:e.camera.angle},targetPos:e.camera.desiredCamera},e.camera.desiredCamera=void 0,t.markDirty())}},4415:function(e,t,n){"use strict";n.d(t,{CY:function(){return b},Gk:function(){return w},hT:function(){return v}});var o=n(7437),l=n(2265),i=n(2048),r=n.n(i),a=n(7145),s=n(1074),c=n(9107),u=n(1280),d=n(383),f=n(2261),h=n(1279),m=n(2759),p=n(7042),x=n(7004),y=n(6875),g=n(2348);function v(e,t){e.time=0,e.phase=t,e.running=!1,e.markDirty()}function b(e,t){let n=(0,d.zn)(e),o=e.phaseList.indexOf(n),l=n.phases.findIndex(t=>t.id===e.phase)+t;if(l<0){if(o>0){let t=e.phaseList[o-1];e.phase=t.phases[t.phases.length-1].id}}else if(l>=n.phases.length){if(o<e.phaseList.length-1){let t=e.phaseList[o+1];e.phase=t.phases[0].id}}else e.phase=n.phases[l].id;console.log("new phase is ".concat(d.nz[e.phase])),e.time=0,e.running=!1}let w=()=>{var e,t;let n=(0,s.f9)(),[i,g]=l.useState(null),v=n.walkthrough;function w(){v.time>=v.phaseLength?(b(v,1),v.time=0):v.running=!v.running,n.markDirty()}function T(e){b(v,e),n.markDirty()}let O=v.times.length,{nodes:B}=(0,l.useMemo)(()=>{let e=[],t=!1;for(let n of v.times)if((0,f.oj)(n))e.push({commentary:n,isBreak:!1,start:n.start,end:(0,f.Yp)(n)}),t=!1;else{t||e.push({times:[],isBreak:!1,start:n.start,end:n.start});let o=e[e.length-1];o.times.push(n),o.isBreak||(o.isBreak=!!n.isBreak),o.end=(0,f.Yp)(n),t=!0}return{nodes:e}},[v.times]),{prevBreak:z,nextBreak:E}=(0,l.useMemo)(()=>{let e=-1,t=-1,n=-1;for(let o=0;o<B.length+1;o++){let l=B[o];if((null==l?void 0:l.isBreak)||o===B.length){if(o===B.length||l.start>=v.time){t=n-1;break}e=n+1,n=o}}return{prevBreak:e,nextBreak:t}},[v.time,B]),[R,M]=(0,l.useState)({width:0,height:0,parentHeight:0,childRanges:[]});(0,l.useLayoutEffect)(()=>{if(i){let e=new ResizeObserver(function(){var e,t,n;if(!(null==i?void 0:i.children))return;let o=i.getBoundingClientRect(),l=[];for(let r of i.children){let i=parseInt(r.getAttribute("data-nid")),a=B[i];if(!a)continue;let s=null!==(t=null===(e=a.commentary)||void 0===e?void 0:e.start)&&void 0!==t?t:a.times[0].start,c=(0,f.Yp)(null!==(n=a.commentary)&&void 0!==n?n:a.times[a.times.length-1]),u=r.getBoundingClientRect();l.push({top:u.top-o.top,bottom:u.bottom-o.top,nodeId:i,startT:s,endT:c,height:u.height})}M({width:o.width-40,height:o.height,parentHeight:i.parentElement.getBoundingClientRect().height,childRanges:l})});return e.observe(i),e.observe(i.parentElement),()=>{e.disconnect()}}},[B,i,v.phase,O]);let{rangeInfo:P,currPos:F}=(0,l.useMemo)(()=>{let e=0;for(let t of R.childRanges)if(t.startT<=v.time&&t.endT>=v.time){e=t.bottom;break}let t=0,n=0;function o(e){return R.childRanges.find(t=>t.nodeId===e)}if(B.length>0){let e=o(Math.max(0,z));e&&(t=e.top)}if(E>=0){let e=o(E);e&&(n=e.bottom)}return{rangeInfo:{start:t,end:n,width:R.width},currPos:e}},[v.time,R,B,z,E]),C=(0,d.zn)(v),j=null==C?void 0:C.phases.find(e=>e.id===v.phase);(0,l.useEffect)(()=>{i&&(i.parentElement.scrollTop=0)},[i,v.phase]);let D=(0,l.useRef)(-1),I=null!==(t=null===(e=v.commentary)||void 0===e?void 0:e.commentaryList.length)&&void 0!==t&&t;return(0,l.useEffect)(()=>{i&&(D.current!==v.phase?D.current=v.phase:v.time>0&&i.parentElement.scrollTo({top:P.start+512,behavior:"smooth"}))},[P.start,P.end,F,i,I,R.height,R.parentHeight,v.phase,v.time]),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:r().chapterControls,children:[(0,o.jsx)("button",{className:(0,p.Z)(r().btn,r().prevNextBtn),onClick:()=>T(-1),children:(0,o.jsx)(h.G,{icon:m.A35})}),(0,o.jsxs)("div",{className:r().chapterTitle,children:["Chapter: ",j.title]}),(0,o.jsx)("button",{className:(0,p.Z)(r().btn,r().prevNextBtn),onClick:()=>T(1),children:(0,o.jsx)(h.G,{icon:m._tD})})]}),(0,o.jsx)("div",{className:r().walkthroughViewport,children:(0,o.jsxs)("div",{className:r().walkthroughText,tabIndex:0,onKeyDownCapture:function(e){" "===e.key&&e.preventDefault()},children:[(0,o.jsx)("div",{className:r().tocBackground,children:(0,o.jsx)(x.X,{activePhase:j.id})}),(0,o.jsx)("div",{className:r().divider}),(0,o.jsxs)("div",{className:r().walkthroughParas,ref:g,children:[(0,o.jsx)(o.Fragment,{children:B.map((e,t)=>{if(e.commentary){let n=e.commentary,i=0===n.duration?v.time>=n.start?1:0:(0,c.uZ)((v.time-n.start)/n.duration,0,1),r=(0,u.t7)(.6,1,i),a=(0,u.t7)(0,0,i);return(0,o.jsx)("div",{style:{opacity:r,filter:"blur(".concat(a,"px)")},"data-nid":t,children:function(e,t){let n=0,i=0,r=[],a=[];function s(){a.length&&(r.push((0,o.jsx)("p",{children:a},n++)),a=[],i=0)}for(let t=0;t<e.strings.length;t++){let n=e.strings[t];if(n.trim()){let e=n.split("\n\n");for(let t=0;t<e.length;t++){let n=_(e[t]);t>0&&s(),a.push((0,o.jsx)(l.Fragment,{children:n},i++))}}if(t<e.values.length){let n=e.values[t];if((0,l.isValidElement)(n)&&a.push((0,o.jsx)(l.Fragment,{children:n},i++)),n.insertInline&&a.push((0,o.jsx)(l.Fragment,{children:n.insertInline},i++)),n.insert){s();let e="function"==typeof n.insert?n.insert():n.insert,o="string"==typeof e?e:l.createElement(e,{key:"i"+t});r.push(o)}if(n.color){let e=n.color.toHexColor(),t=_(n.str);n.dim?a.push((0,o.jsx)(y.v,{style:{color:e},dim:n.dim,children:t},i++)):n.blk?a.push((0,o.jsx)(y.T,{style:{color:e},blk:n.blk,children:t},i++)):a.push((0,o.jsx)("span",{style:{color:e},children:t},i++))}}}return s(),r}(n,v.time)},t)}{let n=e.times,l=v.time>=n[0].start,i=v.time>=n[0].start&&v.time<=(0,f.Yp)(n[n.length-1]),s=n.length>1||!n[0].isBreak;return(0,o.jsx)("div",{className:r().commentaryBreak,"data-nid":t,style:{opacity:l?1:.6,filter:"blur(".concat(0,"px)")},children:s&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("button",{className:(0,p.Z)(r().jump,"btn"),onClick:function(){i||(v.time=n[0].start,v.markDirty())},children:(0,o.jsx)(h.G,{icon:m.r5q})}),(0,o.jsx)("button",{className:(0,p.Z)(r().playPause,"btn"),onClick:function(){v.running?(v.running=!1,v.markDirty()):(v.running=!0,i||(v.time=n[0].start)),v.markDirty()},children:(0,o.jsx)(h.G,{icon:v.running&&i?m.XQY:m.zc})}),(0,o.jsx)(a.S,{times:e.times})]})},t)}})}),(0,o.jsx)(k,{top:P.start,height:P.end-P.start,width:P.width},E),!v.running&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:r().dividerLine,style:{top:F}}),(0,o.jsx)(A,{top:F,onClick:w})]})]})]})}),(0,o.jsxs)("div",{className:r().controls,children:[(0,o.jsx)("button",{className:(0,p.Z)(r().btn,"flex-[2] bg-blue-300 border border-blue-600 hover:bg-blue-400"),onClick:w,children:(0,o.jsx)("div",{children:"Continue"})}),(0,o.jsx)("button",{className:(0,p.Z)(r().btn,"ml-4 min-w-[100px] bg-white border border-blue-600 hover:bg-blue-200"),onClick:function(){if(v.time>=v.phaseLength)b(v,1),v.time=0;else{v.running=!0;let e=B.find(e=>e.end>v.time),t=15;e&&e.end>v.time&&(t=(e.end-v.time)*2),v.speed=t}n.markDirty()},children:(0,o.jsx)("div",{children:"Skip"})})]})]})};function _(e){let t=[],n="",l=0;for(let o of e)"_"!==o||t.length%2!=1&&n.match(/[a-zA-Z0-9]/)||t.push(l),n=o,l++;let i=[];function r(t,n){for(let l=0;l<Math.ceil(n.length/2);l++){var o;i.push({t:t,start:n[2*l],end:(null!==(o=n[2*l+1])&&void 0!==o?o:e.length)+1})}}r("i",t),r("b",[]);let a={t:"",start:0,end:e.length,children:[]};for(let e of i)!function e(t,n){var o,l;t.start;let i=n.start,r=[];for(let l of null!==(o=t.children)&&void 0!==o?o:[])i<l.start&&(r.push({...n,start:i,end:l.start}),i=l.start),i<l.end&&n.end>l.start&&(e(l,{...n,start:Math.max(i,l.start),end:Math.min(n.end,l.end)}),i=Math.min(n.end,l.end),n.end);i<n.end&&r.push({...n,start:i,end:n.end}),r.length>0&&(t.children=[...null!==(l=t.children)&&void 0!==l?l:[],...r],t.children.sort((e,t)=>e.start-t.start))}(a,e);return function t(n,l){var i;let r=""===n.t?0:1,a=[],s=null!==(i=n.children)&&void 0!==i?i:[],c=n.start+r;for(let o=0;o<s.length+1;o++){let l=o<s.length?s[o].start:n.end-r;l>c&&a.push(e.slice(c,l)),o<s.length&&(a.push(t(s[o],o)),c=s[o].end)}return"b"===n.t?(0,o.jsx)("b",{children:a},l):"i"===n.t?(0,o.jsx)("i",{children:a},l):a}(a,0)}let A=e=>{let{top:t,onClick:n}=e;return(0,o.jsx)("div",{className:"absolute flex justify-center pointer-events-none top-0 left-0 right-0",style:{top:t,transform:"translateY(20px)"},children:(0,o.jsxs)("div",{className:"flex-shrink py-2 px-4 bg-blue-200 shadow-md rounded-3xl pointer-events-auto text-black cursor-pointer",onClick:n,children:["Press ",(0,o.jsx)("span",{className:r().key,children:"Space"})," to continue"]})})},k=e=>{let{top:t,height:n,width:i}=e,[a,s]=(0,l.useState)(0);(0,g.gQ)(a<2,e=>{s(a+e)});let c=i+24,d=n+24,f=d-3,h=(0,u.JF)(3,0,a);return n<=0?null:(0,o.jsx)("div",{className:r().sectionHighlightWrap,style:{top:t-12,height:d,width:c,left:-12},children:(0,o.jsx)("svg",{viewBox:"0 0 ".concat(c," ").concat(d),className:r().sectionHighlight,children:(0,o.jsx)("rect",{x:3,y:3,width:c-3-3,height:f-3,fill:"none",stroke:"blue",strokeWidth:h,opacity:h,rx:5,ry:5})})})}},3014:function(e,t,n){"use strict";n.d(t,{R3:function(){return r},Rp:function(){return h},nb:function(){return p},pu:function(){return m},wD:function(){return f}});var o,l,i,r,a=n(9107),s=n(9073),c=n(9158),u=n(4230),d=n(2261);function f(e){let{x:t,y:n,z:o,dx:l,dy:i,dz:r}=e;return{tl:new c.AO(t,n,o),br:new c.AO(t+l,n+i,o+r)}}function h(e,t){e.x=t.x,e.y=t.y,e.z=t.z}function m(e,t,n,o){let{x:l,rangeOffsets:i}=(0,u.gW)(t,n),r=l+e.cell*o;if(!i)return r;for(let[e,t]of i)if(o<e)return r+t;return r}function p(e){let t,n,o,l,u,f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;arguments.length>2&&void 0!==arguments[2]?arguments[2]:new c.AO(0,0,0);let{B:h,T:m,C:p,vocabSize:x,nHeads:y,A:g,nBlocks:v}=e,b=e.nBlocks>12,w=0,_=Math.max(12,p/10);function A(e){var t,n,o,l,c,u,d,f;let h;let m=[e.xL,e.xR,e.xM].map(e=>+!(0,a.kK)(e)).reduce((e,t)=>e+t,0),p=[e.zF,e.zB,e.zM].map(e=>+!(0,a.kK)(e)).reduce((e,t)=>e+t,0);if(1!==m||1!==p)throw Error("Must supply exactly 1 x arg & 1 y arg: ".concat(JSON.stringify(e)));let x=1.5*e.cx,y=1.5*e.cz,g=(0,a.kK)(e.xL)?(0,a.kK)(e.xR)?e.xM-x/2:e.xR-x:e.xL,v=(0,a.kK)(e.zB)?(0,a.kK)(e.zF)?e.zM-y/2:e.zF-y:e.zB;function b(e){return 4===e.length?e:[...e,0]}return{dx:1.5*e.cx,dy:1.5*e.cy,dz:1.5*e.cz,t:e.t,x:g,y:e.y,z:v,cx:e.cx,cy:e.cy,cz:e.cz,dimX:e.dimX,dimY:e.dimY,name:null!==(n=e.name)&&void 0!==n?n:"<unknown>",access:(null===(t=e.access)||void 0===t?void 0:t.src)?{channel:null!==(o=e.access.channel)&&void 0!==o?o:"r",src:e.access.src,scale:null!==(l=e.access.scale)&&void 0!==l?l:1,mat:s.OO.fromColMajor([...b(e.access.x),...b(e.access.y),0,0,0,0,0,0,0,0])}:void 0,deps:e.deps?(d=e.deps,h=(e,t)=>({src:e,srcIdxMtx:function(e){let t=s.OO.zeros();for(let n=0;n<e.length;n++){let o="0xybi".indexOf(e[n]);o>0&&t.s(n,o-1,1)}return t}(t)}),{dot:d.dot&&d.dot.map(e=>{let[t,n]=e;return h(t,n)}),dotLen:d.dotLen,add:d.add&&d.add.map(e=>{let[t,n]=e;return h(t,n)}),special:null!==(f=d.special)&&void 0!==f?f:r.None,lowerTri:d.lowerTri}):void 0,opacity:e.hidden?0:1,highlight:0,small:null!==(c=e.small)&&void 0!==c&&c,special:null!==(u=e.special)&&void 0!==u?u:i.None,transpose:e.transpose,idx:-1}}function k(e,t){return{visible:0,cubes:null!=t?t:[]}}let T=[],O=A({t:"i",cx:m,cz:h,cy:1,y:0,xM:0,zM:0,access:{src:null==f?void 0:f.inputTokens,x:[0,1,0],y:[1,0,m],scale:1/x},dimX:d.Zy.T,dimY:d.Zy.None,name:"Tokens"}),B=-(1.5*m)/2-_,z=1.5*m/2+_,E=A({t:"w",xR:B,zM:0,y:w+=1.5+_,cx:x,cz:1,cy:p,access:{src:null==f?void 0:f.vocabEmbed.weight,x:[0,1,0],y:[1,0,0],scale:10},dimX:d.Zy.n_vocab,dimY:d.Zy.C,name:"Token Embed"}),R=A({t:"w",xL:z,zM:0,y:w,cx:m,cz:1,cy:p,access:{src:null==f?void 0:f.posEmbed.weight,x:[0,1,0],y:[1,0,0],scale:10},dimX:d.Zy.T,dimY:d.Zy.C,name:"Position Embed"}),M=A({t:"i",xM:0,zM:0,y:w,cx:m,cz:h,cy:p,access:{src:null==f?void 0:f.add.output,x:[0,1,0],y:[1,0,m],scale:10},deps:{add:[[E,"iy"],[R,"xy"],[O,"x0"]],special:r.InputEmbed},dimX:d.Zy.T,dimY:d.Zy.C,name:"Input Embed"});T.push(O,E,R,M);let P=k(w,[O,E,R,M]);function F(e,t,n){let o=B+e,l=o-1.5*m-_,i=A({t:"a",cx:m,cz:h,cy:1,y:w,xR:o,zM:0,access:{src:null==n?void 0:n.normAgg,x:[0,1,0],y:[1,0,m],scale:10,channel:"r"},deps:{add:[[t,"xi"]],special:r.LayerNormMu},dimX:d.Zy.T,dimY:d.Zy.None,small:!0,name:"LN Agg: μ, σ"}),a=A({t:"a",cx:m,cz:h,cy:1,y:w+1.5,xR:o,zM:0,access:{src:null==n?void 0:n.normAgg,x:[0,1,0],y:[1,0,m],scale:10,channel:"g"},deps:{add:[[t,"xi"]],special:r.LayerNormSigma},dimX:d.Zy.T,dimY:d.Zy.None,small:!0,name:""}),s=A({t:"w",cx:1,cz:1,cy:p,y:w+=3+_,xR:l,zM:0,access:{src:null==n?void 0:n.normWeight,x:[1,0,0],y:[0,1,0],scale:.5},dimX:d.Zy.None,dimY:d.Zy.C,name:"γ",small:!0}),c=A({t:"w",cx:1,cz:1,cy:p,y:w,xR:l-1.5-_,zM:0,access:{src:null==n?void 0:n.normBias,x:[1,0,0],y:[0,1,0]},dimX:d.Zy.None,dimY:d.Zy.C,name:"β",small:!0}),u=A({t:"i",cx:m,cz:h,cy:p,y:w,xR:o,zM:0,access:{src:null==n?void 0:n.output,x:[0,1,0],y:[1,0,m],scale:1},deps:{add:[[t,"xy"],[i,"xi"],[a,"xi"],[s,"0y"],[c,"0y"]],special:r.LayerNorm},dimX:d.Zy.T,dimY:d.Zy.C,name:"Layer Norm"});return{lnAgg1:i,lnAgg2:a,lnResid:u,lnSigma:s,lnMu:c,cubes:[i,a,s,c,u]}}w+=1.5*p+_;let C=B-(m+2)*1.5-3*_,j=2*_;w+=j,e.nBlocks>12&&e.nBlocks;let D=14*p*1.5+2*_,I=0,L=w,U=[],S=M;for(let e=0;e<v;e++){I>=12&&(I=0,w=L,C+=D,B+=D,z+=D);let t=null==f?void 0:f.blocks[e];w+=j;let n=function(e,t){let n=F(0,e,null==t?void 0:t.ln_1),o=3*_+1.5*p/16,l=1*_+1.5*p/16,a=3*h*1.5+2*l+(b?0:o),s=w+1.5*g+_+(b?2*g*1.5:0),c=s+1.5*m+_,u=C,f=u-1.5*m-_,x=f-1.5*p-_,v=null==t?void 0:t.attn,O=[];for(let e=0;e<y;e++){let t=a*e-(y-1)*a/2,o=t+1.5*h+l,T=t-1.5*h-l,B=A({t:"w",cx:p,cz:1,cy:g,y:w,xR:f,zM:o,access:{src:null==v?void 0:v.qkvWeight,x:[1,0,0],y:[0,1,0,0*p+g*e],scale:.25*p},dimX:d.Zy.C,dimY:d.Zy.A,name:"Q Weights"}),z=A({t:"w",cx:p,cz:1,cy:g,y:w,xR:f,zM:t,access:{src:null==v?void 0:v.qkvWeight,x:[1,0,0],y:[0,1,0,1*p+g*e],scale:.25*p},dimX:d.Zy.C,dimY:d.Zy.A,name:"K Weights"}),E=A({t:"w",cx:p,cz:1,cy:g,y:w,xR:f,zM:T,access:{src:null==v?void 0:v.qkvWeight,x:[1,0,0],y:[0,1,0,2*p+g*e],scale:.25*p},dimX:d.Zy.C,dimY:d.Zy.A,name:"V Weights"}),R=A({t:"w",cx:p,cz:1,cy:3*g,y:w,xR:f,zM:t,dimX:d.Zy.C,dimY:d.Zy.C,name:"QKV Weights"}),M=A({t:"w",cx:1,cz:1,cy:g,y:w,xR:x,zM:o,access:{src:null==v?void 0:v.qkvBias,x:[1,0,0],y:[0,1,0,0*p+g*e]},dimX:d.Zy.None,dimY:d.Zy.A,small:!0,name:"Q Bias"}),P=A({t:"w",cx:1,cz:1,cy:g,y:w,xR:x,zM:t,access:{src:null==v?void 0:v.qkvBias,x:[1,0,0],y:[0,1,0,1*p+g*e]},dimX:d.Zy.None,dimY:d.Zy.A,small:!0,name:"K Bias"}),F=A({t:"w",cx:1,cz:1,cy:g,y:w,xR:x,zM:T,access:{src:null==v?void 0:v.qkvBias,x:[1,0,0],y:[0,1,0,2*p+g*e]},dimX:d.Zy.None,dimY:d.Zy.A,small:!0,name:"V Bias"}),C=A({t:"i",cx:m,cz:h,cy:g,y:w,xR:u,zM:o,access:{src:null==v?void 0:v.qkvOutput,x:[0,1,0,0*p+g*e],y:[1,0,m],scale:1},deps:{dot:[[B,"iy"],[n.lnResid,"xi"]],add:[[M,"0y"]],dotLen:p},dimX:d.Zy.T,dimY:d.Zy.A,name:"Q vectors"}),j=A({t:"i",cx:m,cz:h,cy:g,y:w,xR:u,zM:t,access:{src:null==v?void 0:v.qkvOutput,x:[0,1,0,1*p+g*e],y:[1,0,m],scale:1},deps:{dot:[[z,"iy"],[n.lnResid,"xi"]],add:[[P,"0y"]],dotLen:p},dimX:d.Zy.T,dimY:d.Zy.A,name:"K vectors"}),D=A({t:"i",cx:m,cz:h,cy:g,y:w,xR:u,zM:T,access:{src:null==v?void 0:v.qkvOutput,x:[0,1,0,2*p+g*e],y:[1,0,m],scale:1},deps:{dot:[[E,"iy"],[n.lnResid,"xi"]],add:[[F,"0y"]],dotLen:p},dimX:d.Zy.T,dimY:d.Zy.A,name:"V vectors"}),I=A({t:"i",cx:m,cz:h,cy:3*g,y:w,xR:u,zM:t,dimX:d.Zy.T,dimY:d.Zy.C,name:"QKV vectors"}),L=u-(m+2)*1.5-2*_,U=A({t:"i",cx:m,cz:h,cy:m,y:s,xR:u,zM:t,access:{src:null==v?void 0:v.attnMatrix,x:[1,0,0],y:[0,1,y*m,m*e],scale:1},deps:{dot:[[C,"yi"],[j,"xi"]],lowerTri:!0,dotLen:g,special:r.Attention},dimX:d.Zy.T,dimY:d.Zy.T,special:i.Attention,transpose:!0,name:"Attention Matrix"}),S=A({t:"a",cx:1,cz:h,cy:m,y:s,xR:u-1.5*m-_-1.5,zM:t,access:{src:null==v?void 0:v.attnMatrixSoftmax,x:[0,0,0,1],y:[0,1,y*m,m*e],channel:"r"},deps:{add:[[U,"iy"]],special:r.SoftmaxAggExp},dimX:d.Zy.None,dimY:d.Zy.T,small:!0,name:""}),N=A({t:"a",cx:1,cz:h,cy:m,y:s,xR:u-1.5*m-_,zM:t,access:{src:null==v?void 0:v.attnMatrixSoftmax,x:[0,0,0,1],y:[0,1,y*m,m*e],channel:"g"},deps:{add:[[U,"iy"]],special:r.SoftmaxAggMax},dimX:d.Zy.None,dimY:d.Zy.T,small:!0,name:""}),X=A({t:"i",cx:m,cz:h,cy:m,y:s,xR:L,zM:t,access:{src:null==v?void 0:v.attnMatrixSoftmax,x:[1,0,0],y:[0,1,y*m,m*e],scale:2},deps:{add:[[U,"xy"],[S,"iy"],[N,"iy"]],lowerTri:!0,special:r.Softmax},dimX:d.Zy.T,dimY:d.Zy.T,special:i.Attention,transpose:!0,name:"Attn Matrix Softmax"}),W=A({t:"i",cx:m,cz:h,cy:g,y:c+0*e,xR:u,zM:t,access:{src:null==v?void 0:v.scaledVectors,x:[0,1,0,e*g],y:[1,0,m]},deps:{dot:[[D,"iy"],[X,"ix"]],dotLen:g},dimX:d.Zy.T,dimY:d.Zy.A,name:"V Output"}),Z=[...b?[R,I]:[B,z,E,C,j,D],M,P,F,U,S,N,X,W],Y=k(1,Z),V=k(1,[B,M,C]),G=k(1,[z,P,j]),H=k(1,[E,F,D]),J=k(1,[M,P,F]),q=k(1,[U,S,N,X]),Q=k(1,[W]),K={qWeightBlock:B,kWeightBlock:z,vWeightBlock:E,qBiasBlock:M,kBiasBlock:P,vBiasBlock:F,qBlock:C,kBlock:j,vBlock:D,attnMtx:U,attnMtxAgg1:S,attnMtxAgg2:N,attnMtxSm:X,vOutBlock:W,qLabel:V,kLabel:G,vLabel:H,biasLabel:J,mtxLabel:q,vectorLabel:Q,headLabel:Y,cubes:Z,labels:[V,G,H,J,q,Q,Y]};O.push(K)}let B=A({t:"i",cx:m,cz:h,cy:p,y:c,xR:u,zF:-a*y/2,dimX:d.Zy.T,dimY:d.Zy.C,hidden:!0,name:"V Output Combined"}),z=Math.max(c+0*(y-1)+1.5*g+2*_,w+1.5*p+_),E=A({t:"w",cx:p,cz:1,cy:p,y:z,xR:f,zM:0,access:{src:null==v?void 0:v.proj.weight,x:[1,0,0],y:[0,1,0],scale:.5*p},dimX:d.Zy.C,dimY:d.Zy.C,name:"Projection Weights"}),R=A({t:"w",cx:1,cz:1,cy:p,y:z,xR:f-1.5*p-_,zM:0,access:{src:null==v?void 0:v.proj.bias,x:[0,0,0],y:[0,1,0],scale:.5*p},dimX:d.Zy.None,dimY:d.Zy.C,small:!0,name:"Projection Bias"}),M=A({t:"i",cx:m,cz:h,cy:p,y:z,xR:u,zM:0,access:{src:null==v?void 0:v.proj.output,x:[0,1,0],y:[1,0,m]},deps:{dot:[[E,"iy"],[B,"xi"]],dotLen:p,add:[[R,"0y"],...O.map(e=>[e.vOutBlock,"xi"])]},dimX:d.Zy.T,dimY:d.Zy.C,name:"Attention Output"}),P=A({t:"i",cx:m,cz:h,cy:p,y:z,xM:0,zM:0,access:{src:null==v?void 0:v.output,x:[0,1,0],y:[1,0,m]},deps:{add:[[M,"xy"],[e,"xy"]]},dimX:d.Zy.T,dimY:d.Zy.C,name:"Attention Residual"});w=z+1.5*p+_;let j=F(0,P,null==t?void 0:t.ln_2),D=A({t:"w",cx:4*p,cz:1,cy:p,y:w,xR:u,zM:0,access:{src:null==t?void 0:t.mlp.fcLayer.weight,x:[0,1,0],y:[1,0,0],scale:.5*p},dimX:d.Zy.C4,dimY:d.Zy.C,name:"MLP Weights"}),I=A({t:"w",cx:4*p,cz:1,cy:1,y:w-1.5-_,xR:u,zM:0,access:{src:null==t?void 0:t.mlp.fcLayer.bias,x:[0,1,0],y:[1,0,0],scale:.5*p},dimX:d.Zy.C4,dimY:d.Zy.None,name:"MLP Bias",small:!0});w+=1.5*p+_;let L=A({t:"i",cx:4*p,cz:h,cy:m,y:w,xR:u,zM:0,access:{src:null==t?void 0:t.mlp.fcLayer.output,x:[1,0,0],y:[0,1,m],scale:1},deps:{dot:[[D,"xi"],[j.lnResid,"yi"]],dotLen:p,add:[[I,"x"]]},dimX:d.Zy.C4,dimY:d.Zy.T,name:"MLP",transpose:!0});w+=1.5*m+_;let U=A({t:"i",cx:4*p,cz:h,cy:m,y:w,xR:u,zM:0,access:{src:null==t?void 0:t.mlp.mlpGelu,x:[1,0,0],y:[0,1,m],scale:1},deps:{add:[[L,"xy"]],special:r.Gelu},dimX:d.Zy.C4,dimY:d.Zy.T,name:"MLP Activation",transpose:!0}),S=A({t:"w",cx:4*p,cz:1,cy:p,y:w+=1.5*m+_,xR:u,zM:0,access:{src:null==t?void 0:t.mlp.projLayer.weight,x:[1,0,0],y:[0,1,0],scale:.5*p},dimX:d.Zy.C4,dimY:d.Zy.C,name:"MLP Projection Weights"}),N=A({t:"w",cx:1,cz:1,cy:p,y:w,xR:u-4*p*1.5-_,zM:0,access:{src:null==t?void 0:t.mlp.projLayer.bias,x:[1,0,0],y:[0,1,0],scale:.5*p},dimX:d.Zy.None,dimY:d.Zy.C,small:!0,name:"MLP Projection Bias"}),X=A({t:"i",cx:m,cz:h,cy:p,y:w,xL:u+_,zM:0,access:{src:null==t?void 0:t.mlp.projLayer.output,x:[0,1,0],y:[1,0,m]},deps:{dot:[[S,"iy"],[U,"ix"]],dotLen:p,add:[[N,"0y"]]},dimX:d.Zy.T,dimY:d.Zy.C,name:"MLP Result"}),W=A({t:"i",cx:m,cz:h,cy:p,y:w,xM:0,zM:0,access:{src:null==t?void 0:t.mlp.output,x:[0,1,0],y:[1,0,m]},deps:{add:[[X,"xy"],[P,"xy"]]},dimX:d.Zy.T,dimY:d.Zy.C,name:"MLP Residual"});w+=1.5*p-_;let Z=[...n.cubes,...O.flatMap(e=>e.cubes),E,R,M,P,...j.cubes,D,I,L,U,S,N,X,W],Y=[...n.cubes,...O.flatMap(e=>e.cubes)],V=[E,R,M,P],G=k(1,Z),H=k(1,[...Y,...V]),J=k(1,V),q=k(1,[...j.cubes,D,I,L,U,S,N,X,W]);return T.push(...Z),{ln1:n,heads:O,labels:[G,J,H,q,...O.flatMap(e=>e.labels)],cubes:Z,transformerLabel:G,projLabel:J,selfAttendLabel:H,mlpLabel:q,projWeight:E,projBias:R,attnOut:M,attnResidual:P,mlpFc:L,mlpFcWeight:D,mlpFcBias:I,mlpAct:U,mlpProjWeight:S,mlpProjBias:N,mlpResult:X,mlpResidual:W,ln2:j}}(S,t);U.push(n),S=n.mlpResidual,w+=j,I++}w+=j;let N=F(0,S,null==f?void 0:f.ln_f);T.push(...N.cubes),w+=1.5*p+_,t=A({t:"w",cx:p,cy:x,cz:1,y:w,xR:B-1.5*m-_,zM:0,access:{src:null==f?void 0:f.lm_head.weight,x:[1,0,0],y:[0,1,0],scale:5},dimX:d.Zy.C,dimY:d.Zy.n_vocab,name:"LM Head Weights"}),n=A({t:"i",cx:m,cy:x,cz:h,y:w,xR:B,zM:0,access:{src:null==f?void 0:f.lm_head.output,x:[0,1,0],y:[1,0,m]},deps:{dot:[[t,"iy"],[N.lnResid,"xi"]],dotLen:p},dimX:d.Zy.T,dimY:d.Zy.n_vocab,name:"Logits"}),w+=1.5*x+_,l=A({t:"a",cx:m,cy:1,cz:h,y:w,xR:B,zM:0,access:{src:null==f?void 0:f.softmaxFinal.agg,x:[0,1,0],y:[1,0,m],channel:"g"},deps:{add:[[n,"xi"]],special:r.SoftmaxAggMax},dimX:d.Zy.T,dimY:d.Zy.None,name:"SM Agg"}),o=A({t:"a",cx:m,cy:1,cz:h,y:w+1.5,xR:B,zM:0,access:{src:null==f?void 0:f.softmaxFinal.agg,x:[0,1,0],y:[1,0,m],channel:"r"},deps:{add:[[n,"xi"],[l,"x0"]],special:r.SoftmaxAggExp},dimX:d.Zy.T,dimY:d.Zy.None,name:""}),w+=3+_,u=A({t:"i",cx:m,cy:x,cz:h,y:w,xR:B,zM:0,access:{src:null==f?void 0:f.softmaxFinal.output,x:[0,1,0],y:[1,0,m]},deps:{add:[[n,"xy"],[o,"xi"],[l,"xi"]],special:r.Softmax},dimX:d.Zy.T,dimY:d.Zy.n_vocab,name:"Logits Softmax"});let X=x*p+m*p+v*(2*p+4*p*p+p+3*p+(2*p+4*p+8*p*p+p))+2*p;T.push(t,n,o,l,u);for(let e=0;e<T.length;e++)T[e].idx=e;return{cubes:T,cell:1.5,margin:_,idxObj:O,tokEmbedObj:E,posEmbedObj:R,residual0:M,ln_f:N,lmHeadWeight:t,logits:n,logitsAgg1:o,logitsAgg2:l,logitsSoftmax:u,embedLabel:P,blocks:U,height:w,logitsTransposed:!1,model:f,labels:[P,...U.flatMap(e=>e.labels)],weightCount:X,shape:e,extraSources:{idx:null==f?void 0:f.inputBuf,tokEmbedOut:null==f?void 0:f.vocabEmbed.output,posEmbedOut:null==f?void 0:f.posEmbed.output}}}(o=i||(i={}))[o.None=0]="None",o[o.Attention=1]="Attention",(l=r||(r={}))[l.None=0]="None",l[l.Softmax=1]="Softmax",l[l.Gelu=2]="Gelu",l[l.LayerNorm=3]="LayerNorm",l[l.InputEmbed=4]="InputEmbed",l[l.LayerNormMu=5]="LayerNormMu",l[l.LayerNormSigma=6]="LayerNormSigma",l[l.SoftmaxAggMax=7]="SoftmaxAggMax",l[l.SoftmaxAggExp=8]="SoftmaxAggExp",l[l.Attention=9]="Attention"},7917:function(e,t,n){"use strict";n.d(t,{Tl:function(){return f},Ui:function(){return d},XZ:function(){return u},nV:function(){return s}});var o=n(4230),l=n(4485),i=n(3014),r=n(9107),a=n(9158);function s(e){let t=e.mouse,n=e.render.size,i=t.mousePos.x/n.x*2-1,s=1-t.mousePos.y/n.y*2,u=e.camera.viewMtx.invert(),d=e.camera.modelMtx.invert();function h(e){let t=u.mulVec4(e);return d.mulVec4(t).projToVec3()}let m=new a.T8(i,s,-1,1),p=new a.T8(i,s,1,1),x=h(m),y=h(p).sub(x).normalize(),g=[];for(let t of e.layout.cubes)!function e(t,n){if(t.subs)for(let o of t.subs)e(o,n||t);else t.opacity>0&&g.push([t,n])}(t,t);let v=0,b=null;for(let[e,t]of g){let n=function(e,t,n,o){let l=(e.x-n.x)/o.x,i=(t.x-n.x)/o.x,r=Math.min(l,i),a=Math.max(l,i),s=(e.y-n.y)/o.y,c=(t.y-n.y)/o.y;r=Math.max(r,Math.min(s,c)),a=Math.min(a,Math.max(s,c));let u=(e.z-n.z)/o.z,d=(t.z-n.z)/o.z;return r=Math.max(r,Math.min(u,d)),(a=Math.min(a,Math.max(u,d)))>=r?r:-1}(new a.AO(e.x,e.y,e.z),new a.AO(e.x+e.dx,e.y+e.dy,e.z+e.dz),x,y);n>0&&(!b||n<v)&&(v=n,b=[e,t])}if(b){let[t,n]=b,i=new a.AO(t.x,t.y,t.z),s=x.add(y.mul(v)),u=new a.AO((0,r.uZ)((s.x-i.x)/t.dx,0,1-.1/t.cx),(0,r.uZ)((s.y-i.y)/t.dy,0,1-.1/t.cy),(0,r.uZ)((s.z-i.z)/t.dz,0,1-.1/t.cz)),d=t.localMtx?t.localMtx.mulVec3Proj(u):u,h=new a.AO(Math.floor(d.x*t.cx),Math.floor(d.y*t.cy),Math.floor(d.z*t.cz));for(let o of(e.display.hoverTarget={mainCube:n,subCube:t,mainIdx:h},e.layout.labels))for(let e of o.cubes)e===n&&(o.visible=1);(0,o.jy)(e,e.layout,n,a.JU.X,n.dimX,1),(0,o.jy)(e,e.layout,n,a.JU.Y,n.dimY,1),function(e,t,n,l){if(c(t,e=>{e.highlight=.1}),n===t){let i=new a.AO(l.x*n.cx*n.dx/t.dx,l.y*n.cy*n.dy/t.dy,l.z*n.cz*n.dz/t.dz),r=(0,o.n2)(e.layout,n,a.JU.X,i.x,0);if(r){r.highlight=.15;let t=(0,o.n2)(e.layout,r,a.JU.Y,i.y,0);if(t){let n=(0,o.n2)(e.layout,t,a.JU.Z,i.z,0);n&&(n.highlight=.6)}}}}(e,n,t,u),f(e,n,h),(0,l.iW)(e,n,h)}else if((0,r.DX)(e.display.blkIdxHover))for(let t of e.display.blkIdxHover)c(e.layout.cubes[t],e=>{e.highlight=.2});if((0,r.DX)(e.display.dimHover)){let t=e.walkthrough.dimHighlightBlocks;for(let n of null!=t?t:[])n.dimX===e.display.dimHover&&(0,o.jy)(e,e.layout,n,a.JU.X,n.dimX,1),n.dimY===e.display.dimHover&&(0,o.jy)(e,e.layout,n,a.JU.Y,n.dimY,1)}}function c(e,t){if(e.subs)for(let n of e.subs)c(n,t);else t(e)}function u(e,t){let n=e.srcIdxMtx,o=0!==n.g(0,3),l=0!==n.g(1,3),i=n.mulVec4(a.T8.fromVec3(t,0)),r=new a.AO(i.x,i.y,i.z),s=o?a.JU.Y:a.JU.X;return{srcIdx:r,dotDim:s,otherDim:s===a.JU.X?a.JU.Y:a.JU.X,isDot:o||l}}function d(e,t){var n;if(!(null===(n=e.deps)||void 0===n?void 0:n.dot))return null;let o=null,l=e.deps.dot.find(e=>{var t;return null===(t=e.src.deps)||void 0===t?void 0:t.lowerTri});if(l){let{srcIdx:e,dotDim:n}=u(l,t);o=e.getAt(n)}return o}function f(e,t,n){let s=e.layout,c=t.deps;if(c){if(c.dot){let e=d(t,n);for(let t of c.dot)f(t,n,e)}if(c.add)for(let e of c.add)f(e,n)}function f(n,c,d){var f,h;let{srcIdx:m,dotDim:p,otherDim:x,isDot:y}=u(n,c);if((null===(f=t.deps)||void 0===f?void 0:f.special)===i.R3.InputEmbed&&n.src===e.layout.tokEmbedObj){let t=(0,l._n)(e.layout.idxObj,new a.AO(c.x,0,c.z));y=!1,m.setAt(a.JU.X,null!=t?t:0)}if(y){(null===(h=n.src.deps)||void 0===h?void 0:h.lowerTri)&&(d=null!=d?d:m.getAt(p));let e=(0,o.lm)(s,n.src,p,m.getAt(p));if(e&&(0,r.DX)(d))for(let t of((0,o.n2)(s,e,x,d,0),(0,o.L3)(e,x,null,d)))t.highlight=.5;else e&&(e.highlight=.5)}else{let e=(0,o.lm)(s,n.src,a.JU.X,m.x);if(!e||!(e=(0,o.lm)(s,e,a.JU.Y,m.y)))return;(e=(0,o.lm)(s,e,a.JU.Z,m.z))&&(e.highlight=.5)}}}},5653:function(e,t,n){"use strict";n.r(t),n.d(t,{LayerView:function(){return eD}});var o,l,i,r,a,s,c,u,d,f,h,m,p,x,y=n(7437),g=n(2265);function v(e){return null!=e}function b(e,t,n,o,l){if(l&&l.length!==o.length)throw Error("Number of texture names (".concat(l.length,") does not match number of src textures (").concat(o.length,")"));let i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);for(let t=0;t<n.length;t++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,n[t].texture,0);e.drawBuffers(n.map((t,n)=>e.COLOR_ATTACHMENT0+n));let r=e.checkFramebufferStatus(e.FRAMEBUFFER);return r!==e.FRAMEBUFFER_COMPLETE&&console.log("createRenderPhase: framebuffer not complete: "+r),{destBuffers:n,srcBuffers:o,fbo:i,program:t,uniformNames:l,uniformsSet:!1}}function w(e,t,n,o){let l=e.createTexture();e.bindTexture(e.TEXTURE_2D,l);let[i,r]=A(e,o);return e.texImage2D(e.TEXTURE_2D,0,r,t,n,0,i,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),{width:t,height:n,texture:l,channels:o}}function _(e,t,n){if(n.length!==t.width*t.height*t.channels)throw Error("Data length does not match buffer size");e.bindTexture(e.TEXTURE_2D,t.texture);let[o]=A(e,t.channels);e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.width,t.height,o,e.FLOAT,n)}function A(e,t){switch(t){case 1:return[e.RED,e.R32F];case 2:return[e.RG,e.RG32F];case 3:return[e.RGB,e.RGB32F];case 4:return[e.RGBA,e.RGBA32F];default:throw Error("Invalid number of channels: ".concat(t,". Must be 1, 2, 3, or 4."))}}(o=u||(u={}))[o.RED=6403]="RED",o[o.RG=33319]="RG",o[o.RGB=6407]="RGB",o[o.RGBA=6408]="RGBA",(l=d||(d={}))[l.R32F=33326]="R32F",l[l.RG32F=33328]="RG32F",l[l.RGB32F=34837]="RGB32F",l[l.RGBA32F=34836]="RGBA32F",(i=f||(f={}))[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.FLOAT=5126]="FLOAT";var k=n(6843);let T="#version 300 es\nprecision highp float;\nlayout(location = 0) in vec2 a_position;\nvoid main() {\n    gl_Position = vec4(a_position, 0, 1);\n}\n";function O(e,t,n){let{gl:o,model:l,shape:{B:i,T:r,C:a},shaderManager:s}=e,c=l[t+".weight"],u=l[t+".bias"],d=w(o,1,a,1),f=w(o,1,a,1),h=w(o,1,i*r,2),m=w(o,a,i*r,1);_(o,d,c.toFloat32Array()),_(o,f,u.toFloat32Array());let p=(0,k.tQ)(s,"normAgg",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D normInput; // (B, T) (C)\n        out vec2 normAgg;            // (B, T) (1) [2]\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            // Use Welford's algorithm to compute mean and variance\n            float mean = 0.0;\n            float M2 = 0.0;\n            for (int i = 0; i < ".concat(a,"; i++) {\n                float x = texelFetch(normInput, ivec2(i, pos.y), 0).r;\n                float delta = x - mean;\n                mean += delta / float(i + 1);\n                M2 += delta * (x - mean);\n            }\n\n            normAgg = vec2(mean, 1.0 / sqrt(M2 / float(").concat(a,") + ").concat(1e-5,"));\n        }\n    ")),x=(0,k.tQ)(s,"normApply",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D normInput;  // (B, T) (C)\n        uniform sampler2D normAgg;    // (B, T) (1) [2]\n        uniform sampler2D normWeight; // (C)    (1)\n        uniform sampler2D normBias;   // (C)    (1)\n        out float normOutput;         // (B, T) (C)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            vec2 agg = texelFetch(normAgg, ivec2(0, pos.y), 0).rg;\n            float mean = agg.r;\n            float stdInv = agg.g;\n\n            float x = texelFetch(normInput, pos, 0).r;\n\n            float weight = texelFetch(normWeight, ivec2(0, pos.x), 0).r;\n            float bias   = texelFetch(normBias,   ivec2(0, pos.x), 0).r;\n\n            normOutput = (x - mean) * stdInv * weight + bias;\n        }\n    ");return{normAgg:h,normWeight:d,normBias:f,aggPhase:b(o,p,[h],[n],["normInput"]),applyPhase:b(o,x,[m],[n,h,d,f],["normInput","normAgg","normWeight","normBias"]),output:m}}function B(e,t,n,o,l,i,r){let{gl:a,model:s,shape:{B:c,T:u},shaderManager:d}=e;r=null==r||r;let f=s[t+".weight"],h=r?s[t+".bias"]:null,m=w(a,n,o,1),p=r?w(a,1,o,1):null,x=w(a,o,c*u,1);_(a,m,f.buffer),h&&p&&_(a,p,h.buffer);let y=b(a,(0,k.tQ)(d,"linear",T,"#version 300 es\n        precision highp float;          //    y     x\n        uniform sampler2D linearInput;  // (B, T) (nIn)\n        uniform sampler2D linearWeight; // (nOut) (nIn)\n        ".concat(r?"uniform sampler2D linearBias;":"","   // (nOut) (1)\n        ").concat(i?"uniform sampler2D linearResidual;":"","\n        out float linearOutput;         // (B, T) (nOut)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            float res = ").concat(r?"texelFetch(linearBias, ivec2(0, pos.x), 0).r":"0.0",";\n            for (int i = 0; i < ").concat(n,"; i++) {\n                float x = texelFetch(linearInput, ivec2(i, pos.y), 0).r;\n                float w = texelFetch(linearWeight, ivec2(i, pos.x), 0).r;\n                res += x * w;\n            }\n\n            ").concat(i?"res += texelFetch(linearResidual, pos, 0).r;":"","\n            linearOutput = res;\n        }\n    ")),[x],[l,m,p,i].filter(v),["linearInput","linearWeight",r?"linearBias":null,i?"linearResidual":null].filter(v));return{weight:m,bias:p,linearPhase:y,output:x}}function z(e,t,n,o,l){let{gl:i,model:r,shape:{B:a,T:s},shaderManager:c}=e,u=r[t+".weight"],d=w(i,o,n,1),f=w(i,o,a*s,1);return _(i,d,u.buffer),{weight:d,phase:b(i,(0,k.tQ)(c,"embed",T,"#version 300 es\n        precision highp float;          //    y     x\n        uniform sampler2D embedInput;  // (B, T)   (1)\n        uniform sampler2D embedWeight; // (nEmbed) (nDims)\n        out float embedOutput;         // (B, T)   (nDims)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            int y = int(texelFetch(embedInput, ivec2(0, pos.y), 0).r);\n            float res = texelFetch(embedWeight, ivec2(pos.x, y), 0).r;\n\n            embedOutput = res;\n        }\n    "),[f],[l,d],["embedInput","embedWeight"]),output:f}}function E(e,t,n){let{gl:o,shape:{B:l,T:i,C:r},shaderManager:a}=e,s=w(o,r,l*i,1);return{addPhase:b(o,(0,k.tQ)(a,"add",T,"#version 300 es\n        precision highp float;     //    y    x\n        uniform sampler2D inputA;  // (B, T) (C)\n        uniform sampler2D inputB;  // (B, T) (C)\n        out float addOutput;       // (B, T) (C)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            float a = texelFetch(inputA, pos, 0).r;\n            float b = texelFetch(inputB, pos, 0).r;\n            addOutput = a + b;\n        }\n    "),[s],[t,n],["inputA","inputB"]),output:s}}var R=n(8248),M=n.n(R),P=n(7898),F=n(5666),C=n(9107);class j{view(e){let t=e.reduce((e,t)=>e*t,1),n=this.shape.reduce((e,t)=>e*t,1);if(t!==n)throw Error("Invalid reshape: new size ".concat(t," (").concat(e.join(", "),") does not match existing size ").concat(n," (").concat(this.shape.join(", "),")"));if(!this.isContiguous)throw Error("Cannot view non-contiguous tensor (or at least, there are potential cases where it would work, but we don't support them yet)");return new j(e,this.buffer)}transpose(e,t){if(e<0||e>=this.shape.length||t<0||t>=this.shape.length||e===t)throw Error("Invalid transpose indices: ".concat(e,", ").concat(t," over shape ").concat(this.shape.join(", ")));let n=[...this.shape],o=[...this.stride],l=n[e];n[e]=n[t],n[t]=l;let i=o[e];return o[e]=o[t],o[t]=i,new j(n,this.buffer,o)}permute(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let o=new Set(Array(this.shape.length).fill(0).map((e,t)=>t));if(t.forEach(e=>o.delete(e)),t.length!==this.shape.length||0!==o.size)throw Error("Invalid permute axes: ".concat(t.join(", ")," over shape ").concat(this.shape.join(", ")));let l=t.map(e=>this.shape[e]),i=t.map(e=>this.stride[e]);return new j(l,this.buffer,i)}g(e){return this.buffer[this.indexToOffset(e)]}s(e,t){this.buffer[this.indexToOffset(e)]=t}indexToOffset(e){if(e.length!==this.shape.length)throw Error("Index length ".concat(e.length," does not match shape length ").concat(this.shape.length));let t=0;for(let n=0;n<e.length;n++){if(e[n]>=this.shape[n])throw Error("Index ".concat(e[n]," out of bounds for shape ").concat(this.shape[n]));t+=e[n]*this.stride[n]}return t}*indexIterator(){let e=Array(this.shape.length).fill(0);for(;;){yield e;let t=this.shape.length-1;for(;t>=0&&(e[t]++,!(e[t]<this.shape[t]));)e[t]=0,t--;if(t<0)break}}contiguous(){return this.isContiguous?this:new j(this.shape,this.toFloat32Array())}toFloat32Array(){let e=this.shape.reduce((e,t)=>e*t,1),t=new Float32Array(e);if(this.isContiguous)t.set(this.buffer);else{let e=Array(this.shape.length).fill(0),n=0,o=0;for(;;){t[n++]=this.buffer[o];let l=this.shape.length-1;for(;l>=0&&(e[l]++,o+=this.stride[l],!(e[l]<this.shape[l]));)o-=e[l]*this.stride[l],e[l]=0,l--;if(l<0)break}}return t}static fromJson(e){if(!e.shape||!e.dtype||!e.data)throw console.error("Invalid tensor json",e),Error("Invalid tensor json");if("torch.float32"!==e.dtype)throw console.error("Invalid tensor dtype",e),Error("Invalid tensor dtype");let t=(0,C.RG)(e.data),n=new Float32Array(t);return new j(e.shape,n)}copyFrom(e){if(e.shape.length!==this.shape.length||!e.contiguous||!this.contiguous)throw Error("Invalid copy: source shape length ".concat(e.shape.length," does not match target shape length ").concat(this.shape.length));for(let t=0;t<this.shape.length;t++)if(e.shape[t]!==this.shape[t])throw Error("Invalid copy: source shape ".concat(e.shape[t]," does not match target shape ").concat(this.shape[t]));this.buffer.set(e.buffer)}constructor(e,t,n=[]){this.shape=e,this.buffer=t,this.stride=n;let o=e.reduce((e,t)=>e*t,1);if(o>t.length)throw Error("Shape ".concat(e.join(", ")," requires ").concat(o," buffer, but buffer has size ").concat(t.length));let l=Array(e.length),i=1;for(let t=e.length-1;t>=0;t--)l[t]=i,i*=e[t];if(0===n.length)this.stride=l;else if(n.length!==e.length)throw Error("Stride length ".concat(n.length," does not match shape length ").concat(e.length));this.isContiguous=!0;for(let e=0;e<n.length;e++)if(n[e]!==l[e]){this.isContiguous=!1;break}}}var D=n(1074),I=n(9234),L=n(6350),U=n(5429),S=n(9158);let N=new Float32Array(3072);var X=n(9073);(r=h||(h={}))[r.Left=0]="Left",r[r.Right=1]="Right",r[r.Top=2]="Top",r[r.Bot=3]="Bot",(a=m||(m={}))[a.None=0]="None",a[a.Left=1]="Left",a[a.Right=2]="Right";let W=new Float32Array(12);function Z(e,t,n,o,l,i){var r,a;let s=!(arguments.length>6)||void 0===arguments[6]||arguments[6],c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:m.None,u=arguments.length>8?arguments[8]:void 0,d=n.sub(t);d.z=0,d=d.normalize();let f=n.sub(t).len(),h=s?Math.min(.7*f,3):0,p=new X.OO,x=S.AO.cross(d,l).mul(-1).normalize();l=S.AO.cross(x,d).normalize(),p[0]=x.x,p[1]=x.y,p[2]=x.z,p[4]=d.x,p[5]=d.y,p[6]=d.z,p[8]=l.x,p[9]=l.y,p[10]=l.z,t=p.mulVec3Proj(t),n=p.mulVec3Proj(n);let y={width:o,borderColor:i.mul(.8),ribbonColor:i.mul(.3),headDepth:h,headExtra:3,lineThick:1.2,mtx:p};u=u?p.mulVec3ProjVec(u):void 0,Math.abs(t.z-n.z)>.01||u?function(){let o=Math.max(h,Math.abs(t.y-n.y-h)/2),l=new S.AO(t.x,t.y,t.z),i=new S.AO(t.x,t.y+o,t.z),r=new S.AO(n.x,n.y-h-o,n.z),a=new S.AO(n.x,n.y-h,n.z);u&&(r=n.mulAdd(u,-h-o),a=n.mulAdd(u,-h));let c=function(e,t,n,o,l){let i=N,r=0,a=[];function s(e,t,n,o){a.push({p0:e,p1:t,p2:n,p3:o})}for(s(e,t,n,o),o.writeToBuf(i,r),r+=3;a.length>0;){let{p0:e,p1:t,p2:n,p3:o}=a.pop(),l=e.mid(t),c=t.mid(n),u=n.mid(o),d=l.mid(c),f=c.mid(u),h=d.mid(f),m=o.sub(e),p=t.sub(o),x=n.sub(o),y=Math.abs(p.y*m.z-p.z*m.y),g=Math.abs(x.y*m.z-x.z*m.y);if((y+g)*(y+g)>.1*m.lenSq())s(e,l,d,h),s(h,f,u,o);else{if(r+6>i.length){let e=new Float32Array(2*i.length);e.set(i),i=e}e.writeToBuf(i,r),r+=3}}return N=i,i.slice(0,r)}(l,i,r,a,0),d=c.length/3,f=s?3:0,m=(2*d+f)*3;W.length<m&&(W=new Float32Array(m));let p=W.subarray(0,m);for(let t=0;t<d-1;t++)G(e,new S.AO(c[3*t+0],c[3*t+1],c[3*t+2]),new S.AO(c[3*t+3],c[3*t+4],c[3*t+5]),y);let x=d+f;for(let e=0;e<d;e++){let t=x+e;p[3*t+0]=c[3*e+0]+y.width/2,p[3*t+1]=c[3*e+1],p[3*t+2]=c[3*e+2];let n=d-e-1;p[3*n+0]=c[3*e+0]-y.width/2,p[3*n+1]=c[3*e+1],p[3*n+2]=c[3*e+2]}if(s){u=null!=u?u:new S.AO(0,1,0);let e=n.mulAdd(u,-h),t=d;p[3*t+0]=e.x-y.width/2-3,p[3*t+1]=e.y,p[3*t+2]=e.z,p[3*(t+=1)+0]=n.x,p[3*t+1]=n.y,p[3*t+2]=n.z,p[3*(t+=1)+0]=e.x+y.width/2+3,p[3*t+1]=e.y,p[3*t+2]=e.z}let g=(0,L.HP)({thick:y.lineThick,mtx:y.mtx,color:y.borderColor});(0,L.cc)(e.lineRender,p,g)}():G(e,t,n.sub(new S.AO(0,h)),y),c!==m.None&&function(e,t,n,o){let l=n===m.Left?1:-1;et.x=t.x+o.width/2*l,et.y=t.y+o.width/2,et.z=t.z,eo.z=t.z,el.z=t.z;for(let t=0;t<8;t++){let n=t/7*Math.PI/2,i=o.width*Math.cos(n)*l,r=o.width*Math.sin(n);eo.x=et.x-i,eo.y=et.y-r,(0,U.fe)(e.triRender,eo,o.ribbonColor,en,o.mtx),(0,U.fe)(e.triRender,et,o.ribbonColor,en,o.mtx);let a=el;el=eo,eo=a}(0,U.rI)(e.triRender)}(e,t.sub(new S.AO(0,o/2)),c,y),s&&(u=null!=u?u:new S.AO(0,1,0),r=n.mulAdd(u,-h),a=n,H.copy_(r),H.x-=y.width/2,J.copy_(r),J.x+=y.width/2,q.copy_(a),q.x+=y.width/2,Q.copy_(r),Q.x=H.x-3,K.copy_(r),K.x=q.x+3,$.copy_(a),$.x=H.x+y.width/2,(0,U.fe)(e.triRender,Q,y.ribbonColor,ee,y.mtx),(0,U.fe)(e.triRender,$,y.ribbonColor,ee,y.mtx),(0,U.fe)(e.triRender,K,y.ribbonColor,ee,y.mtx),(0,U.rI)(e.triRender))}let Y=new S.AO,V=new S.AO;function G(e,t,n,o){Y.x=t.x-o.width/2,Y.y=t.y,Y.z=t.z,V.x=n.x+o.width/2,V.y=n.y,V.z=n.z,(0,U.bE)(e.triRender,Y,V,o.ribbonColor,o.mtx)}new S.AO,new S.AO;let H=new S.AO,J=new S.AO,q=new S.AO,Q=new S.AO,K=new S.AO,$=new S.AO,ee=new S.AO(0,0,1),et=new S.AO,en=new S.AO(0,0,1),eo=new S.AO,el=new S.AO;var ei=n(1280);function er(e,t,n,o,l){var i;let r=new X.OO;r[14]=(n.z+o.z)/2;let a=l.color,s=l.fontSize,c=null!==(i=l.pad)&&void 0!==i?i:10,u=a.mul(.4),d=(0,P.Ux)(e.modelFontBuf,t,s);(0,P.Dp)(e.modelFontBuf,t,a,n.x-d-2*c,(n.y+o.y)/2-s/2,s,r);let f=new S.AO(n.x,n.y,(n.z+o.z)/2),h=new S.AO(o.x,o.y,(n.z+o.z)/2);n.z!=o.z&&(f=new S.AO(n.x,(n.y+o.y)/2,n.z),h=new S.AO(n.x,(n.y+o.y)/2,o.z));let m=new S.AO(1,0,0);(0,L.j0)(e.lineRender,1,u,f.mulAdd(m,-c),h.mulAdd(m,-c),void 0),(0,L.j0)(e.lineRender,1,u,f.mulAdd(m,-c),f,void 0),(0,L.j0)(e.lineRender,1,u,h.mulAdd(m,-c),h,void 0)}var ea=n(7717),es=n(3014),ec=n(2261),eu=n(7361);function ed(e){if(!e)return null;let t=e.gl,n="\n    layout (std140) uniform BlockUbo {\n        uniform vec3 u_offset;\n        uniform vec3 u_size;\n        uniform vec3 u_nCells;\n        uniform mat4 u_localPosMtx;\n        uniform vec4 u_baseColor;\n        uniform float u_highlight;\n    };",o="\n    layout (std140) uniform BlockAccessUbo {\n        layout(row_major) uniform mat4x2 u_accessMtx;\n        uniform float u_accessTexChannel;\n        uniform float u_accessTexScale;\n    };",l=(0,k.gX)(t,t.UNIFORM_BUFFER,t.createBuffer(),1024,144,null),i=(0,k.gX)(t,t.UNIFORM_BUFFER,t.createBuffer(),1024,80,null),r=function(e){let t=[-1,1,-1,-1,1,1,1,1,-1,-1,1,-1],n=[new X.OO,X.OO.fromAxisAngle(new S.AO(1,0),Math.PI/2),X.OO.fromAxisAngle(new S.AO(1,0),Math.PI),X.OO.fromAxisAngle(new S.AO(1,0),-Math.PI/2),X.OO.fromAxisAngle(new S.AO(0,1),Math.PI/2),X.OO.fromAxisAngle(new S.AO(0,1),-Math.PI/2)],o=X.OO.fromTranslation(new S.AO(.5,.5,.5)).mul(X.OO.fromScale(new S.AO(.5,.5,.5))),l=new Float32Array(216),i=0;for(let e of n)for(let n=0;n<6;n++){let r=o.mulVec3Proj(e.mulVec3Proj(new S.AO(t[2*n],t[2*n+1],-1))),a=e.mulVec3Proj(new S.AO(0,0,-1));l[i++]=Math.round(r.x),l[i++]=Math.round(r.y),l[i++]=Math.round(r.z),l[i++]=a.x,l[i++]=a.y,l[i++]=a.z}let r=e.createVertexArray();e.bindVertexArray(r);let a=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,l,e.STATIC_DRAW),(0,k.FT)(e,a,{},[{name:"a_position",size:3},{name:"a_normal",size:3}]),{name:"cube",vao:r,vbo:a,type:e.TRIANGLES,numVerts:36}}(t),a=t.createVertexArray();t.bindVertexArray(a),t.bindBuffer(t.ARRAY_BUFFER,r.vbo),(0,k.FT)(t,r.vbo,{},[{name:"a_position",size:3},{name:"a_normal",size:3}]);let s=t.createBuffer(),c=(0,k.FT)(t,s,{locOffset:2,divisor:1},[{name:"a_offset",size:4},{name:"a_size",size:4},{name:"a_nCells",size:4},{name:"a_localPosMtx0",size:4},{name:"a_localPosMtx1",size:4},{name:"a_localPosMtx2",size:4},{name:"a_localPosMtx3",size:4},{name:"a_baseColor",size:4},{name:"a_highlight",size:1}]),u=(0,k.gX)(t,t.ARRAY_BUFFER,s,1024,c,null),d=t.createTexture();function f(e){return"#version 300 es\n        precision highp float;\n\n        ".concat(eu.$t,"\n\n        ").concat(e?"":n,"\n\n        ").concat(o,"\n\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_normal;\n        out vec3 v_normal;\n        out vec3 v_modelPos;\n        out vec3 v_blockPos;\n        out vec2 v_accessPos;\n        out vec3 v_cubePos;\n\n        ").concat(e?"\n            layout(location = 2) in vec4 a_offset;\n            layout(location = 3) in vec4 a_size;\n            layout(location = 4) in vec4 a_nCells;\n            layout(location = 5) in vec4 a_localPosMtx0;\n            layout(location = 6) in vec4 a_localPosMtx1;\n            layout(location = 7) in vec4 a_localPosMtx2;\n            layout(location = 8) in vec4 a_localPosMtx3;\n            layout(location = 9) in vec4 a_baseColor;\n            layout(location = 10) in float a_highlight;\n\n            out vec4 u_baseColor;\n            out float u_highlight;\n        ":"","\n\n        void main() {\n            ").concat(e?"\n                vec3 u_offset = a_offset.xyz;\n                vec3 u_size = a_size.xyz;\n                vec3 u_nCells = a_nCells.xyz;\n                mat4 u_localPosMtx = mat4(a_localPosMtx0, a_localPosMtx1, a_localPosMtx2, a_localPosMtx3);\n                u_baseColor = a_baseColor;\n                u_highlight = a_highlight;\n            ":"","\n\n            vec3 localPos = (u_localPosMtx * vec4(a_position, 1.0)).xyz;\n            vec3 model_pos = a_position * u_size + u_offset;\n            gl_Position = u_view * u_model * vec4(model_pos, 1);\n            v_normal = a_normal;\n            v_modelPos = model_pos;\n            v_blockPos = localPos * u_nCells;\n            v_accessPos = u_accessMtx * vec4(v_blockPos, 1.0);\n            v_cubePos = localPos;\n            ").concat(e?" ":"","\n        }")}function h(e){return"#version 300 es\n        precision highp float;\n        in vec3 v_normal;\n        out vec4 o_color;\n        in vec3 v_blockPos;\n        in vec3 v_cubePos;\n        in vec3 v_modelPos;\n        in vec2 v_accessPos;\n        uniform vec3 u_camPos; // in model space\n\n        ".concat(e?"\n            in vec4 u_baseColor;\n            in float u_highlight;\n        ":n,"\n\n        ").concat(o,"\n\n        uniform sampler2D u_accessSampler;\n\n        void main() {\n            ivec3 blockPos = ivec3(v_blockPos - v_normal * 0.1);\n\n            bool cellDark = (blockPos.x + blockPos.y + blockPos.z) % 2 == 0;\n\n            float maxDist = 4000.0;\n            float minDist = 600.0;\n            float dist = distance(u_camPos, v_modelPos);\n            float t = clamp((dist - minDist) / (maxDist - minDist), 0.0, 1.0);\n\n            vec3 baseColor = mix(u_baseColor.rgb, vec3(0.5, 0.5, 0.5), 0.5);\n            if (cellDark) {\n                baseColor *= mix(0.9, 1.0, t);\n            }\n\n            if (u_accessTexScale > 0.0 && dist < maxDist) { // have access texture\n                vec3 texBaseColor = mix(baseColor, vec3(0.5, 0.5, 0.5), 0.8);\n\n                vec3 d = fract(v_blockPos) - 0.5;\n                float r2 = 0.3*0.3;\n                bool insideX = d.y * d.y + d.z * d.z < r2;\n                bool insideY = d.x * d.x + d.z * d.z < r2;\n                bool insideZ = d.x * d.x + d.y * d.y < r2;\n                bool insideAny = insideX || insideY || insideZ;\n\n                if (insideAny) {\n                    ivec2 accessPos = ivec2(u_accessMtx * vec4(blockPos, 1.0));\n                    vec4 valVec = texelFetch(u_accessSampler, accessPos, 0) * u_accessTexScale;\n                    float val = u_accessTexChannel == 0.0 ? valVec.r : u_accessTexChannel == 1.0 ? valVec.g : valVec.b;\n\n                    float weight = clamp(abs(val), 0.0, 1.0);\n\n                    vec3 negColor = vec3(0.0, 0.0, 0.0);\n                    vec3 posColor = u_baseColor.rgb; // vec3(0.0, 1.0, 0.0);\n                    vec3 zeroColor = vec3(0.5, 0.5, 0.5);\n                    texBaseColor = mix(mix(zeroColor, negColor, weight), mix(zeroColor, posColor, weight), step(0.0, val));\n                }\n\n                baseColor = mix(texBaseColor, baseColor, t);\n            }\n\n            if (true) {\n                vec3 block16 = v_blockPos / 16.0;\n                vec3 pxPerBlock16 = 1.0 / fwidth(block16);\n                float strength16 = min(min(pxPerBlock16.x, pxPerBlock16.y), pxPerBlock16.z);\n                vec3 colorEdge = vec3(1.0, 1.0, 1.0);\n                vec3 color16 = vec3(1.0, 1.0, 1.0) * 0.7;\n                vec3 color256 = vec3(1.0, 1.0, 1.0);\n\n                // if we're zoomed out enough, show 256 & (256 * 16) grid lines\n                // the 16 grid lines are faded out by this point (fade out between 10px -> 1px)\n                if (strength16 < 2.0) {\n                    block16 = block16 / 16.0;\n                    pxPerBlock16 = 1.0 / fwidth(block16);\n                    strength16 = min(min(pxPerBlock16.x, pxPerBlock16.y), pxPerBlock16.z);\n                    color16 = color256;\n                    // orange\n                    color256 = vec3(1.0, 0.7, 0.4);\n                }\n\n                float visibility16 = smoothstep(2.0, 10.0, strength16); // below 10px between lines, fade out\n                vec3 block16Grid = 1.0 - abs(fract(block16 - 0.5) - 0.5) * pxPerBlock16;\n                float line16 = max(max(block16Grid.x, block16Grid.y), block16Grid.z) * visibility16;\n\n                vec3 block256 = block16 / 16.0;\n                vec3 block256Grid = 1.0 - abs(fract(block256 - 0.5) - 0.5) / fwidth(block256);\n                float line256 = max(max(block256Grid.x, block256Grid.y), block256Grid.z);\n\n                vec3 cube = v_cubePos - v_normal * 0.1;\n                vec3 cubeGrid = 1.0 - abs(fract(cube - 0.5) - 0.5) / fwidth(cube);\n                float lineCube = max(max(cubeGrid.x, cubeGrid.y), cubeGrid.z);\n\n                float bestPxPerBlock = min(min(pxPerBlock16.x, pxPerBlock16.y), pxPerBlock16.z);\n                float edgeWeight = smoothstep(0.0, 1.0, max(max(line16, lineCube), line256));\n                vec3 color = lineCube > 0.0 ? colorEdge : (line256 > 0.0 ? color256 : color16);\n                baseColor = mix(baseColor, color, edgeWeight);\n            }\n\n            vec3 color = mix(baseColor * 0.7, u_baseColor.rgb, u_highlight);\n\n            o_color = vec4(color, 1) * u_baseColor.a;\n        }")}t.bindTexture(t.TEXTURE_2D,d),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let m=(0,k.tQ)(e,"block",f(!1),h(!1),["u_camPos","u_accessSampler"],{uboBindings:{ModelViewUbo:eu.$c.ModelView,BlockUbo:eu.$c.Block,BlockAccessUbo:eu.$c.BlockAccess}}),p=(0,k.tQ)(e,"block-instanced",f(!0),h(!0),["u_camPos","u_accessSampler"],{uboBindings:{ModelViewUbo:eu.$c.ModelView,BlockAccessUbo:eu.$c.BlockAccess}});return{gl:t,cubeGeom:r,shader:m,simpleShader:(0,k.tQ)(e,"block-simple","#version 300 es\n        precision highp float;\n        ".concat(eu.$t,"\n        uniform vec3 u_size;\n        uniform vec3 u_offset;\n\n        layout(location = 0) in vec3 a_position;\n        void main() {\n            vec3 model_pos = a_position * u_size + u_offset;\n            gl_Position = u_view * u_model * vec4(model_pos, 1);\n        }\n    "),"#version 300 es\n        precision highp float;\n        out vec4 o_color;\n        uniform vec4 u_baseColor;\n\n        void main() {\n            o_color = u_baseColor;\n        }\n    ",["u_size","u_offset","u_baseColor"],{uboBindings:{ModelViewUbo:eu.$c.ModelView}}),blockUbo:l,blockAccessUbo:i,dummyTexture:d,instancedShader:p,instancedVao:a,instancedFloatBuf:u,instancedDataStale:!0,instancedNumBlocks:0}}var ef=n(1499),eh=n(2850),em=n(383),ep=n(7917),ex=n(4485);async function ey(){let e=await fetch("/native.wasm"),t="",n=new WebAssembly.Memory({initial:1,maximum:256}),o={env:{memory:n},odin_env:{write:(e,n,l)=>{let i=new Uint8Array(o.env.memory.buffer,n,l),r=new TextDecoder().decode(i).split("\n");for(let e=0;e<r.length-1;e++)console.log(t+r[e]),t="";t+=r[r.length-1]},time_now:()=>BigInt(Date.now())*BigInt(1e6)},odin_dom:{init_event_raw:e=>{console.log("ODIN: init_event_raw",e)}}},l=await WebAssembly.instantiateStreaming(e,o),i=l.instance.exports;return i.init_allocator(i.__heap_base),new eg(l,i,n)}class eg{createModel(e){var t;return this.exports.wasm_create_model(null!==(t=e.B)&&void 0!==t?t:1,e.block_size,e.n_embd,e.n_layer,e.n_head,e.vocab_size)}runModel(e){this.exports.wasm_run_model(e)}getModelTensor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=this.exports.wasm_get_model_tensor(e,t,n);this.checkViews();let l=this.int32View[o/4],i=this.int32View[o/4+1],r=this.ptrView[o/4+2],a=this.ptrView[o/4+3],s=this.ptrView[o/4+4],c=new Int32Array(this.memory.buffer,a,i),u=new Int32Array(this.memory.buffer,s,i),d=new Float32Array(this.memory.buffer,r,l);return new j([...c],d,[...u])}checkViews(){this.viewBuf!==this.memory.buffer&&(this.viewBuf=this.memory.buffer,this.int32View=new Int32Array(this.memory.buffer),this.ptrView=new Uint32Array(this.memory.buffer))}constructor(e,t,n){this.module=e,this.exports=t,this.memory=n,this.viewBuf=n.buffer,this.int32View=new Int32Array(n.buffer),this.ptrView=new Uint32Array(n.buffer)}}function ev(e){let{gl:t,shape:{B:n,T:o,C:l}}=e;return{output:w(t,l,n*o,1)}}function eb(e,t,n){let{gl:o,shape:{B:l,T:i,C:r}}=e;return{weight:w(o,r,n,1),output:w(o,r,l*i,1)}}function ew(e,t,n,o){let{gl:l,shape:{B:i,T:r}}=e;return{weight:w(l,n,o,1),bias:w(l,1,o,1),output:w(l,o,i*r,1)}}function e_(e){let{gl:t,shape:{B:n,T:o,C:l}}=e;return{normWeight:w(t,1,l,1),normBias:w(t,1,l,1),normAgg:w(t,1,n*o,2),output:w(t,l,n*o,1)}}function eA(e,t){let n=e.weightsDirty||e.intersDirty;e.lastMemoryBuffer!==e.native.memory.buffer&&(e.lastMemoryBuffer=e.native.memory.buffer,n=!0),n&&(function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];s(p.Wte,0,t.vocabEmbed.weight,!0),s(p.Wpe,0,t.posEmbed.weight,!0),s(p.InputTokens,0,t.inputTokens),s(p.InputEmbed,0,t.add.output);for(let e=0;e<t.blocks.length;e++){let n=t.blocks[e];s(p.Ln1Gamma,e,n.ln_1.normWeight,!0),s(p.Ln1Beta,e,n.ln_1.normBias,!0),s(p.Ln1Agg,e,n.ln_1.normAgg),s(p.Ln1Norm,e,n.ln_1.output),s(p.AttnQkvW,e,n.attn.qkvWeight,!0),s(p.AttnQkvB,e,n.attn.qkvBias,!0),s(p.AttnQkv,e,n.attn.qkvOutput),s(p.Attn,e,n.attn.attnMatrix),s(p.AttnSmAgg,e,n.attn.attnMatrixAgg),s(p.AttnSm,e,n.attn.attnMatrixSoftmax),s(p.AttnVOut,e,n.attn.scaledVectors),s(p.AttnProjW,e,n.attn.proj.weight,!0),s(p.AttnProjB,e,n.attn.proj.bias,!0),s(p.AttnProj,e,n.attn.proj.output),s(p.AttnResidual,e,n.attn.output),s(p.Ln2Gamma,e,n.ln_2.normWeight,!0),s(p.Ln2Beta,e,n.ln_2.normBias,!0),s(p.Ln2Agg,e,n.ln_2.normAgg),s(p.Ln2Norm,e,n.ln_2.output),s(p.MlpW,e,n.mlp.fcLayer.weight,!0),s(p.MlpB,e,n.mlp.fcLayer.bias,!0),s(p.MlpProjW,e,n.mlp.projLayer.weight,!0),s(p.MlpProjB,e,n.mlp.projLayer.bias,!0),s(p.MlpMlp,e,n.mlp.fcLayer.output),s(p.MlpAct,e,n.mlp.mlpGelu),s(p.MlpProj,e,n.mlp.projLayer.output),s(p.MlpResidual,e,n.mlp.addLayer.output)}s(p.LnFGamma,0,t.ln_f.normWeight,!0),s(p.LnFBeta,0,t.ln_f.normBias,!0),s(p.LnFAgg,0,t.ln_f.normAgg),s(p.LnFNorm,0,t.ln_f.output),s(p.LmHeadW,0,t.lm_head.weight,!0),s(p.Logits,0,t.lm_head.output),s(p.LogitsSmAgg,0,t.softmaxFinal.agg),s(p.LogitsSm,0,t.softmaxFinal.output);let{T:l,vocabSize:i}=t.shape,r=t.softmaxFinal.output.localBuffer,a=new Float32Array(2*r.length);for(let e=0;e<l;e++){let t=[...r.slice(e*i,(e+1)*i)].map((e,t)=>({v:e,i:t}));t.sort((e,t)=>t.v-e.v);for(let n=0;n<t.length;n++)a[(e*i+n)*2+0]=t[n].i,a[(e*i+n)*2+1]=t[n].v}function s(l,i,r,a){let s=e.native.getModelTensor(e.modelPtr,l,i);(function(e,t,n){let o=n.height*n.width*n.channels;if(t.buffer.length!==o)throw Error("readToBufferTex: buffer size mismatch for ".concat(e,". ")+"bufferTex: ".concat(o," [h: ").concat(n.height,", w: ").concat(n.width,", c: ").concat(n.channels,"], ")+"wasmBuffer:  ".concat(t.buffer.length," [").concat(t.shape.join(", "),"]"));n.localBuffer=t.buffer})("".concat(p[l]).concat(i),s,r),(a?o:n)&&_(t.gl,r,r.localBuffer)}t.sortedBuf=a}(e,t,e.intersDirty,e.weightsDirty),e.weightsDirty=!1,e.intersDirty=!1)}(s=p||(p={}))[s.Wte=0]="Wte",s[s.Wpe=1]="Wpe",s[s.LmHeadW=2]="LmHeadW",s[s.AttnQkvW=3]="AttnQkvW",s[s.AttnQkvB=4]="AttnQkvB",s[s.AttnProjW=5]="AttnProjW",s[s.AttnProjB=6]="AttnProjB",s[s.MlpW=7]="MlpW",s[s.MlpB=8]="MlpB",s[s.MlpProjW=9]="MlpProjW",s[s.MlpProjB=10]="MlpProjB",s[s.Ln1Gamma=11]="Ln1Gamma",s[s.Ln1Beta=12]="Ln1Beta",s[s.Ln2Gamma=13]="Ln2Gamma",s[s.Ln2Beta=14]="Ln2Beta",s[s.LnFGamma=15]="LnFGamma",s[s.LnFBeta=16]="LnFBeta",s[s.InputTokens=17]="InputTokens",s[s.InputTokenEmbed=18]="InputTokenEmbed",s[s.InputEmbed=19]="InputEmbed",s[s.Ln1Agg=20]="Ln1Agg",s[s.Ln1Norm=21]="Ln1Norm",s[s.AttnQkv=22]="AttnQkv",s[s.Attn=23]="Attn",s[s.AttnSmAgg=24]="AttnSmAgg",s[s.AttnSm=25]="AttnSm",s[s.AttnVOut=26]="AttnVOut",s[s.AttnProj=27]="AttnProj",s[s.AttnResidual=28]="AttnResidual",s[s.Ln2Agg=29]="Ln2Agg",s[s.Ln2Norm=30]="Ln2Norm",s[s.MlpMlp=31]="MlpMlp",s[s.MlpAct=32]="MlpAct",s[s.MlpProj=33]="MlpProj",s[s.MlpResidual=34]="MlpResidual",s[s.LnFAgg=35]="LnFAgg",s[s.LnFNorm=36]="LnFNorm",s[s.Logits=37]="Logits",s[s.LogitsSmAgg=38]="LogitsSmAgg",s[s.LogitsSm=39]="LogitsSm";var ek=n(2348),eT=n(6554);let eO=e=>{let{children:t}=e,[n,o]=(0,g.useState)(null),l=(0,D.f9)(),i=(0,g.useCallback)(e=>{e(l),l.markDirty()},[l]);function r(e,t,n){let o=e.camAngle,l=e.camTarget.clone();l.z=l.z+.1*n*o.z;let r=Math.sin(o.x*Math.PI/180)>0?1:-1;l.x=l.x+r*t*.1*o.z,i(e=>{e.camera.center=l})}function a(e,t,n){let o=e.camAngle.clone();o.x=o.x-.5*t,o.y=(0,C.uZ)(o.y+.5*n,-87,87),i(e=>{e.camera.angle=o})}let[s,c]=(0,eT.se)(function(e,t){let n=e.clientX-t.clientX,o=e.clientY-t.clientY;t.shiftKey||1===t.button||2===t.button?a(t.data,n,o):r(t.data,n,o),e.preventDefault()});return((0,eT.oG)(n,{camAngle:l.camera.angle,camTarget:l.camera.center},{alwaysSendDragEvent:!0},function(e,t){let n=t.touches[0],o=e.touches[0],l=o.clientX-n.clientX,i=o.clientY-n.clientY;r(t.data,l,i),e.preventDefault()},function(e,t){let n,o=t.touches[0],l=t.touches[1],r=e.touches[0],s=e.touches[1],c=(o.clientX+l.clientX)/2,u=(o.clientY+l.clientY)/2,d=(r.clientX+s.clientX)/2,f=(r.clientY+s.clientY)/2,h=Math.sqrt((o.clientX-l.clientX)**2+(o.clientY-l.clientY)**2),m=Math.sqrt((r.clientX-s.clientX)**2+(r.clientY-s.clientY)**2);a(t.data,d-c,f-u),(n=t.data.camAngle.clone()).z=(0,C.uZ)(n.z/(m/h),.1,1e5),i(e=>{e.camera.angle=n}),e.preventDefault()}),l.render)?(0,y.jsx)("div",{ref:o,className:M().canvasEventSurface,onMouseDown:function(e){l&&c(e,{camAngle:l.camera.angle,camTarget:l.camera.center})},onMouseMove:function(e){if(l){let t=l.render.canvasEl.getBoundingClientRect(),n=new S.AO(e.clientX-t.left,e.clientY-t.top,0);i(e=>{e.mouse.mousePos=n})}},onWheel:function(e){if(l){let t=l.camera.angle,n=(0,C.uZ)(t.z*Math.pow(1.0013,e.deltaY),.01,1e5);i(e=>{e.camera.angle=new S.AO(t.x,t.y,n)})}e.stopPropagation()},onContextMenu:e=>e.preventDefault(),style:{cursor:s?"grabbing":l.display.hoverTarget?"crosshair":"grab"},children:t}):null};var eB=n(1279);(c=x||(x={}))[c.Up=0]="Up",c[c.Down=1]="Down",c[c.Left=2]="Left",c[c.Right=3]="Right",c[c.Focus=4]="Focus",c[c.In=5]="In",c[c.Out=6]="Out",c[c.Expand=7]="Expand";var ez=n(9232),eE=n(4415),eR=n(6425),eM=n(1409),eP=n(7042),eF=n(2759);let eC=()=>{let e=(0,D.f9)();function t(t){var n;let o=null!==(n=e.examples[t])&&void 0!==n?n:e.mainExample,l=o.enabled,i=e.currExampleId===t;return(0,y.jsx)("div",{className:(0,eP.Z)("m-2 p-2 rounded shadow cursor-pointer hover:bg-blue-300",i?"bg-blue-200":"bg-white"),onClick:function(){l||(o.enabled=!0),e.currExampleId=t,e.camera.desiredCamera=o.camera,e.markDirty()},children:o.name})}return(0,y.jsxs)("div",{className:"absolute top-0 left-0 flex flex-col",children:[(0,y.jsxs)("div",{className:"mt-2 ml-2 flex flex-row",children:[t(0),t(-1),t(1),t(2)]}),(0,y.jsxs)("div",{className:"ml-2 flex flex-row",children:[(0,y.jsx)("div",{className:(0,eP.Z)("m-2 p-2 bg-white min-w-[2rem] flex justify-center rounded shadow cursor-pointer hover:bg-blue-300"),onClick:function(){var t;let n=null!==(t=e.examples[e.currExampleId])&&void 0!==t?t:e.mainExample;e.camera.desiredCamera=n.camera,e.markDirty()},children:(0,y.jsx)(eB.G,{icon:eF.TL5})}),(0,y.jsx)("div",{className:(0,eP.Z)("m-2 p-2 bg-white min-w-[2rem] flex justify-center rounded shadow cursor-pointer hover:bg-blue-300"),onClick:function(){var t,n;let o=null!==(t=e.examples[e.currExampleId])&&void 0!==t?t:e.mainExample,l=(null!==(n=o.layout)&&void 0!==n?n:e.layout).residual0,i=new S.AO(l.x,l.y,l.z),r=e.camera.modelMtx.mul(X.OO.fromTranslation(o.offset)).mulVec3Proj(i),a=-1===e.currExampleId?.7:4;e.camera.desiredCamera={center:r,angle:new S.AO(270,4.5,a)},e.markDirty()},children:(0,y.jsx)(eB.G,{icon:eF.Y$T})})]})]})};async function ej(e){let t=await fetch(e),n=await t.json();for(let e in n)n[e].shape&&(n[e]=j.fromJson(n[e]));return n}function eD(){let[e,t]=(0,g.useState)(null),[n,o]=(0,g.useState)(null),[l,i]=(0,g.useState)(null),[r,a]=(0,g.useState)(null),s=(0,ez.A)(),c=(0,g.useContext)(eR.XC);(0,eR.qi)(eR.Cf.MainPage,e=>{if(!(null==l?void 0:l.progState))return;let t=e.key.toLowerCase(),n=l.progState.walkthrough,o=l.progState.movement;" "===e.key&&(n.time>=n.phaseLength?((0,eE.CY)(n,1),n.time=0):n.running=!n.running,l.markDirty()),("Backspace"===e.key||"Delete"===e.key)&&(n.running=!1,n.time=0,l.markDirty()),("ArrowLeft"===e.key||"a"===t)&&(o.action=x.Left,l.markDirty()),("ArrowRight"===e.key||"d"===t)&&(o.action=x.Right,l.markDirty()),("ArrowUp"===e.key||"w"===t)&&(o.action=x.Up,l.markDirty()),("ArrowDown"===e.key||"s"===t)&&(o.action=x.Down,l.markDirty()),("PageUp"===e.key||"q"===t)&&(o.action=x.In,l.markDirty()),("PageDown"===e.key||"e"===t)&&(o.action=x.Out,l.markDirty()),"r"===t&&(o.action=x.Expand,l.markDirty()),"f"===t&&(o.action=x.Focus,l.markDirty())," "===e.key&&e.preventDefault()}),(0,g.useEffect)(()=>(document.addEventListener("keydown",c.handleKey),()=>{document.removeEventListener("keydown",c.handleKey)}),[c]),(0,g.useEffect)(()=>{let e=!1;return async function(){let t=ej("gpt-nano-sort-t0-partials.json"),n=ej("gpt-nano-sort-model.json"),l=ey(),[i,r,a]=await Promise.all([t,n,l]);e||o({data:i,model:r,native:a})}(),()=>{e=!0}},[]),(0,g.useEffect)(()=>{let e=!1;return async function(){let t=await (0,P.s1)();e||a(t)}(),()=>{e=!0}},[]),(0,g.useEffect)(()=>{if(e&&r){let t=new eI(e,null,r),n=new ResizeObserver(()=>{t.canvasSizeDirty=!0,t.markDirty()}),o=e=>e.preventDefault();return i(t),n.observe(e),e.addEventListener("wheel",o,{passive:!1}),()=>{e.removeEventListener("wheel",o),t.destroy(),n.disconnect()}}i(null)},[e,r]),(0,g.useEffect)(()=>{null==l||l.setData({dataAndModel:n})},[l,n]),(0,g.useLayoutEffect)(()=>{l&&(l.progState.pageLayout=s,l.markDirty())},[l,s]);let u=l&&(0,y.jsx)("div",{className:M().sidebar,children:(0,y.jsx)(D.nG.Provider,{value:l.progState,children:(0,y.jsx)(D.U$,{})})}),d=(0,y.jsxs)("div",{className:M().canvasWrap,children:[(0,y.jsx)("canvas",{className:M().canvas,ref:t}),l&&!l.progState.render&&(0,y.jsxs)("div",{className:"absolute flex flex-col items-center w-full h-full justify-center",children:[(0,y.jsx)("div",{className:"text-2xl",children:"This application requires a WebGL2 capable browser."}),(0,y.jsx)("div",{className:"text-lg mt-2",children:"Please try the latest version of Chrome or Firefox."})]}),l&&(0,y.jsxs)(D.nG.Provider,{value:l.progState,children:[(0,y.jsx)(eO,{}),(0,y.jsx)(eC,{})]})]});return(0,y.jsx)("div",{className:M().view,children:(0,y.jsxs)(eM.w,{id:"llm-sidebar",className:"flex-1",vertical:!s.isDesktop,defaultFraction:.4,children:[s.isDesktop&&u,d,!s.isDesktop&&u]})})}class eI{destroy(){this.stopped=!0}setData(e){if(this.canvasData=e,e.dataAndModel&&!this.progState.gptGpuModel&&this.progState.render){var t,n,o,l;let i,r,a,s,c,u,d,f,h;this.progState.gptGpuModel=(t=this.renderState,n=e.dataAndModel,function(e,t,n){let o=e.gl,l="transformer",i=t.config,r=i.n_embd,a=i.n_head,s=i.block_size,c=i.n_layer,u=i.vocab_size,d={B:n,C:r,nHeads:a,T:s,A:r/a,nBlocks:c,vocabSize:u},f={gl:o,model:t,shape:d,shaderManager:e},h=new Float32Array(n*s),m=w(o,1,n*s,1),p=new Float32Array(n*s);for(let e=0;e<n;e++)for(let t=0;t<s;t++)p[e*s+t]=t;let x=w(o,1,n*s,1);_(o,x,p);let y=z(f,l+".wte",u,r,m),g=z(f,l+".wpe",s,r,x),v=E(f,y.output,g.output),A=[],R=v.output;for(let e=0;e<c;e++){let t=function(e,t,n){let o=O(e,t+".ln_1",n),l=function(e,t,n,o){let{gl:l,model:i,shape:{B:r,T:a,C:s,nHeads:c,A:u},shaderManager:d}=e,f=i[t+".c_attn.weight"].view([3,c,u,s]).permute(1,2,3,0),h=i[t+".c_attn.bias"].view([3,c,u]).permute(1,2,0),m=w(l,s,c*u,3),p=w(l,1,c*u,3),x=w(l,u,r*c*a,4),y=w(l,a,r*c*a,1),g=w(l,1,r*c*a,2),v=w(l,a,r*c*a,1),A=w(l,c*u,r*a,1);_(l,m,f.toFloat32Array()),_(l,p,h.toFloat32Array());let O=(0,k.tQ)(d,"qkv",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D attnInput; // (B, T)         (C)\n        uniform sampler2D qkvWeight; // (nHeads, A)    (C) [3]\n        uniform sampler2D qkvBias;   // (nHeads, A)    (1) [3]\n        out vec4 qkvOutput;          // (B, nHeads, T) (A)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            int headIdx = pos.y / ".concat(a,";\n            int tIdx = pos.y % ").concat(a,";\n            int bIdx = headIdx / ").concat(c,";\n            headIdx = headIdx % ").concat(c,";\n\n            vec3 a = texelFetch(qkvBias, ivec2(0, headIdx * ").concat(u," + pos.x), 0).rgb;\n            for (int i = 0; i < ").concat(s,"; i++) {\n                float inVal = texelFetch(attnInput, ivec2(i, tIdx + bIdx * ").concat(a,"    ), 0).r;\n                vec3 qkvW   = texelFetch(qkvWeight,  ivec2(i, headIdx * ").concat(u," + pos.x), 0).rgb;\n                a += inVal * qkvW;\n            }\n\n            qkvOutput = vec4(a, 1);\n        }\n    ")),z=(0,k.tQ)(d,"selfAttend",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D qkvOutput; // (B, nHeads, T) (A)\n        out float attnMatrix;        // (B, nHeads, T) (T)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxK = pos.x;\n            int tIdxQ = pos.y % ".concat(a,";\n            int yOffset = pos.y - tIdxQ;\n\n            if (tIdxK > tIdxQ) { // # forward attention only\n                discard;\n            }\n\n            float a = 0.0;\n            for (int i = 0; i < ").concat(u,"; i++) {\n                float q = texelFetch(qkvOutput, ivec2(i, yOffset + tIdxQ), 0).r;\n                float k = texelFetch(qkvOutput, ivec2(i, yOffset + tIdxK), 0).g;\n                a += q * k;\n            }\n\n            attnMatrix = a / sqrt(float(").concat(u,"));\n        }\n    ")),R=(0,k.tQ)(d,"attnMatrixAgg",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D attnMatrix; // (B, nHeads, T) (T)\n        out vec2 attnMatrixAgg;       // (B, nHeads, T) (1) [2]\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxY = pos.y % ".concat(a,";\n\n            // Pass 1 finds the max\n            float m = 0.0;\n            for (int i = 0; i <= tIdxY; i++) {\n                float p = texelFetch(attnMatrix, ivec2(i, pos.y), 0).r;\n                m = max(m, p);\n            }\n\n            // Pass 2 finds the exp sum (shifted by max)\n            float a = 0.0;\n            for (int i = 0; i <= tIdxY; i++) {\n                float p = texelFetch(attnMatrix, ivec2(i, pos.y), 0).r;\n                a += exp(p - m);\n            }\n\n            // Store sufficient information to compute/apply the softmax\n            attnMatrixAgg = vec2(1.0 / a, m);\n        }\n    ")),M=(0,k.tQ)(d,"attnMatrixSoftmax",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D attnMatrix;    // (B, nHeads, T) (T)\n        uniform sampler2D attnMatrixAgg; // (B, nHeads, T) (1) [2]\n        out float attnMatrixSoftmax;     // (B, nHeads, T) (T)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxX = pos.x;\n            int tIdxY = pos.y % ".concat(a,";\n\n            if (tIdxX > tIdxY) { // # forward attention only\n                attnMatrixSoftmax = 0.0;\n                discard;\n            }\n\n            vec2 agg = texelFetch(attnMatrixAgg, ivec2(0, pos.y), 0).rg;\n            float expSumInv = agg.r;\n            float maxVal = agg.g;\n\n            float p = texelFetch(attnMatrix, pos, 0).r;\n            attnMatrixSoftmax = exp(p - maxVal) * expSumInv;\n        }\n    ")),P=(0,k.tQ)(d,"scaledVectors",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D qkvOutput;         // (B, nHeads, T) (A)\n        uniform sampler2D attnMatrixSoftmax; // (B, nHeads, T) (T)\n        out float scaledVectors;             // (B, T)         (A * nHeads)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int aIdx = pos.x % ".concat(u,";\n            int headIdx = pos.x / ").concat(u,";\n\n            int tIdxY = pos.y % ").concat(a,";\n            int bIdx = pos.y / ").concat(a,";\n\n            int yOffset = bIdx * ").concat(a," * ").concat(c," + headIdx * ").concat(a,";\n\n            float res = 0.0;\n            for (int i = 0; i <= tIdxY; i++) {\n                float sm = texelFetch(attnMatrixSoftmax, ivec2(i, yOffset + tIdxY), 0).r;\n                float v = texelFetch(qkvOutput, ivec2(aIdx, yOffset + i), 0).b;\n                res += sm * v;\n            }\n\n            scaledVectors = res;\n        }\n    "));if(!O||!z||!R||!M||!P)throw Error("Failed to create shader program");let F=b(l,O,[x],[n,m,p],["attnInput","qkvWeight","qkvBias"]),C=b(l,z,[y],[x],["qkvOutput"]),j=b(l,R,[g],[y],["attnMatrix"]),D=b(l,M,[v],[y,g],["attnMatrix","attnMatrixAgg"]),I=b(l,P,[A],[x,v],["qkvOutput","attnMatrixSoftmax"]),L=B(e,t+".c_proj",s,s,A),U=E(e,L.output,o);return{qkvWeight:m,qkvBias:p,qkvOutput:x,attnMatrix:y,attnMatrixAgg:g,attnMatrixSoftmax:v,scaledVectors:A,qkvPhase:F,selfAttendPhase:C,attnMatrixAggPhase:j,attnMatrixSoftmaxPhase:D,scaledVectorsPhase:I,proj:L,add:U,output:U.output}}(e,t+".attn",o.output,n),i=O(e,t+".ln_2",l.output),r=function(e,t,n,o){let{gl:l,shape:{B:i,T:r,C:a},shaderManager:s}=e,c=w(l,4*a,i*r,1),u=(0,k.tQ)(s,"mlpGelu",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D geluInput;  // (B, T) (C * 4)\n        out float geluOutput; // (B, T) (C * 4)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            float x = texelFetch(geluInput, pos, 0).r;\n            geluOutput = x * 0.5 * (1.0 + tanh(sqrt(2.0 / 3.14159265358) * (x + 0.044715 * x * x * x)));\n        }\n    "),d=B(e,t+".c_fc",a,4*a,n),f=b(l,u,[c],[d.output],["geluInput"]),h=B(e,t+".c_proj",4*a,a,c),m=E(e,h.output,o);return{fcLayer:d,mlpGelu:c,geluPhase:f,projLayer:h,addLayer:m,output:m.output}}(e,t+".mlp",i.output,l.output);return{attn:l,ln_1:o,ln_2:i,mlp:r,output:r.output}}(f,l+".h."+e,R);A.push(t),R=t.output}let M=O(f,l+".ln_f",R),P=B(f,"lm_head",r,u,M.output,void 0,!1),F=function(e,t){let{gl:n,shape:{B:o,T:l,C:i,vocabSize:r},shaderManager:a}=e,s=w(n,1,o*l,2),c=w(n,r,o*l,1),u=(0,k.tQ)(a,"softmaxAgg",T,"#version 300 es\n        precision highp float;       //    y      x\n        uniform sampler2D smInput;   // (B, T) (nVocab)\n        out vec2 smAgg;              // (B)    (nVocab) [2]\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxY = pos.y % ".concat(l,";\n\n            // Pass 1 finds the max\n            float m = 0.0;\n            for (int i = 0; i < ").concat(r,"; i++) {\n                float p = texelFetch(smInput, ivec2(i, pos.y), 0).r;\n                m = max(m, p);\n            }\n\n            // Pass 2 finds the exp sum (shifted by max)\n            float a = 0.0;\n            for (int i = 0; i < ").concat(r,"; i++) {\n                float p = texelFetch(smInput, ivec2(i, pos.y), 0).r;\n                a += exp(p - m);\n            }\n\n            // Store sufficient information to compute/apply the softmax\n            smAgg = vec2(1.0 / a, m);\n        }\n    ")),d=(0,k.tQ)(a,"softmax",T,"#version 300 es\n        precision highp float;\n        uniform sampler2D smInput;    // (B, T) (nVocab)\n        uniform sampler2D smAgg;      // (B)    (nVocab) [2]\n        out float smOutput;           // (B, T) (nVocab)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxX = pos.x;\n            int tIdxY = pos.y % ".concat(l,";\n\n            vec2 agg = texelFetch(smAgg, ivec2(0, pos.y), 0).rg;\n            float expSumInv = agg.r;\n            float maxVal = agg.g;\n\n            float p = texelFetch(smInput, pos, 0).r;\n            smOutput = exp(p - maxVal) * expSumInv;\n        }\n    ")),f=b(n,u,[s],[t],["smInput"]),h=b(n,d,[c],[t,s],["smInput","smAgg"]);return{bufs:[s,c],progs:[u,d],phases:[f,h],agg:s,aggPhase:f,softmaxPhase:h,output:c}}(f,P.output),C=function(e,t,n){let{gl:o,shape:{T:l,vocabSize:i},shaderManager:r}=e;return{copyPhase:b(o,(0,k.tQ)(r,"copy",T,"#version 300 es\n        precision highp float;         //    y    x\n        uniform sampler2D prevOutput;  // (B, T) (n_vocab)\n        uniform int u_targetTIdx;\n        out float currInput;           // (B, T) (1)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            int tIdx = pos.y % ".concat(l,";\n\n            if (tIdx != u_targetTIdx) {\n                discard;\n            }\n\n            int maxVocabI = 0;\n            float maxVocabP = 0.0;\n            for (int i = 0; i < ").concat(i,"; i++) {\n                float p = texelFetch(prevOutput, ivec2(i, pos.y), 0).r;\n                if (p > maxVocabP) {\n                    maxVocabP = p;\n                    maxVocabI = i;\n                }\n            }\n\n            currInput = float(maxVocabI);\n        }\n    ")),[n],[t],["prevOutput"])}}(f,F.output,m);return(0,k.OM)(e),{gl:o,inputBuf:h,inputTokens:m,vocabEmbed:y,posEmbed:g,add:v,blocks:A,ln_f:M,lm_head:P,shape:d,softmaxFinal:F,copyOutputToInput:C,output:F.output,inputLen:6,resultBuf:null,sortedBuf:null,readbackSync:null}}(t.ctx.shaderManager,n.model,1)),this.progState.native=e.dataAndModel.native,this.progState.wasmGptModel=function(e,t,n){let o=n.createModel(t);i("transformer.wte.weight",p.Wte),i("transformer.wpe.weight",p.Wpe),i("lm_head.weight",p.LmHeadW),l("transformer.ln_f",p.LnFGamma,p.LnFBeta);for(let e=0;e<t.n_layer;e++){let t="transformer.h.".concat(e);l(t+".ln_1",p.Ln1Gamma,p.Ln1Beta,e),l(t+".ln_2",p.Ln2Gamma,p.Ln2Beta,e),l(t+".attn.c_attn",p.AttnQkvW,p.AttnQkvB,e),l(t+".attn.c_proj",p.AttnProjW,p.AttnProjB,e),l(t+".mlp.c_fc",p.MlpW,p.MlpB,e),l(t+".mlp.c_proj",p.MlpProjW,p.MlpProjB,e)}function l(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(e+".weight",t,o),i(e+".bias",n,o)}function i(t,l){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e[t]?n.getModelTensor(o,l,i).copyFrom(e[t]):console.log("ERROR: missing tensor name:",t)}n.getModelTensor(o,p.InputTokens).buffer.set([2,1,0,1,1,2,0,0,0,0,0]);{let e=performance.now();n.runModel(o),console.log("runModel",(performance.now()-e).toFixed(2)+"ms")}return{native:n,modelPtr:o,lastMemoryBuffer:null,weightsDirty:!0,intersDirty:!0}}(e.dataAndModel.model,e.dataAndModel.model.config,e.dataAndModel.native),this.progState.jsGptModel=(o=this.renderState.gl,i=(l=e.dataAndModel.model.config).n_embd,r=l.n_head,d={gl:o,shape:u={B:1,C:i,nHeads:r,T:a=l.block_size,A:i/r,nBlocks:s=l.n_layer,vocabSize:c=l.vocab_size}},f=w(o,1,1*a,1),h=function(e){let{gl:t,shape:{B:n,T:o,vocabSize:l}}=e;return{agg:w(t,1,n*o,2),output:w(t,l,n*o,1)}}(d),{gl:o,add:ev(d),inputBuf:new Float32Array,inputLen:6,ln_f:e_(d),inputTokens:f,lm_head:ew(d,a,i,c),blocks:(0,C.VL)(s).map(()=>{let e;return e=function(e){let{gl:t,shape:{B:n,T:o,C:l}}=e,i=ev(e);return{fcLayer:ew(e,o,l,4*l),mlpGelu:w(t,4*l,n*o,1),projLayer:ew(e,o,4*l,l),addLayer:i,output:i.output}}(d),{ln_1:e_(d),attn:function(e){var t,n;let{gl:o,shape:{B:l,T:i,C:r,nHeads:a,A:s}}=e,c=ev(e);return{qkvWeight:w(o,r,3*a*s,1),qkvBias:w(o,1,3*a*s,1),attnMatrix:(t=l*a*i,w(o,i,t,1)),attnMatrixAgg:w(o,1,l*a*i,2),attnMatrixSoftmax:(n=l*a*i,w(o,i,n,1)),qkvOutput:w(o,3*a*s,l*i,1),add:ev(e),proj:ew(e,i,r,r),scaledVectors:w(o,a*s,l*i,1),output:c.output}}(d),ln_2:e_(d),mlp:e,output:e.output}}),output:h.output,posEmbed:eb(d,f,a),vocabEmbed:eb(d,f,c),shape:u,softmaxFinal:h,resultBuf:null,sortedBuf:null})}this.markDirty()}checkSyncObjects(){if(!this.progState.render)return;let e=this.renderState.gl,t=this.progState.render.syncObjects,n=!1;for(let o=0;o<t.length;o++){let l=t[o];if(l.isReady){n=!0;continue}e.clientWaitSync(l.sync,0,0)===e.TIMEOUT_EXPIRED?this.isWaitingForSync=!0:(l.isReady=!0,l.elapsedMs=performance.now()-l.startTime,e.deleteSync(l.sync),n=!0)}n&&(this.progState.render.syncObjects=t.filter(e=>!e.isReady),this.markDirty())}render(e,t){if(!this.progState.render)return;let n=this.renderState.canvasEl;if(this.canvasSizeDirty){let e=n.getBoundingClientRect(),t=window.devicePixelRatio;n.width=e.width*t,n.height=e.height*t,this.progState.render.size=new S.AO(e.width,e.height),this.canvasSizeDirty=!1}!function(e,t){var n;let o=performance.now();if(!t.render)return;for(let e of(n=t.render,(0,L.xW)(n.lineRender),(0,P.Nn)(n.modelFontBuf),(0,U.m8)(n.triRender),t.render.sharedRender.activePhase=eu.i$.Opaque,t.display.lines=[],t.display.hoverTarget=null,t.display.tokenColors=null,t.display.tokenIdxColors=null,t.wasmGptModel&&t.jsGptModel&&eA(t.wasmGptModel,t.jsGptModel),t.stepModel&&t.wasmGptModel&&t.jsGptModel&&(t.stepModel=!1,function(e,t){let{native:n,modelPtr:o}=e,{shape:{B:l,T:i,vocabSize:r}}=t,a=t.inputLen-1;if(!t.sortedBuf||a>=i-1)return;let s=n.getModelTensor(o,p.InputTokens);for(let e=0;e<l;e++){let n=t.sortedBuf[e*i*r*2+a*r*2+0];s.buffer[e*i+a+1]=n}t.inputLen+=1,n.runModel(o),e.intersDirty=!0,eA(e,t)}(t.wasmGptModel,t.jsGptModel)),t.layout=(0,es.nb)(t.shape,t.jsGptModel),t.examples))if(e.enabled&&!e.layout){let t=(0,es.nb)(e.shape,null,e.offset);e.layout=t}(0,I.L7)(t,t.layout);let l=function(e,t){if(!e.ctx.ext.disjointTimerQuery)return null;let n=e.queries.get(t);if(!n){let o=e.ctx.gl.createQuery();e.queries.set(t,n={query:o,hasRun:!1,hasStarted:!1})}let o=!1;n.hasRun&&(o=e.ctx.gl.getQueryParameter(n.query,e.ctx.gl.QUERY_RESULT_AVAILABLE));let l=null;return o&&(l=e.ctx.gl.getQueryParameter(n.query,e.ctx.gl.QUERY_RESULT)/1e6),(!n.hasRun||o)&&(e.ctx.gl.beginQuery(e.TIME_ELAPSED_EXT,n.query),n.hasRun=!0,n.hasStarted=!0),l}(t.render.queryManager,"render");for(let n of((0,C.DX)(l)&&(t.render.lastGpuMs=l),t.render.renderTiming=!1,t.inWalkthrough&&(0,em.Kh)(t,e),(0,I.H4)(t,e),function(e){for(let t of e.layout.cubes){let n=new S.AO(t.x+t.dx/2,t.y,t.z+t.dz/2),o=(0,I.zG)(e,n);o=Math.min(o,1.45);let l=new S.T8(1,1,1,1).mul(t.opacity),i=new S.T8(0,0,0,1).mul(t.opacity);if(0===t.opacity||!t.name)continue;let r=t.name,a=X.OO.fromTranslation(n),s={color:l,size:2.5*o,mtx:a},c=(0,P.X1)(e.render.modelFontBuf,r,s);e.render.sharedRender.activePhase=eu.i$.Opaque,(0,ex.QP)(e.render,new S.AO(-c/2-.4,-s.size-.8,0),new S.AO(c/2+.4,0,0),i,a,.4*o),e.render.sharedRender.activePhase=eu.i$.Overlay,(0,P.yU)(e.render.modelFontBuf,r,-c/2,-s.size-.4,s)}}(t),function(e,t){let n=t.residual0,o=S.T8.fromHexColor("#3333aa"),l=S.T8.fromHexColor("#33aa33");r(t.idxObj,t.residual0),a(t.tokEmbedObj,t.residual0),d(t.posEmbedObj,h.Left,t.residual0,h.Right);for(let e=0;e<3;e++){let o=t.blocks[e];for(let e of(r(n,o.attnResidual),c(n,o.ln1.lnResid),c(n,o.ln1.lnAgg2,2),r(o.ln1.lnAgg2,o.ln1.lnResid,2),o.heads))d(o.ln1.lnResid,h.Left,e.qBlock,h.Right),d(o.ln1.lnResid,h.Left,e.kBlock,h.Right),d(o.ln1.lnResid,h.Left,e.vBlock,h.Right),a(e.qBiasBlock,e.qWeightBlock),a(e.kBiasBlock,e.kWeightBlock),a(e.vBiasBlock,e.vWeightBlock),a(e.qWeightBlock,e.qBlock),a(e.kWeightBlock,e.kBlock),a(e.vWeightBlock,e.vBlock),u(e.qBlock,e.attnMtx,0,void 0,e.qBlock.y!==e.kBlock.y),u(e.kBlock,e.attnMtx,0,void 0,e.kBlock.y!==e.qBlock.y),u(e.vBlock,e.vOutBlock,0,void 0,e.vBlock.y!==e.kBlock.y),d(e.attnMtx,h.Left,e.attnMtxAgg2,h.Right),d(e.attnMtxAgg1,h.Left,e.attnMtxSm,h.Right),d(e.attnMtxSm,h.Bot,e.vOutBlock,h.Left),d(e.vOutBlock,h.Bot,o.attnOut,h.Top);r(o.attnResidual,o.mlpResidual),a(o.attnOut,o.attnResidual),a(o.projBias,o.projWeight),a(o.projWeight,o.attnOut),a(o.ln1.lnMu,o.ln1.lnSigma),a(o.ln1.lnSigma,o.ln1.lnResid),c(o.attnResidual,o.ln2.lnAgg2,2),r(o.ln2.lnAgg2,o.ln2.lnResid,2),a(o.ln2.lnMu,o.ln2.lnSigma),a(o.ln2.lnSigma,o.ln2.lnResid),c(o.attnResidual,o.ln2.lnResid),d(o.ln2.lnResid,h.Bot,o.mlpFc,h.Right),r(o.mlpFcBias,o.mlpFcWeight),r(o.mlpFcWeight,o.mlpFc,12),r(o.mlpFc,o.mlpAct,12),a(o.mlpProjBias,o.mlpProjWeight),a(o.mlpProjWeight,o.mlpResult),a(o.mlpResult,o.mlpResidual),d(o.mlpAct,h.Right,o.mlpResult,h.Top),n=o.mlpResidual}function i(e){return"w"===e.t?o:l}function r(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6;d(e,h.Bot,t,h.Top,n)}function a(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6;d(e,h.Right,t,h.Left,n)}function s(e,t){let n=e.z+e.dz/2;switch(t){case h.Left:return new S.AO(e.x-2,e.y+e.dy/2,n);case h.Right:return new S.AO(e.x+e.dx+2,e.y+e.dy/2,n);case h.Top:return new S.AO(e.x+e.dx/2,e.y-2,n);case h.Bot:return new S.AO(e.x+e.dx/2,e.y+e.dy+2,n)}}function c(t,n){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6,l=s(t,h.Bot),r=s(n,h.Right),a=Math.min(t.opacity,n.opacity);if(0===a)return;let c=new S.AO(0,0,1),u=i(t).mul(a);Z(e,new S.AO(l.x-3,r.y),r,o,c,u,!0)}function u(n,o,l){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],c=s(n,h.Bot),u=c.z>o.z+o.dz/2,d=new S.AO(o.x+o.dx/2,o.y+t.cell*(l+.5),u?o.z+o.dz/2+2:o.z-2),f=Math.min(n.opacity,o.opacity);if(0===f)return;let p=new S.AO(0,0,1),x=i(n).mul(f),y=new S.AO(0,0,u?-1:1);1>Math.abs(c.z-(o.z+o.dz/2))&&!a&&(y=void 0,d=s(o,h.Top)),Z(e,c,d,r,p,x,!0,m.None,y)}function d(t,n,o,l){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6,a=s(t,n),c=s(o,l),u=Math.min(t.opacity,o.opacity);if(0===u)return;let d=new S.AO(0,0,1),f=i(t).mul(u);if(n===h.Left&&l===h.Right&&(a.y=c.y),n===h.Right&&l===h.Top){let t=new S.AO(c.x-r/2,a.y,a.z),n=new S.AO(c.x,a.y+r/2,c.z);Z(e,a,t,r,d,f,!1),Z(e,n,c,r,d,f,!0,m.Left)}else if(n===h.Bot&&l===h.Right){let t=new S.AO(a.x,c.y-r/2,c.z),n=new S.AO(a.x-r/2,c.y,c.z);Z(e,a,t,r,d,f,!1),Z(e,n,c,r,d,f,!0,m.Left)}else if(n===h.Bot&&l===h.Left){let t=new S.AO(a.x,c.y-r/2,c.z),n=new S.AO(a.x+r/2,c.y,c.z);Z(e,a,t,r,d,f,!1,m.None,new S.AO(0,1,0)),Z(e,n,c,r,d,f,!0,m.Right)}else Z(e,a,c,r,d,f,!0)}c(n,t.ln_f.lnAgg2,2),d(n,h.Bot,t.ln_f.lnResid,h.Right),r(t.ln_f.lnAgg2,t.ln_f.lnResid),a(t.ln_f.lnMu,t.ln_f.lnSigma),a(t.ln_f.lnSigma,t.ln_f.lnResid),t.logitsTransposed?(d(t.ln_f.lnResid,h.Bot,t.logits,h.Right),r(t.lmHeadWeight,t.logits),r(t.logits,t.logitsSoftmax),a(t.logits,t.logitsAgg1,2),d(t.logitsAgg2,h.Bot,t.logitsSoftmax,h.Right,2)):(r(t.ln_f.lnResid,t.logits),a(t.lmHeadWeight,t.logits),r(t.logits,t.logitsAgg2),r(t.logitsAgg1,t.logitsSoftmax))}(t.render,t.layout),(0,ea.CB)(t,t.layout,"nano-gpt",new S.AO),t.examples))n.enabled&&n.layout&&(0,ea.CB)(t,n.layout,n.name,n.offset.add(n.modelCardOffset));(0,ep.nV)(t),t.render.sharedRender.activePhase=eu.i$.Opaque,function(e,t){let n=new S.T8(.4,.4,.4,1);{let o=n.mul(t.embedLabel.visible);er(e,"Embedding",new S.AO(t.tokEmbedObj.x-2*t.margin,t.tokEmbedObj.y,0),new S.AO(t.tokEmbedObj.x-2*t.margin,t.tokEmbedObj.y+t.tokEmbedObj.dy,0),{color:o,fontSize:6,pad:4})}let o=0;for(let l of t.blocks){let i=l.ln1.lnResid.y-t.margin/2,r=l.mlpResult.y+l.mlpResult.dy+t.margin/2,a=l.mlpProjBias.x-3*t.margin,s=l.projBias.x-t.margin,c=s-3*t.margin,u=(0,ei.t7)(s,a,.6),d=l.attnOut.y-t.margin/2,f=l.attnOut.y+l.attnOut.dy+t.margin/2,h=l.mlpFcBias.y-t.margin/2,m=a-6*t.margin;{let t=n.mul(l.mlpResidual.opacity*l.transformerLabel.visible),a=new S.AO(m,i,0),s=new S.AO(m,r,0);er(e,"Transformer ".concat(o),a,s,{color:t,fontSize:26})}{let t=n.mul(l.attnResidual.opacity*l.selfAttendLabel.visible);er(e,"Self-attention",new S.AO(u,i,0),new S.AO(u,f,0),{color:t,fontSize:12})}{let t=n.mul(l.mlpAct.opacity*l.mlpLabel.visible);er(e,"MLP",new S.AO(a,h,0),new S.AO(a,r,0),{color:t,fontSize:12})}{let t=n.mul(l.attnOut.opacity*l.projLabel.visible);er(e,"Projection",new S.AO(c,d,0),new S.AO(c,f,0),{color:t,fontSize:10})}let p=0;for(let t of l.heads){{let o=n.mul(t.attnMtx.opacity*t.headLabel.visible),l=new S.AO(c,t.vBlock.y,t.vBlock.z+t.vBlock.dz/2),i=new S.AO(c,t.qBlock.y+t.qBlock.dy,t.qBlock.z+t.qBlock.dz/2);t.qBlock.y!==t.vBlock.y&&(l=new S.AO(c,t.vBlock.y,t.vOutBlock.z+t.vOutBlock.dz/2),i=new S.AO(c,t.vOutBlock.y+t.vOutBlock.dy,t.vOutBlock.z+t.vOutBlock.dz/2)),er(e,"Head ".concat(p),l,i,{color:o,fontSize:10})}{let o=n.mul(t.qBlock.opacity*t.qLabel.visible);er(e,"Q",new S.AO(s,t.qBlock.y,t.qBlock.z+t.qBlock.dz/2),new S.AO(s,t.qBlock.y+t.qBlock.dy,t.qBlock.z+t.qBlock.dz/2),{color:o,fontSize:6,pad:4})}{let o=n.mul(t.kBlock.opacity*t.kLabel.visible);er(e,"K",new S.AO(s,t.kBlock.y,t.kBlock.z+t.kBlock.dz/2),new S.AO(s,t.kBlock.y+t.kBlock.dy,t.kBlock.z+t.kBlock.dz/2),{color:o,fontSize:6,pad:4})}{let o=n.mul(t.vBlock.opacity*t.vLabel.visible);er(e,"V",new S.AO(s,t.vBlock.y,t.vBlock.z+t.vBlock.dz/2),new S.AO(s,t.vBlock.y+t.vBlock.dy,t.vBlock.z+t.vBlock.dz/2),{color:o,fontSize:6,pad:4})}p++}o++}}(t.render,t.layout);let i=1,r=t.render.size.x;for(let e of(t.render.sharedRender.activePhase=eu.i$.Overlay2D,t.display.lines)){let n={color:new S.T8,size:14},o=(0,P.X1)(t.render.modelFontBuf,e,n);(0,P.yU)(t.render.modelFontBuf,e,r-o-4,i*n.size*1.3+4,n),i++}(function(e){let{layout:t,render:n,camera:o}=e,{gl:l,blockRender:i,size:r}=n,{modelMtx:a,viewMtx:s}=o,{camPos:c}=(0,I.aT)(o),u=[new S.AO(100,400,600),new S.AO(-200,-300,-300),new S.AO(200,-100,0)],d=[new S.AO(1,.2,.2),new S.AO(1,.2,.2),new S.AO(1,.2,.2)],f=new Float32Array(9),h=new Float32Array(9);for(let e=0;e<3;e++)a.mulVec3Proj(u[e]).writeToBuf(f,3*e),a.mulVec3Proj(d[e]).writeToBuf(h,3*e);if(l.bindFramebuffer(l.FRAMEBUFFER,null),l.viewport(0,0,r.x,r.y),l.clearColor(0,0,0,0),l.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT),l.enable(l.BLEND),l.blendFunc(l.ONE,l.ONE_MINUS_SRC_ALPHA),l.enable(l.DEPTH_TEST),l.enable(l.CULL_FACE),l.cullFace(l.FRONT),l.frontFace(l.CW),n.renderTiming){let e="GPU: ".concat(n.lastGpuMs.toFixed(1),"ms JS: ").concat(n.lastJsMs.toFixed(1),"ms"),t=r.x;n.sharedRender.activePhase=eu.i$.Overlay2D;let o=(0,P.Ux)(n.modelFontBuf,e,14);(0,P.Dp)(n.modelFontBuf,e,new S.T8(0,0,0,1),t-o-4,4,14,new X.OO)}(0,eu.Md)(n.sharedRender,a,s);{var m;let e,o,l,r,a,s=t.cubes.filter(e=>e.highlight>0);(function(e){let t=e.gl,n=t.canvas.width,o=t.canvas.height,l=Math.floor(n*e.blurFactor),i=Math.floor(o*e.blurFactor);if(e.currViewSize.x!==n||e.currViewSize.y!==o){for(let n of(t.bindTexture(t.TEXTURE_2D,e.initialTex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,l,i,0,t.RGBA,t.UNSIGNED_BYTE,null),e.blurFbos))t.bindTexture(t.TEXTURE_2D,n.tex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,l,i,0,t.RGBA,t.UNSIGNED_BYTE,null);e.currViewSize=new S.AO(n,o)}t.bindFramebuffer(t.FRAMEBUFFER,e.initialFbo),t.viewport(0,0,l,i),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)})(n.blurRender),function(e,t){let n=e.gl;if(!e.simpleShader.ready)return;let o=e.simpleShader.locs,l=e.cubeGeom;for(let i of(n.useProgram(e.simpleShader.program),n.bindVertexArray(l.vao),t)){n.uniform3f(o.u_size,i.dx,i.dy,i.dz),n.uniform3f(o.u_offset,i.x,i.y,i.z);let e=("w"===i.t?new S.T8(.3,.3,1,1):new S.T8(.4,.8,.4,1)).mul(i.highlight);n.uniform4f(o.u_baseColor,e.x,e.y,e.z,e.w),n.drawArrays(l.type,0,l.numVerts)}}(i,s),o=(e=(m=n.blurRender).gl).canvas.width,l=e.canvas.height,r=Math.floor(o*m.blurFactor),a=Math.floor(l*m.blurFactor),e.bindVertexArray(m.quadVao),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.STENCIL_TEST),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,m.initialTex),e.bindFramebuffer(e.FRAMEBUFFER,m.blurFbos[0].fbo),e.viewport(0,0,r,a),e.useProgram(m.horizShader.program),e.uniform1i(m.horizShader.locs.u_texture,0),e.drawArrays(e.TRIANGLE_FAN,0,4),e.bindTexture(e.TEXTURE_2D,m.blurFbos[0].tex),e.bindFramebuffer(e.FRAMEBUFFER,m.blurFbos[1].fbo),e.viewport(0,0,r,a),e.useProgram(m.vertShader.program),e.uniform1i(m.vertShader.locs.u_texture,0),e.drawArrays(e.TRIANGLE_FAN,0,4),e.enable(e.BLEND),e.viewport(0,0,o,l),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,m.blurFbos[1].tex),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,m.initialTex),e.useProgram(m.overlayShader.program),e.uniform1i(m.overlayShader.locs.u_texture,0),e.drawArrays(e.TRIANGLE_FAN,0,4)}for(let r of(l.enable(l.DEPTH_TEST),(0,L.E)(n.lineRender),(0,U.Ht)(n.triRender),(0,P.yk)(n.modelFontBuf),function(e,t,n,o,l,i){let r=e.gl,a=e.shader.locs,s=e.cubeGeom;if(!e.shader.ready)return;r.useProgram(e.shader.program);let c=n.mulVec3Proj(o);r.uniform3f(a.u_camPos,c.x,c.y,c.z),r.uniform1i(a.u_accessSampler,0),r.enable(r.BLEND),r.enable(r.CULL_FACE),r.activeTexture(r.TEXTURE0),r.bindVertexArray(s.vao);let u=[],d=[];t.cubes.forEach(function e(t){t.subs?t.subs.forEach(e):t.opacity<.8&&t.opacity>0?d.push(t):t.opacity>0&&u.push(t)});let f=[...u,...d],h=u.length,m=e.blockUbo.localBufs[0],p=e.blockAccessUbo.localBufs[0];{(0,k.BX)(e.blockUbo),(0,k.tZ)(m,u.length);let t=m.buf;for(let e of f){var x;let n=m.usedEls*m.strideFloats;t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+4]=e.dx,t[n+5]=e.dy,t[n+6]=e.dz,t[n+8]=e.cx,t[n+9]=e.cy,t[n+10]=e.cz,t.set(null!==(x=e.localMtx)&&void 0!==x?x:new X.OO,n+12);let o="w"===e.t?ec.wL.Weights:"i"===e.t?ec.wL.Intermediates:ec.wL.Aggregates;new S.T8(o.x,o.y,o.z,e.opacity).writeToBuf(t,n+28),t[n+32]=e.highlight,m.usedEls+=1}(0,k.Sr)(r,e.blockUbo)}{(0,k.BX)(e.blockAccessUbo),(0,k.tZ)(p,u.length);let t=p.buf;for(let e of f){let n=p.usedEls*p.strideFloats;if(e.access&&!0!==e.access.disable){t.set(e.access.mat.slice(0,8),n);let o=e.access.channel;t[n+8]="r"===o?0:"g"===o?1:"b"===o?2:3,t[n+9]=e.access.scale}else t[n+9]=0;p.usedEls+=1}(0,k.Sr)(r,e.blockAccessUbo)}let y=!0,g=0;for(let t of f){g===h&&r.depthMask(!1),r.bindBufferRange(r.UNIFORM_BUFFER,eu.$c.Block,e.blockUbo.buf,g*m.strideBytes,m.strideBytes);let n=!!t.access&&!0!==t.access.disable;(y||n)&&(r.bindBufferRange(r.UNIFORM_BUFFER,eu.$c.BlockAccess,e.blockAccessUbo.buf,g*p.strideBytes,p.strideBytes),r.bindTexture(r.TEXTURE_2D,n&&t.access?t.access.src.texture:e.dummyTexture),y=n),r.drawArrays(s.type,0,s.numVerts),g++}r.depthMask(!0)}(i,t,a,c,0,0),n.sharedRender.activePhase=eu.i$.Opaque,e.examples))if(r.enabled&&r.layout){let{modelMtx:e,viewMtx:t}=o,{camPos:l}=(0,I.aT)(o);var p=e.mul(X.OO.fromTranslation(r.offset));(0,eu.Md)(n.sharedRender,p,t),function(e,t,n,o){if(!e.instancedShader.ready)return;let l=e.gl,i=e.instancedShader.locs,r=e.blockAccessUbo.localBufs[0];l.useProgram(e.instancedShader.program);let a=n.invert().mulVec3Proj(o);if(l.uniform3f(i.u_camPos,a.x,a.y,a.z),l.uniform1i(i.u_accessSampler,0),l.enable(l.BLEND),l.enable(l.CULL_FACE),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,e.dummyTexture),l.bindVertexArray(e.instancedVao),e.instancedDataStale){e.instancedDataStale=!1;{(0,k.BX)(e.instancedFloatBuf);let n=e.instancedFloatBuf.localBufs[0];(0,k.tZ)(n,t.cubes.length);let o=n.buf;for(let e of t.cubes){var s;if(e.small)continue;let t=n.usedEls*n.strideFloats;o[t+0]=e.x,o[t+1]=e.y,o[t+2]=e.z,o[t+4]=e.dx,o[t+5]=e.dy,o[t+6]=e.dz,o[t+8]=e.cx,o[t+9]=e.cy,o[t+10]=e.cz,o.set(null!==(s=e.localMtx)&&void 0!==s?s:new X.OO,t+12);let l="w"===e.t?ec.wL.Weights:"i"===e.t?ec.wL.Intermediates:ec.wL.Aggregates;new S.T8(l.x,l.y,l.z,e.opacity).writeToBuf(o,t+28),o[t+32]=e.highlight,n.usedEls+=1}(0,k.Sr)(l,e.instancedFloatBuf),e.instancedNumBlocks=n.usedEls}(0,k.BX)(e.blockAccessUbo),(0,k.tZ)(r,1),r.buf[9]=0,r.usedEls+=1,(0,k.Sr)(l,e.blockAccessUbo)}l.bindBufferRange(l.UNIFORM_BUFFER,eu.$c.BlockAccess,e.blockAccessUbo.buf,0,r.strideBytes),l.drawArraysInstanced(e.cubeGeom.type,0,e.cubeGeom.numVerts,e.instancedNumBlocks),l.depthMask(!0)}(r.blockRender,r.layout,p,l)}for(let e of((0,eu.Md)(n.sharedRender,a,s),(0,ef.QD)(n.threadRender),l.polygonOffset(-1,-2),[eu.i$.Opaque,eu.i$.Arrows,eu.i$.Overlay,eu.i$.Overlay2D])){if(e===eu.i$.Overlay2D){let e=r.x,t=r.y;l.clear(l.DEPTH_BUFFER_BIT),(0,eu.Md)(n.sharedRender,new X.OO,X.OO.fromOrtho(0,e,t,0,-1,1))}e===eu.i$.Overlay||e===eu.i$.Overlay2D?l.enable(l.POLYGON_OFFSET_FILL):l.disable(l.POLYGON_OFFSET_FILL),(0,U.O8)(n.triRender,e),(0,P.b1)(n.modelFontBuf,e),(0,L.fJ)(n.lineRender,e)}l.disable(l.POLYGON_OFFSET_FILL)})(t),function(e,t){if(!e.ctx.ext.disjointTimerQuery)return;let n=e.queries.get(t);n&&n.hasRun&&n.hasStarted&&(e.ctx.gl.endQuery(e.TIME_ELAPSED_EXT),n.hasStarted=!1)}(t.render.queryManager,"render"),t.render.gl.flush(),t.render.lastJsMs=performance.now()-o}({time:e,dt:t,markDirty:this.markDirty},this.progState),this.progState.htmlSubs.notify()}constructor(e,t,n){this.canvasData=t,this.modelState=null,this.stopped=!1,this.canvasSizeDirty=!0,this.prevTime=performance.now(),this.rafHandle=0,this.isDirty=!1,this.isWaitingForSync=!1,this.markDirty=()=>{this.canvasData&&!this.stopped&&(this.isDirty=!0,this.rafHandle||(this.prevTime=performance.now(),this.rafHandle=requestAnimationFrame(this.loop)))},this.loop=e=>{var t,n,o,l;if(!(this.isDirty||this.isWaitingForSync)||this.stopped){this.rafHandle=0;return}let i=this.isDirty;this.isDirty=!1,this.isWaitingForSync=!1;let r=e-this.prevTime;this.prevTime=e,r<8&&(r=16),this.checkSyncObjects();let a=null!==(o=null===(t=this.progState.render)||void 0===t?void 0:t.syncObjects.length)&&void 0!==o?o:0;(i||this.isDirty)&&this.render(e,r),(null!==(l=null===(n=this.progState.render)||void 0===n?void 0:n.syncObjects.length)&&void 0!==l?l:0)!==a&&(this.isWaitingForSync=!0),this.rafHandle=requestAnimationFrame(this.loop)},this.progState=function(e,t){var n,o,l,i,r;let a=function(e,t){var n;let o=e.getContext("webgl2",{antialias:!0});if(!o)return null;let l={colorBufferFloat:o.getExtension("EXT_color_buffer_float"),disjointTimerQuery:o.getExtension("EXT_disjoint_timer_query_webgl2")};l.colorBufferFloat||console.log("initRender: EXT_color_buffer_float not supported: floating point textures will not work."),l.disjointTimerQuery||console.log("initRender: EXT_disjoint_timer_query_webgl2 not supported: GPU timing will not work.");let i=(0,k.mD)(o),r={gl:o,shaderManager:i,ext:l},a=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,a),o.bufferData(o.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),o.STATIC_DRAW);let s=o.createVertexArray();o.bindVertexArray(s),o.enableVertexAttribArray(0),o.vertexAttribPointer(0,2,o.FLOAT,!1,0,0);let c=(0,eu.$7)(r),u=(0,P.C1)(r,t),d=(0,P.WY)(u,c),f=(0,ef.fg)(r),h=(0,L.zi)(r,c),m=ed(r),p=(0,U.HI)(r,c),x=function(e,t){let n=e.gl,o=Math.max(n.canvas.width,1),l=Math.max(n.canvas.height,1),i=n.createFramebuffer(),r=n.createTexture();function a(){let e=n.createFramebuffer(),t=n.createTexture();n.bindFramebuffer(n.FRAMEBUFFER,e),n.bindTexture(n.TEXTURE_2D,t),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,o,l,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0);{let e=n.checkFramebufferStatus(n.FRAMEBUFFER);e!==n.FRAMEBUFFER_COMPLETE&&console.log("Blur framebuffer not complete: ".concat(e.toString(16)))}return{fbo:e,tex:t}}n.bindFramebuffer(n.FRAMEBUFFER,i),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,o,l,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,r,0);let s=[a(),a()],c=new Float32Array(36),u=0;for(let e=-4;e<=4;e++){let t=e/2,n=Math.exp(-t*t*.5);c[4*(e+4)]=n,u+=n}for(let e=0;e<9;e++)c[4*e]/=u;let d=n.createBuffer();function f(t,n){return(0,k.tQ)(e.shaderManager,t,"#version 300 es\n            precision highp float;\n            layout(location = 0) in vec2 a_position;\n            void main() {\n                gl_Position = vec4(a_position, 0, 1);\n            }\n        ","#version 300 es\n            precision highp float;\n\n            layout(std140) uniform BlurWeights {\n                float weights[".concat(9,"];\n            };\n\n            uniform sampler2D u_texture;\n            out vec4 o_color;\n\n            void main() {\n                ivec2 pos = ivec2(gl_FragCoord.xy);\n                vec4 color = vec4(0);\n                vec4 center = texelFetch(u_texture, pos, 0);\n                for (int i = -").concat(4,"; i <= ").concat(4,"; i++) {\n                    int wId = i + ").concat(4,";\n                    color += texelFetch(u_texture, pos + ivec2(").concat(n===S.JU.X?"i, 0":"0, i",") * ").concat(2,", 0) * weights[wId];\n                }\n                o_color = max(color, center);\n            }\n        "),["u_texture"],{uboBindings:{BlurWeights:eu.$c.blur}})}return n.bindBuffer(n.UNIFORM_BUFFER,d),n.bufferData(n.UNIFORM_BUFFER,c.buffer,n.STATIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,eu.$c.blur,d),{gl:n,quadVao:t,initialFbo:i,initialTex:r,blurFbos:s,horizShader:f("blurHoriz",S.JU.X),vertShader:f("blurVert",S.JU.Y),overlayShader:(0,k.tQ)(e.shaderManager,"blurOverlay","#version 300 es\n            precision highp float;\n            layout(location = 0) in vec2 a_position;\n            out vec2 v_uv;\n            void main() {\n                gl_Position = vec4(a_position, 0, 1);\n                v_uv = a_position * 0.5 + 0.5;\n            }\n        ","#version 300 es\n            precision highp float;\n            uniform sampler2D u_texture;\n            uniform sampler2D u_initTexture;\n            in vec2 v_uv;\n            out vec4 o_color;\n\n            void main() {\n                ivec2 pos = ivec2(gl_FragCoord.xy);\n                vec4 blurColor = texture(u_texture, v_uv);\n                // vec4 initColor = texture(u_initTexture, v_uv);\n\n                vec4 base = vec4(0.9, 0.9, 0.9, 0.1);\n                // if (blurColor.a == 0.0) {\n                //     blurColor = vec4(0.1, 0.1, 0.1, 1.0);\n                // }\n                o_color = blurColor; // + initColor * (1.0 - blurColor.a);\n                // o_color = initColor;\n            }\n        ",["u_texture"]),currViewSize:new S.AO(0,0),blurFactor:.3}}(r,s),y={ctx:r,queries:new Map,TIME_ELAPSED_EXT:null===(n=r.ext.disjointTimerQuery)||void 0===n?void 0:n.TIME_ELAPSED_EXT};return(0,k.OM)(i),{canvasEl:e,gl:o,ctx:r,blockRender:m,threadRender:f,lineRender:h,blurRender:x,triRender:p,sharedRender:c,fontAtlas:u,modelFontBuf:d,quadVao:s,queryManager:y,syncObjects:[],size:new S.AO(1,1),lastGpuMs:0,lastJsMs:0,renderTiming:!1}}(e,t),s=(0,em.Mw)(),c=eh.N.state,u={angle:null!==(n=null==c?void 0:c.camera.angle)&&void 0!==n?n:new S.AO(296,16,13.5),center:null!==(o=null==c?void 0:c.camera.center)&&void 0!==o?o:new S.AO(-8.4,0,-481.5),transition:{},modelMtx:new X.OO,viewMtx:new X.OO,lookAtMtx:new X.OO,camPos:new S.AO,camPosModel:new S.AO},d={B:1,T:11,C:48,nHeads:3,A:16,nBlocks:3,vocabSize:3};function f(e,t){return{center:e,angle:t}}let h=new S.AO(1e4,0,0);return{native:null,wasmGptModel:null,render:a,inWalkthrough:!0,walkthrough:s,camera:u,shape:d,layout:(0,es.nb)(d),currExampleId:-1,mainExample:{name:"nano-gpt",enabled:!0,shape:d,offset:new S.AO,modelCardOffset:new S.AO,blockRender:null,camera:f(new S.AO(42.771,0,-569.287),new S.AO(284.959,26.501,12.867))},examples:[{name:"GPT-2 (small)",enabled:!0,shape:{B:1,T:1024,C:768,nHeads:12,A:64,nBlocks:12,vocabSize:50257},offset:h.mul(-5),modelCardOffset:h.mul(-2),blockRender:ed(null!==(l=null==a?void 0:a.ctx)&&void 0!==l?l:null),camera:f(new S.AO(-65141.321,0,-69843.439),new S.AO(224.459,24.501,1574.24))},{name:"GPT-2 (XL)",enabled:!0,shape:{B:1,T:1024,C:1600,nHeads:25,A:64,nBlocks:48,vocabSize:50257},offset:h.mul(20),modelCardOffset:h.mul(.5),blockRender:ed(null!==(i=null==a?void 0:a.ctx)&&void 0!==i?i:null),camera:f(new S.AO(237902.688,0,-47282.484),new S.AO(311.959,23.501,1382.449))},{name:"GPT-3",enabled:!1,shape:{B:1,T:1024,C:12288,nHeads:96,A:128,nBlocks:96,vocabSize:50257},offset:h.mul(50),modelCardOffset:h.mul(15),blockRender:ed(null!==(r=null==a?void 0:a.ctx)&&void 0!==r?r:null),camera:f(new S.AO(837678.163,0,-485242.286),new S.AO(238.959,10.501,12583.939))}],gptGpuModel:null,jsGptModel:null,stepModel:!1,markDirty:()=>{},htmlSubs:new ek.tH,mouse:{mousePos:new S.AO},movement:{action:null,actionHover:null,target:[0,0],depth:1,cameraLerp:null},display:{tokenColors:null,tokenIdxColors:null,tokenOutputColors:null,lines:[],hoverTarget:null,dimHover:null,blkIdxHover:null},pageLayout:{height:0,width:0,isDesktop:!0,isPhone:!0}}}(e,n),this.progState.markDirty=this.markDirty,this.progState.walkthrough.markDirty=this.markDirty,this.renderState=this.progState.render,this.random=new F.k(4)}}},7145:function(e,t,n){"use strict";n.d(t,{S:function(){return f},b:function(){return d}});var o=n(7437),l=n(2265),i=n(3426),r=n.n(i),a=n(1074),s=n(9107),c=n(6554),u=n(2261);let d=()=>{let e=(0,a.f9)(),t=e.walkthrough,[n,i]=(0,l.useState)(null),[u,d]=(0,l.useState)(null),[,f]=(0,l.useReducer)(e=>e+1,0);e.camera;let h=t.phaseLength,m=e=>(0,s.uZ)(e/h,0,1),[p,x]=(0,c.gU)(u,()=>t.time,function(e,o){let l=e.clientY-o.clientY,i=n.clientHeight;t.time=(0,s.uZ)(o.data+l/i*h,0,h),t.running=!1,e.preventDefault(),e.stopPropagation(),t.markDirty(),f()});return(0,o.jsxs)("div",{className:r().timelineBase,ref:i,children:[(0,o.jsx)("div",{className:r().timelineLine}),t.times.map((e,t)=>(0,o.jsxs)("div",{className:r().timelineEvt,style:{top:"".concat(100*m(e.start),"%"),height:"".concat(100*m(e.duration),"%")},children:[(0,o.jsx)("div",{className:r().timelineEvtStart}),(0,o.jsx)("div",{className:r().timelineEvtEnd})]},t)),(0,o.jsx)("div",{className:r().timelineCaret,style:{top:"".concat(100*m(t.time),"%")}}),(0,o.jsx)("div",{ref:d,className:r().timelineCaretHit,style:{top:"".concat(100*m(t.time),"%")},onMouseDown:e=>{e.preventDefault(),e.stopPropagation(),x(e)}})]})},f=e=>{let{times:t}=e,n=(0,a.f9)().walkthrough,[i,d]=(0,l.useState)(null),[f,h]=(0,l.useState)(null),[,m]=(0,l.useReducer)(e=>e+1,0),p=t[0].start,x=(0,u.Yp)(t[t.length-1])-t[0].start,y=n.time>=p&&n.time<=p+x,g=e=>(0,s.uZ)((e-p)/x,0,1),[v,b]=(0,c.gU)(f,()=>n.time,function(e,t){let o=e.clientX-t.clientX,l=i.clientWidth;n.time=(0,s.uZ)(t.data+o/l*x,p,p+x),n.running=!1,e.preventDefault(),e.stopPropagation(),n.markDirty(),m()}),[,w]=(0,c.gU)(i,()=>n.time,function(e,t){let o=i.clientWidth,l=e.clientX-i.getBoundingClientRect().left;n.time=(0,s.uZ)(p+l/o*x,p,p+x),n.running=!1,e.preventDefault(),e.stopPropagation(),n.markDirty(),m()});return(0,o.jsxs)("div",{className:r().timelineBaseHoriz,ref:d,onMouseDown:e=>{e.preventDefault(),e.stopPropagation(),w(e)},children:[(0,o.jsx)("div",{className:r().timelineLineHoriz}),t.map((e,t)=>(0,o.jsxs)("div",{className:r().timelineEvtHoriz,style:{left:"".concat(100*g(e.start),"%"),width:"".concat(100*g(e.duration),"%")},children:[(0,o.jsx)("div",{className:r().timelineEvtStartHoriz}),(0,o.jsx)("div",{className:r().timelineEvtEndHoriz})]},t)),y&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:r().timelineCaretHoriz,style:{left:"".concat(100*g(n.time),"%")}}),(0,o.jsx)("div",{className:r().timelineCaretHitHoriz,ref:h,style:{left:"".concat(100*g(n.time),"%")},onMouseDown:e=>{e.preventDefault(),e.stopPropagation(),b(e)}})]})]})}},2850:function(e,t,n){"use strict";n.d(t,{N:function(){return o}});let o={state:null}},1074:function(e,t,n){"use strict";n.d(t,{U$:function(){return d},f9:function(){return h},nG:function(){return f}});var o=n(7437),l=n(2008),i=n.n(l),r=n(2265),a=n(7042),s=n(7145),c=n(4415),u=n(2348);let d=()=>{let e=h(),t=e.walkthrough;e.camera;let[n,l]=(0,r.useState)(!1),[u,d]=(0,r.useState)(null);return o.Fragment,i().topSplit,i().toc,t.phaseList.map((n,r)=>(0,o.jsxs)("div",{className:i().phaseGroup,children:[(0,o.jsx)("div",{className:i().phaseGroupTitle,children:n.title}),n.phases.map((n,r)=>{let s=t.phase===n.id;return(0,o.jsx)("div",{className:(0,a.Z)(i().phase,s&&i().active),onClick:o=>{t.phase!==n.id&&(t.phase=n.id,t.time=0,t.running=!1,e.markDirty()),l(!1),o.preventDefault()},children:(0,o.jsx)("div",{className:i().phaseTitle,children:n.title})},n.id)})]},n.groupId)),(0,o.jsx)("div",{className:i().walkthrough,children:(0,o.jsxs)("div",{className:i().split,children:[(0,o.jsx)("div",{className:i().timelineLeft,children:(0,o.jsx)(s.b,{})}),(0,o.jsx)("div",{className:i().content,children:(0,o.jsx)(c.Gk,{})})]})})},f=(0,r.createContext)(null);function h(){let e=(0,r.useContext)(f);return(0,u.Pd)(null==e?void 0:e.htmlSubs),e}},3786:function(e,t,n){"use strict";n.r(t),n.d(t,{InfoButton:function(){return g},WelcomePopup:function(){return x}});var o=n(7437),l=n(2265),i=n(7188),r=n(1279),a=n(9107),s=n(6425),c=n(2019),u=n(9225),d=n(3010),f=n.n(d),h=n(7004),m=n(2348);function p(e){var t;return{visible:null===(t=null==e?void 0:e.visible)||void 0===t||t}}let x=()=>{let e=(0,l.useContext)(y);(0,m.Pd)(e.subscriptions);let[t,n]=(0,c.Rr)("welcome-popup",p);function i(){n(e=>(0,a.v4)(e,{visible:!1}))}return((0,s.qi)(s.Cf.Modal,e=>{"Escape"===e.key&&i(),e.stopPropagation()}),(0,l.useEffect)(()=>{e.forceVisible&&(e.forceVisible=!1,n(e=>(0,a.v4)(e,{visible:!0})))},[e,n,e.forceVisible]),t.visible)?(0,o.jsxs)(u.Du,{className:f().modalWindow,backdropClassName:f().modalWindowBackdrop,onBackdropClick:i,children:[(0,o.jsx)("div",{className:f().header,children:(0,o.jsx)("div",{className:f().title,children:"Welcome!"})}),(0,o.jsxs)("div",{className:f().body,children:[(0,o.jsx)("div",{style:{width:600,flex:"0 0 auto"},children:(0,o.jsx)(h.X,{activePhase:null,onEnterPhase:i})}),(0,o.jsxs)("div",{className:f().text,children:[(0,o.jsx)("p",{children:"This is an interactive 3D Visualization of a Large Language Model (LLM), of the likes that powers GPT-3 & ChatGPT."}),(0,o.jsx)("p",{children:"We show a very small model of the same design, to help you understand how these models work."}),(0,o.jsx)("p",{children:"As well as being interactive, we provide a walkthrough of the model showing the step-by-step process of how it works, with every single add, multiply & math operation described."})]})]}),(0,o.jsx)("div",{className:f().footer,children:(0,o.jsx)("button",{className:f().button,onClick:i,children:"Get Started"})})]}):null},y=(0,l.createContext)(new class{showWelcomeDialog(){this.forceVisible=!0,this.subscriptions.notify()}constructor(){this.subscriptions=new m.tH,this.forceVisible=!1}}),g=()=>{let e=(0,l.useContext)(y);return(0,o.jsx)("div",{onClick:()=>e.showWelcomeDialog(),className:f().infoBtn,children:(0,o.jsx)(r.G,{icon:i.FDd})})}},6875:function(e,t,n){"use strict";n.d(t,{T:function(){return s},v:function(){return a}});var o=n(7437);n(2265);var l=n(2261),i=n(1074),r=n(9107);let a=e=>{let{dim:t,style:n,children:r}=e,a=(0,i.f9)();function s(e){a.display.dimHover=e?t:null,a.markDirty()}let c=a.display.dimHover===t;return(0,o.jsx)("span",{style:{...n,textShadow:c?"0 0 0.5em ".concat((0,l.c6)(t).toHexColor()):void 0},onMouseEnter:()=>s(!0),onMouseLeave:()=>s(!1),children:r})},s=e=>{var t,n,a;let{blk:s,style:c,children:u}=e,d=(0,i.f9)(),f=Array.isArray(s)?s:[s],h=f[0],m="i"===h.t?l.Zy.Intermediates:"w"===h.t?l.Zy.Weights:l.Zy.Aggregates,p=(0,l.c6)(m).toHexColor();function x(e){d.display.blkIdxHover=e?f.map(e=>e.idx):null,d.markDirty()}let y=null!==(n=d.display.blkIdxHover)&&void 0!==n?n:[null===(t=d.display.hoverTarget)||void 0===t?void 0:t.mainCube.idx].filter(r.DX),g=y.length>0&&y.includes(h.idx);return(0,o.jsx)("span",{style:{color:p,textShadow:g?"0 0 0.5em ".concat(null!==(a=null==c?void 0:c.color)&&void 0!==a?a:p):void 0,...c},onMouseEnter:()=>x(!0),onMouseLeave:()=>x(!1),children:u})}},4485:function(e,t,n){"use strict";n.d(t,{QP:function(){return T},_n:function(){return k},iW:function(){return y}});var o=n(4230),l=n(3014),i=n(7917),r=n(7898),a=n(6350),s=n(7361),c=n(5429),u=n(9107),d=n(1280),f=n(9073),h=n(9158),m=n(2261),p=n(7717),x=n(6285);function y(e,t,n,y){if(!t.deps)return;let B=e.render.sharedRender.activePhase;e.render.sharedRender.activePhase=s.i$.Overlay2D,y=null!=y?y:n;let E=new h.AO((0,l.pu)(e.layout,t,h.JU.X,y.x)+.5*e.layout.cell,(0,l.pu)(e.layout,t,h.JU.Y,y.y)+.5*e.layout.cell,(0,l.pu)(e.layout,t,h.JU.Z,y.z)+1.1*e.layout.cell),R=new f.OO,M={state:e,center:g(e,E).round_().add(new h.AO(0,-50)),blk:t,destIdx:n,mtx:R},P=new h.bR;if(t.deps.lowerTri&&n.x>n.y?function(e){let{center:t,mtx:n}=e;return O(e,t,(0,x.fP)({opts:{color:w,mtx:n,size:16},subs:[{text:"-"}]}))}(M):t.deps.special===l.R3.InputEmbed?P=function(e){let{center:t,mtx:n}=e;return O(e,t,(0,x.fP)({opts:{color:A,mtx:n,size:16},subs:[{type:x.C5.Custom,draw:t=>(function(e,t){let{state:n,center:o,destIdx:l,mtx:i}=e,r=k(n.layout.idxObj,new h.AO(l.x,0,l.z)),s=(0,u.DX)(r)?r/(n.layout.tokEmbedObj.cx-1):.3,f=l.y/(n.layout.residual0.cy-1);o.add(new h.AO(-35,-20,0));let y=m.wL.Weights,g=t.add(new h.AO(40,30));(0,p.bk)(n.render,t,g,(0,a.HP)({color:y,mtx:i,n:new h.AO(0,0,1),thick:.4})),(0,c.bE)(n.render.triRender,t,g,_,i);let v=new h.AO(t.x+(0,d.t7)(0,g.x-t.x-8,s),t.y),b=new h.AO(v.x+8,g.y),w=new h.AO(v.x,v.y+(0,d.t7)(0,g.y-t.y-8,f)),A=new h.AO(b.x,w.y+8);(0,c.bE)(n.render.triRender,v,b,y.mul(.3),i),(0,c.bE)(n.render.triRender,w,A,y,i);let T=m.wL.Intermediates,O=v.x+4,B=v.y-5,z=g.x,E=new Float32Array([z,B-10,0,O,B-10,0,O,B,0]),R=(0,a.HP)({color:T,mtx:i,n:new h.AO(0,0,1),thick:.5});(0,a.cc)(n.render.lineRender,E,R),(0,x.Aj)(n.render,new h.AO(1,1),new h.AO(z+8,B-10),new h.AO(7,7),m.wL.Intermediates,i)})(e,t.offset),size:new h.AO(40,30)},{text:" + "},{type:x.C5.Custom,draw:t=>(function(e,t){let{state:n,center:o,destIdx:l,mtx:i}=e,s=l.x/(n.layout.posEmbedObj.cx-1),u=l.y/(n.layout.residual0.cy-1);o.add(new h.AO(35,-20,0));let f=m.wL.Weights,x=t.add(new h.AO(40,30));(0,p.bk)(n.render,t,x,(0,a.HP)({color:f,mtx:i,n:new h.AO(0,0,1),thick:.4})),(0,c.bE)(n.render.triRender,t,x,_,i);let y=new h.AO(t.x+(0,d.t7)(0,x.x-t.x-8,s),t.y),g=new h.AO(y.x+8,x.y),v=new h.AO(y.x,y.y+(0,d.t7)(0,x.y-t.y-8,u)),b=new h.AO(g.x,v.y+8);(0,c.bE)(n.render.triRender,y,g,f.mul(.3),i),(0,c.bE)(n.render.triRender,v,b,f,i);let w={color:new h.T8(1,1,1,1).mul(.8),mtx:i,size:20},A=(0,r.X1)(n.render.modelFontBuf,"t",w);(0,r.yU)(n.render.modelFontBuf,"t",(v.x+b.x)/2-A/2,y.y-3-w.size,w)})(e,t.offset),size:new h.AO(35,30)}]}),[20,0,0,0])}(M):t.deps.special===l.R3.LayerNorm?P=function(e){let{center:t,mtx:n}=e;return O(e,t,(0,x.fP)({opts:{color:w,mtx:n,size:16},subs:[{type:x.C5.Divide,subs:[{subs:[{cellX:1,cellY:1,color:b},{text:" — "},{type:x.C5.Line,rectOpts:{color:m.wL.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"E[",color:b},{cellX:1,cellY:3,color:b},{text:"]",color:b}]}]},{type:x.C5.Line,rectOpts:{color:m.wL.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{type:x.C5.Sqrt,subs:[{type:x.C5.Line,subs:[{text:"Var[",color:b},{cellX:1,cellY:3,color:b},{text:"]",color:b},{text:" + ε"}]}]}]}]},{text:"  ‧ "},{text:"γ",color:v},{text:" + "},{text:"β",color:v}]}))}(M):t.deps.special===l.R3.LayerNormMu?P=function(e){let{center:t,mtx:n}=e;return O(e,t,(0,x.fP)({opts:{color:w,mtx:n,size:16},subs:[{text:"E[",color:b},{cellX:1,cellY:3,color:b},{text:"]",color:b}]}))}(M):t.deps.special===l.R3.LayerNormSigma?P=function(e){let{center:t,mtx:n}=e;return O(e,t,(0,x.fP)({opts:{color:w,mtx:n,size:16},subs:[{type:x.C5.Sqrt,subs:[{type:x.C5.Line,subs:[{text:"Var[",color:b},{cellX:1,cellY:3,color:b},{text:"]",color:b},{text:" + ε"}]}]}]}))}(M):t.deps.special===l.R3.SoftmaxAggMax?P=function(e){let{center:t,mtx:n}=e;return O(e,t,(0,x.fP)({opts:{color:w,mtx:n,size:16},subs:[{text:"max("},{cellX:3,cellY:1,color:b},{text:")"}]}))}(M):t.deps.special===l.R3.SoftmaxAggExp?P=function(e){let{center:t,mtx:n}=e,o={color:w,mtx:n,size:16};return O(e,t,(0,x.fP)({opts:o,subs:[{text:"Σ",opts:{...o,size:1.5*o.size}},{text:"exp("},{cellX:1,cellY:1,color:b},{text:" - "},{type:x.C5.Line,rectOpts:{color:m.wL.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"max("},{cellX:3,cellY:1,color:b},{text:")"}]},{text:")"}]}))}(M):t.deps.special===l.R3.Softmax?P=function(e){let{center:t,mtx:n}=e,o={color:w,mtx:n,size:16};return O(e,t,(0,x.fP)({opts:o,subs:[{type:x.C5.Divide,subs:[{subs:[{text:"exp("},{cellX:1,cellY:1,color:b},{text:" - "},{rectOpts:{color:m.wL.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"max("},{cellX:3,cellY:1,color:b},{text:")"}]},{text:")"}]},{type:x.C5.Line,rectOpts:{color:m.wL.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"Σ",opts:{...o,size:1.5*o.size}},{text:"exp("},{cellX:1,cellY:1,color:b},{text:" - "},{type:x.C5.Line,subs:[{text:"max("},{cellX:3,cellY:1,color:b},{text:")"}]},{text:")"}]}]}]}))}(M):t.deps.special===l.R3.Attention?P=function(e){let{center:t,mtx:n,blk:o}=e,l=o.deps.dot[0],i=o.deps.dot[1];function r(e){let t=1===e.srcIdxMtx.g(0,3);return{cellX:t?4:1,cellY:t?1:4,color:"w"===e.src.t?v:b}}return O(e,t,(0,x.fP)({opts:{color:w,mtx:n,size:16},subs:[{text:"dot("},r(l),{text:","},r(i),{text:") / "},{type:x.C5.Sqrt,subs:[{text:"A"}]}]}))}(M):t.deps.special===l.R3.Gelu?P=function(e){let{state:t,center:n,mtx:o,blk:l,destIdx:i}=e,r=e=>.5*e*(1+Math.tanh(Math.sqrt(2/Math.PI)*(e+.044715*e*e*e))),s=n.sub(new h.AO(35,50,0)),c=n.add(new h.AO(35,0,0));T(t.render,s,c,_,o,4);let d=z(s.x,c.x,-3,3),f=z(c.y,s.y,-.9428571428571428,2.142857142857143+1.2),p=new Float32Array(90);for(let e=0;e<30;e++){let t=-3+6*e/29,n=r(t);p[3*e+0]=d(t),p[3*e+1]=f(n)}let x=(0,a.HP)({color:new h.T8(.5,.5,.5,1),mtx:o,thick:1.5});(0,a.Q)(t.render.lineRender,new h.AO(s.x,f(0)),new h.AO(c.x,f(0)),x),(0,a.Q)(t.render.lineRender,new h.AO(d(0),s.y),new h.AO(d(0),c.y),x);let y=(0,a.HP)({color:m.wL.Intermediates,mtx:o,thick:3.5});(0,a.cc)(t.render.lineRender,p,y);let g=k(l.deps.add[0].src,i);if((0,u.DX)(g)){let e=r(g);!function(e,t,n,o,l,i){let r=new Float32Array(90);for(let e=0;e<30;e++){let o=e/30*Math.PI*2;r[3*e+0]=t.x+Math.cos(o)*n,r[3*e+1]=t.y+Math.sin(o)*n,r[3*e+2]=t.z}(0,a.cc)(e.lineRender,r,(0,a.HP)({color:l,n:new h.AO(0,0,1),thick:1,closed:!0,mtx:i}))}(t.render,new h.AO(d(g),f(e)),2,0,m.wL.Intermediates,o)}return new h.bR(s,c)}(M):t.deps.dot?P=function(e){let{center:t,mtx:n,blk:o}=e,l=!!o.deps.add,i=o.deps.dot[0],r=o.deps.dot[1];function a(e){let t=1===e.srcIdxMtx.g(0,3);return{cellX:t?4:1,cellY:t?1:4,color:"w"===e.src.t?v:b}}return O(e,t,(0,x.fP)({opts:{color:w,mtx:n,size:16},subs:[l?{cellX:1,cellY:1,color:v}:null,l?{text:" + dot("}:{text:"dot("},a(i),{text:","},a(r),{text:")"}].filter(u.DX)}))}(M):t.deps.add&&2===t.deps.add.length&&(P=function(e){let{center:t,mtx:n}=e,o={color:w,mtx:n,size:16};return O(e,t,(0,x.fP)({opts:o,subs:[{cellX:1,cellY:1,opts:{...o,color:b}},{text:" + "},{cellX:1,cellY:1,opts:{...o,color:b}}]}))}(M)),!P.empty){let e=function(e,t){let{center:n,mtx:o,blk:l,destIdx:i}=e,r={color:w,mtx:o,size:14};function a(e,t){if(e===m.Zy.None)return null;let n=i.getAt(t),o=(0,m.c6)(e);return{text:"".concat((0,m.oB)(e),": ").concat(n),color:o}}let s=a(l.dimX,0),c=a(l.dimY,1),u=(0,x.fP)({opts:r,subs:[s,s&&c&&{text:", "},c]});(0,x.k)(e.state.render,u),u.offset=new h.AO(e.center.x-u.size.x/2,t.min.y-1.2*r.size-4,0),(0,x.YA)(u);let d=u.offset.sub(new h.AO(4,4)),f=u.offset.add(u.size).add(new h.AO(8,8));return T(e.state.render,d,f,_,o,4),(0,x.sg)(e.state.render,u),new h.bR(d,f)}(M,P),t=new h.bR(P.min,P.max,e.min,e.max);!function(e,t){let{state:n,mtx:r,blk:s,destIdx:c}=e;if(s.deps){if(s.deps.add)for(let e of s.deps.add)u(e);if(s.deps.dot){let e=(0,i.Ui)(s,c);for(let t of s.deps.dot)u(t,e)}f(s,c,new h.T8(0,0,0,1),!0)}function u(t,r){var a;let{srcIdx:u,otherDim:d,isDot:p}=(0,i.XZ)(t,c);if(0===t.src.opacity)return;if(p){let{cx:e}=(0,o.gW)(t.src,d);u.setAt(d,(null!=r?r:e)/2)}if((null===(a=s.deps)||void 0===a?void 0:a.special)===l.R3.InputEmbed&&t.src===e.state.layout.tokEmbedObj){let e=k(n.layout.idxObj,new h.AO(c.x,0,c.z));u.setAt(h.JU.X,null!=e?e:0)}let x=t.src.t,y="w"===x?m.wL.Weights:"i"===x?m.wL.Intermediates:m.wL.Aggregates;f(t.src,u,y,!1)}function f(e,o,i,s){let c=new h.AO((0,l.pu)(n.layout,e,h.JU.X,o.x)+.5*n.layout.cell,(0,l.pu)(n.layout,e,h.JU.Y,o.y)+.5*n.layout.cell,(0,l.pu)(n.layout,e,h.JU.Z,o.z)+1.1*n.layout.cell);(0,a.HP)({n:new h.AO(0,0,1),color:i,mtx:r,thick:.5,dash:10});let u=g(n,c),f=t.center(),m=u.sub(f).normalize(),p=[(t.min.x-f.x)/m.x,(t.max.x-f.x)/m.x,(t.min.y-f.y)/m.y,(t.max.y-f.y)/m.y],x=null;for(let e of p){let n=f.mulAdd(m,e);if(e>0&&n.x>t.min.x-1e-5&&n.y>t.min.y-1e-5&&n.x<t.max.x+1e-5&&n.y<t.max.y+1e-5){x=f.mulAdd(m,e+4);break}}if(x){if(s){let e=u;u=x,x=e}!function(e,t,n,o,l,i){let r=n.sub(t).normalize(),s=h.AO.cross(r,new h.AO(0,0,1)).normalize(),c=t.lerp(n,.5).add(s.mul(-2*t.dist(n))),u=t.dist(c),f=Math.atan2(n.y-c.y,n.x-c.x),m=Math.atan2(t.y-c.y,t.x-c.x);f<m&&(f+=2*Math.PI),f-m>Math.PI&&(f-=2*Math.PI);let p=(0,a.HP)({color:o,mtx:l,thick:1,dash:0}),x=new Float32Array(96);for(let e=0;e<32;e++){let t=e/31,n=(0,d.t7)(m,f,t),o=c.x+u*Math.cos(n),l=c.y+u*Math.sin(n);x[3*e+0]=o,x[3*e+1]=l}(0,a.cc)(e.render.lineRender,x,p);let y=new h.AO(Math.sin(f),-Math.cos(f)),g=y.rotateAbout(new h.AO(0,0,1),-(.25*Math.PI)),v=y.rotateAbout(new h.AO(0,0,1),.25*Math.PI);(0,a.Q)(e.render.lineRender,n,n.mulAdd(g,10),p),(0,a.Q)(e.render.lineRender,n,n.mulAdd(v,10),p)}(n,u,x,i,r,0)}}}(M,t)}e.render.sharedRender.activePhase=B}function g(e,t){let n=e.camera.modelMtx,o=e.camera.viewMtx.mulVec3Proj(n.mulVec3Affine(t));return new h.AO((o.x+1)*.5*e.render.size.x,(1-o.y)*.5*e.render.size.y,0)}let v=new h.T8(.4,.4,.9,1),b=new h.T8(.3,.7,.3,1),w=new h.T8(.9,.9,.9,1),_=new h.T8(0,0,0,1).mul(1),A=new h.T8(1,1,1,1);function k(e,t){var n;let o=null===(n=e.access)||void 0===n?void 0:n.src.localBuffer;if(!e.access||!o)return null;let l=e.access.src,i=e.access.mat.mulVec4(new h.T8(t.x,t.y,t.z,1)),r="r"===e.access.channel?0:"g"===e.access.channel?1:"b"===e.access.channel?2:3;return o[i.y*l.width*l.channels+i.x*l.channels+r]}function T(e,t,n,o,l,i){if(0===i){(0,c.bE)(e.triRender,t,n,o,l);return}i=Math.min(i,(n.x-t.x)/2,(n.y-t.y)/2);let r=new h.AO(0,0,1),a=t.add(new h.AO(i,i)),s=n.sub(new h.AO(i,i));(0,c.bE)(e.triRender,a,s,o,l),(0,c.fe)(e.triRender,new h.AO(s.x,n.y),o,r,l),(0,c.fe)(e.triRender,new h.AO(s.x,s.y),o,r,l);for(let t=0;t<4;t++){let n=new h.AO(t<2?a.x:s.x,(t+1)%4<2?s.y:a.y),u=(t+1)%4*Math.PI/2;for(let t=0;t<7;t++){let a=new h.AO(n.x+i*Math.cos(u+t*Math.PI/6/2),n.y+i*Math.sin(u+t*Math.PI/6/2));(0,c.fe)(e.triRender,a,o,r,l),(0,c.fe)(e.triRender,n,o,r,l)}}(0,c.rI)(e.triRender)}function O(e,t,n,l){let{state:i,mtx:r}=e,a=k(e.blk,e.destIdx);n.type===x.C5.Line&&(n.subs.push((0,x.fP)({text:"  =  ",opts:n.opts})),(0,u.DX)(a)&&n.subs.push((0,x.fP)({text:a.toFixed(2),opts:n.opts,size:new h.AO(35,0),align:o._Y.Right}))),(0,x.k)(i.render,n),n.offset=new h.AO(t.x-n.size.x/2,t.y-n.size.y),(0,x.YA)(n);let s=n.offset.sub(new h.AO(4+B(l,2),4+B(l,0))),c=n.offset.add(n.size).add(new h.AO(8+B(l,1),4+B(l,3)));return T(i.render,s,c,_,r,4),(0,x.sg)(i.render,n),new h.bR(s,c)}function B(e,t){return Array.isArray(e)?e[t]:"number"==typeof e?e:0}function z(e,t,n,o){let l=(t-e)/(o-n),i=e-l*n;return e=>l*e+i}},7717:function(e,t,n){"use strict";n.d(t,{CB:function(){return h},bk:function(){return g}});var o=n(9234),l=n(3014),i=n(7898),r=n(6350),a=n(5429),s=n(1280),c=n(9073),u=n(9158),d=n(6285),f=n(9107);function h(e,t,n,h){let{render:y}=e,{camPos:v}=(0,o.aT)(e.camera),b=v.dist(new u.AO(0,0,-30)),w=(0,f.uZ)(b/500,1,800),_=c.OO.fromScaleTranslation(new u.AO(w,w,w),new u.AO(0,-60,0).add(h)).mul(c.OO.fromTranslation(new u.AO(0,60,0))),A=.1*w,k=u.T8.fromHexColor("#555599",.8),T=u.T8.fromHexColor("#93c5fd",.3),O=u.T8.fromHexColor("#000000",1),B=new u.AO(0,0,1),z=new u.AO(-45,-97,0),E=new u.AO(45,-70,0);g(y,z,E,{color:k,mtx:_,thick:A,n:B}),(0,a.bE)(y.triRender,new u.AO(z.x,z.y,-.1),new u.AO(E.x,E.y,-.1),T,_);let{B:R,C:M,T:P,A:F,nBlocks:C,nHeads:j,vocabSize:D}=t.shape,I=(z.x+E.x)/2;E.x;let L=z.y+2;[R,M,P,F,C,j].map(e=>e.toString().length);let U=(0,i.Ux)(y.modelFontBuf,n,13);(0,i.Dp)(y.modelFontBuf,n,O,I-U/2,z.y+2,13,_);let S="n_params = ",N=function(e){let t=e.toString(),n="";for(let e=0;e<t.length;e++)e>0&&(t.length-e)%3==0&&(n+=","),n+=t[e];return n}(t.weightCount),X=(0,i.Ux)(y.modelFontBuf,S,4),W=(0,i.Ux)(y.modelFontBuf,N,8);L=z.y+16.900000000000002+4;let Z=I-(W+X)/2;(0,i.Dp)(y.modelFontBuf,S,O,Z,L-2,4,_),(0,i.Dp)(y.modelFontBuf,N,O,Z+X,L-4,8,_),function(e){let t=e.layout,n=t.logitsSoftmax,o=new u.AO(n.x+n.dx/2,n.y+n.dy+t.margin),i=t.shape.T,a=new u.AO(o.x-6*i/2,o.y),d=new u.AO(o.x+6*i/2,o.y+10),f=(0,r.HP)({color:u.T8.fromHexColor("#000000",.2),mtx:new c.OO,thick:1.5});p(e,t,a,d,6,4,f,{boldLast:!0,tokMixes:e.display.tokenOutputColors});for(let o=0;o<i;o++){let i=(0,l.pu)(t,n,u.JU.X,o)+.5*t.cell,c=n.y+n.dy+.5*t.cell,d=a.x+(o+.5)*6,h=a.y-t.cell,m=(0,s.t7)(c,h,1/6),p=(0,s.t7)(c,h,3/4);(0,r.Q)(e.render.lineRender,new u.AO(i,c),new u.AO(i,m),f),(0,r.Q)(e.render.lineRender,new u.AO(i,m),new u.AO(d,p),f),(0,r.Q)(e.render.lineRender,new u.AO(d,p),new u.AO(d,h),f);let x=new u.AO(d-.6,h-.6),y=new u.AO(d+.6,h-.6);(0,r.Q)(e.render.lineRender,x,new u.AO(d,h),f),(0,r.Q)(e.render.lineRender,y,new u.AO(d,h),f)}}(e),function(e){var t;let n=e.layout,o=e.render,a=n.idxObj,f=new u.AO(a.x+a.dx/2,a.y-n.margin),h=n.shape.T,y=new u.AO(f.x-6*h/2,f.y-10),v=new u.AO(f.x+6*h/2,f.y),b=null!==(t=e.display.topOutputOpacity)&&void 0!==t?t:1,w=(0,r.HP)({color:u.T8.fromHexColor("#000000",.2),mtx:new c.OO,thick:1.5}),_={color:u.T8.fromHexColor("#666666",1),mtx:w.mtx,size:1.9};(function(e,t,n,o,l,a,s,c){var d,f,h;let p=e.render,{T:y}=t.shape,v=o.y-n.y,b={color:u.T8.fromHexColor("#000000",1),mtx:s.mtx,size:a},w={color:u.T8.fromHexColor("#666666",1),mtx:s.mtx,size:.6*a};b.color.mul(.3),w.color.mul(.3),g(p,n,o,s);let _=null===(d=t.model)||void 0===d?void 0:d.inputTokens.localBuffer;for(let e=0;e<y;e++){if(e>0){let t=n.x+e*l;(0,r.Q)(p.lineRender,new u.AO(t,n.y,0),new u.AO(t,o.y,0),s)}if(_&&e<t.model.inputLen){let t=n.x+(e+.5)*l,o={...b,color:x(null!==(f=null==c?void 0:c.tokMixes)&&void 0!==f?f:null,b.color,e)},r={...w,color:x(null!==(h=null==c?void 0:c.idxMixes)&&void 0!==h?h:null,w.color,e)},a=m(_[e]),s=(0,i.X1)(p.modelFontBuf,a,b),u=(0,i.X1)(p.modelFontBuf,_[e].toString(),w),d=b.size+w.size,y=n.y+(v-d)/2;(0,i.yU)(p.modelFontBuf,a,t-s/2,y,o),(0,i.yU)(p.modelFontBuf,_[e].toString(),t-u/2,y+b.size,r)}}})(e,n,y,v,6,4,w,{tokMixes:e.display.tokenColors,idxMixes:e.display.tokenIdxColors}),(0,i.yU)(o.modelFontBuf,"Input",y.x,y.y-(0,d.Nv)(_),_);{let t=new u.AO(v.x,y.y-4),l=new u.AO(y.x,t.y-12);p(e,n,l,t,6,4,w,{opacity:b,boldLast:b<1,tokMixes:e.display.tokenOutputColors});let r={..._,color:_.color.mul(b)};(0,i.yU)(o.modelFontBuf,"Output",l.x,l.y-(0,d.Nv)(_),r)}for(let t=0;t<h;t++){let o=e.display.tokenIdxColors,i={...w,color:x(o,w.color,t)},c=y.x+(t+.5)*6,d=y.y+n.cell+10,f=(0,l.pu)(n,a,u.JU.X,t)+.5*n.cell,h=a.y-.5*n.cell,m=(0,s.t7)(h,d,1/6),p=(0,s.t7)(h,d,3/4);(0,r.Q)(e.render.lineRender,new u.AO(f,h),new u.AO(f,m),i),(0,r.Q)(e.render.lineRender,new u.AO(f,m),new u.AO(c,p),i),(0,r.Q)(e.render.lineRender,new u.AO(c,p),new u.AO(c,d),i);let g=new u.AO(f-.6,h-.6),v=new u.AO(f+.6,h-.6);(0,r.Q)(e.render.lineRender,g,new u.AO(f,h),i),(0,r.Q)(e.render.lineRender,v,new u.AO(f,h),i)}}(e)}function m(e){return String.fromCharCode(65+e)}function p(e,t,n,o,l,a,s,c){var d,f,h,p;let y=e.render,{T:v,vocabSize:b}=t.shape,w=o.y-n.y,_=null!==(f=null==c?void 0:c.opacity)&&void 0!==f?f:1,A=null===(h=null==c?void 0:c.boldLast)||void 0===h||h;s={...s,color:s.color.mul(null!=_?_:1)};let k={color:u.T8.fromHexColor("#000000",_),mtx:s.mtx,size:a},T={color:u.T8.fromHexColor("#666666",_),mtx:s.mtx,size:.6*a};k.color.mul(.3),T.color.mul(.3),g(y,n,o,s);let O=null===(d=t.model)||void 0===d?void 0:d.sortedBuf;for(let e=0;e<v;e++){if(e>0){let t=n.x+e*l;(0,r.Q)(y.lineRender,new u.AO(t,n.y,0),new u.AO(t,o.y,0),s)}if(O&&e<t.model.inputLen){let o=0,a=n.x+(e+.5)*l;for(let d=0;d<b;d++){let f=O[(e*b+d)*2+0],h=O[(e*b+d)*2+1],g=n.y+o*w,v=h*w,_=e<t.model.inputLen-1||!A,B=x(null!==(p=null==c?void 0:c.tokMixes)&&void 0!==p?p:null,k.color,e);_&&(B=B.mul(.3));let z={...k,color:B},E={...T,color:B.mul(.6)},R=m(f),M=(0,i.X1)(y.modelFontBuf,R,z),P=(0,i.X1)(y.modelFontBuf,f.toString(),E),F=z.size+E.size,C=g+(v-F)/2;if(v>F&&((0,i.yU)(y.modelFontBuf,R,a-M/2,C,z),(0,i.yU)(y.modelFontBuf,f.toString(),a-P/2,C+z.size,E)),o+=h,(0,r.Q)(y.lineRender,new u.AO(a-l/2,g+v,0),new u.AO(a+l/2,g+v,0),s),o>=.9999)break}}}}function x(e,t,n){var o,l;if(!e)return t;let i=null!==(o=e.mixes[n])&&void 0!==o?o:0;return u.T8.lerp(null!==(l=e.color1)&&void 0!==l?l:t,e.color2,i)}let y=new Float32Array(12);function g(e,t,n,o){y[0]=t.x,y[1]=t.y,y[2]=0,y[3]=n.x,y[4]=t.y,y[5]=0,y[6]=n.x,y[7]=n.y,y[8]=0,y[9]=t.x,y[10]=n.y,y[11]=0,(0,r.cc)(e.lineRender,y,(0,r.HP)({...o,closed:!0}))}},6285:function(e,t,n){"use strict";n.d(t,{Aj:function(){return y},C5:function(){return l},Nv:function(){return m},YA:function(){return function e(t){switch(t.type){case l.Line:{let n=t.offset.x+1.75,o=t.offset.y+t.size.y/2;for(let l of t.subs)l.offset=new u.AO(n,o-l.size.y/2).round_(),e(l),n+=l.size.x;break}case l.Sqrt:{let n=t.subs[0];n.offset=t.offset.add(p(t.opts,n).tl).round_(),e(n);break}case l.Divide:{let n=t.subs[0],o=t.subs[1],l=t.size.x/2;n.offset=t.offset.add(new u.AO(l-n.size.x/2,0)).round_(),o.offset=t.offset.add(new u.AO(l-o.size.x/2,t.size.y-o.size.y)).round_(),e(n),e(o);break}case l.Text:case l.Cells:case l.Custom:break;default:t.type}}},fP:function(){return function e(t){var n,o,i,r,a;let c=null!==(o=t.type)&&void 0!==o?o:t.text?l.Text:t.subs?l.Line:(0,s.DX)(t.cellX)&&(0,s.DX)(t.cellY)?l.Cells:null;if((0,s.kK)(c))throw Error("Unknown text block type");let d=t.opts;if(d&&t.color&&(d={...d,color:t.color}),!d)throw Error("No font opts");return{type:c,id:t.id,text:t.text,align:t.align,opts:d,size:null!==(i=t.size)&&void 0!==i?i:new u.AO(0,0,0),offset:null!==(r=t.offset)&&void 0!==r?r:new u.AO(0,0,0),subs:null===(n=t.subs)||void 0===n?void 0:n.filter(s.DX).map(t=>e({...t,opts:null!==(a=t.opts)&&void 0!==a?a:d})),rectOpts:t.rectOpts,draw:t.draw,cellX:t.cellX,cellY:t.cellY}}},k:function(){return function e(t,n){let o=n.opts;switch(n.type){case l.Line:{let o=0,l=0;for(let i of n.subs)e(t,i),o+=i.size.x,l=Math.max(l,i.size.y);n.size=new u.AO(o,l,0),n.rectOpts&&(n.size.x+=3.5,n.size.y+=3.5);break}case l.Text:if((0,s.kK)(n.text))throw Error("Text block has no text");n.size=new u.AO(Math.max(n.size.x,(0,i.X1)(t.modelFontBuf,n.text,o)),m(o));break;case l.Sqrt:{let l=n.subs[0];e(t,l);let i=p(o,l);n.size=l.size.add(i.tl).add(i.br);break}case l.Divide:{let o=n.subs[0],l=n.subs[1];e(t,o),e(t,l);let i={padX:0,padInnerY:.5*o.size.y};n.size=new u.AO(Math.max(o.size.x,l.size.x)+i.padX,o.size.y+l.size.y+i.padInnerY,0);break}case l.Cells:{let e=x(n);n.size=new u.AO(e.size.x+e.pad,e.size.y);break}case l.Custom:break;default:n.type}}},sg:function(){return function e(t,n){switch(n.type){case l.Line:for(let o of n.subs)e(t,o);if(n.rectOpts){let e=(0,r.HP)(n.rectOpts),o=n.offset.round().add(new u.AO(.5,.5)),l=n.offset.add(n.size).round().add(new u.AO(.5,.5));(0,d.QP)(t,o,l,e.color.mul(.24),e.mtx,2),(0,f.bk)(t,o,l,e)}break;case l.Text:{let e=n.offset.x;n.align===h._Y.Right&&(e=n.offset.x+n.size.x-(0,i.X1)(t.modelFontBuf,n.text,n.opts)),(0,i.yU)(t.modelFontBuf,n.text,e,n.offset.y+.1*n.opts.size,n.opts);break}case l.Sqrt:{let o=n.subs[0],l=o.size.y,a=n.offset.x,s=n.offset.y-.9*l,c=1.8*l,d={...n.opts,faceName:"cmsy10",size:c},f=(0,r.HP)({color:n.opts.color,n:new u.AO(0,0,1),mtx:n.opts.mtx,thick:.4}),h=a+.5*c,m=s+.5*c;(0,r.Q)(t.lineRender,new u.AO(h,m).round_(),new u.AO(o.offset.x+o.size.x,m).round_(),f),(0,i.yU)(t.modelFontBuf,"p",a,s,d),e(t,o);break}case l.Divide:{let o=n.subs[0],l=n.subs[1],i=(0,r.HP)({color:n.opts.color,n:new u.AO(0,0,1),mtx:n.opts.mtx,thick:.4}),a=(0,c.t7)(o.offset.y+o.size.y,l.offset.y,.5)+1;(0,r.Q)(t.lineRender,new u.AO(n.offset.x,a),new u.AO(n.offset.x+n.size.x,a),i),e(t,n.subs[0]),e(t,n.subs[1]);break}case l.Cells:{let e=n.offset.add(new u.AO(n.size.x/2,n.size.y/2)),o=x(n);y(t,new u.AO(n.cellX,n.cellY),e,o.size,n.opts.color,n.opts.mtx);break}case l.Custom:var o;null===(o=n.draw)||void 0===o||o.call(n,n,t);break;default:n.type}}}});var o,l,i=n(7898),r=n(6350),a=n(5429),s=n(9107),c=n(1280),u=n(9158),d=n(4485),f=n(7717),h=n(4230);function m(e){return 1.2*e.size}function p(e,t){return{tl:new u.AO(.9*t.size.y,.2*t.size.y),br:new u.AO(.1*t.size.y,0)}}function x(e){return{size:new u.AO(7*e.cellX,7*e.cellY),pad:7}}function y(e,t,n,o,l,i){let s=n.mulAdd(o,-.5).add(new u.AO(.5,.5)),c=n.mulAdd(o,.5).add(new u.AO(.5,.5)),d=(0,r.HP)({color:l,mtx:i,n:new u.AO(0,0,1),thick:.4});(0,f.bk)(e,s,c,d),(0,a.bE)(e.triRender,s,c,l.mul(.3),i);for(let n=1;n<t.x;n++){let t=s.x+7*n;(0,r.Q)(e.lineRender,new u.AO(t,s.y,0),new u.AO(t,c.y,0),d)}for(let n=1;n<t.y;n++){let t=s.y+7*n;(0,r.Q)(e.lineRender,new u.AO(s.x,t,0),new u.AO(c.x,t,0),d)}}(o=l||(l={}))[o.Line=0]="Line",o[o.Text=1]="Text",o[o.Sqrt=2]="Sqrt",o[o.Divide=3]="Divide",o[o.Cells=4]="Cells",o[o.Custom=5]="Custom"},7004:function(e,t,n){"use strict";n.d(t,{X:function(){return y}});var o,l,i=n(7437),r=n(2265),a=n(9158),s=n(5784),c=n.n(s),u=n(7318),d=n(9107),f=n(383),h=n(7042),m=n(4415),p=n(1074),x=n(2348);(o=l||(l={}))[o.Cell=0]="Cell",o[o.PosEmbed=1]="PosEmbed",o[o.Block=2]="Block",o[o.Gap=3]="Gap";let y=e=>{let t,n,{activePhase:o,onEnterPhase:s}=e,[h]=(0,r.useState)(()=>new g),[x,y]=(0,r.useState)(null),[b,w]=(0,r.useState)(null),_=(0,p.f9)();(0,r.useLayoutEffect)(()=>{w(document.createElement("canvas"))},[]);let[A,k]=(0,r.useState)(null),T=(0,r.useCallback)((e,t,n)=>{k(n?t:null)},[]),[O,B]=(0,r.useState)(null),z=(0,r.useCallback)((e,t,n)=>{(0,m.hT)(_.walkthrough,t),null==s||s(t),B(n?t:null)},[_.walkthrough,s]);O=null!=o?o:O;let E={ln:"#e9f29e",multihead:"#f2d59e",feedForward:"#9ef2f2",tokEmbed:"#f0a8fc",linear:"#a8c3fc",softmax:"#a8fcaf",line:"#000",focus:"#338"},R={type:l.Block,height:0,color:"#eee",special:"llm",padX:2,padY:1,id:"llm",items:[{type:l.Cell,label:"tok embed",height:1,width:4,color:E.tokEmbed,id:"tokEmbed"},{type:l.PosEmbed,height:1.8,id:"posEmbed"},{type:l.Block,height:0,padX:3,padY:0,color:"#ddd",special:"transformer",id:"transformer",items:[{type:l.Gap,height:1.2,gapType:"exit",arrow:!0},{type:l.Cell,height:1,label:"layer norm",width:4,color:E.ln,id:"ln1"},{type:l.Gap,height:.8,gapType:"multihead",arrow:!0},{type:l.Cell,height:2,label:["multi-head, causal","self-attention"],width:7,color:E.multihead,id:"selfAttend"},{type:l.Gap,height:1,gapType:"add"},{type:l.Gap,height:.8,gapType:"exit",arrow:!0},{type:l.Cell,height:1,label:"layer norm",width:4,color:E.ln,id:"ln2"},{type:l.Gap,height:.5,arrow:!0},{type:l.Cell,height:2,label:["feed","forward"],width:5,color:E.feedForward,id:"feedForward"},{type:l.Gap,height:1,gapType:"add"}]},{type:l.Gap,height:.5,arrow:!0},{type:l.Cell,height:1,label:"layer norm",width:4,color:E.ln,id:"lnf"},{type:l.Gap,height:.5,arrow:!0},{type:l.Cell,label:"linear",height:1,width:4,color:E.linear,id:"linear"},{type:l.Gap,height:.5,arrow:!0},{type:l.Cell,label:"softmax",height:1,width:4,color:E.softmax,id:"softmaxOut"}]},M=[],P=[];function F(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],l={id:e,title:t,ids:n,groupIds:o};M.push(l),P[P.length-1].entries.push(l)}function C(e){var t,n;return null!==(n=null===(t=function e(t,n,o){if(n=null!=n?n:new a.AO(0,0),(o=null!=o?o:R).id===t)return{el:o,bounds:j(o,n)};if(o.items)for(let l of o.items){let i=e(t,o.posPx.add(n),l);if(i)return i}return null}(e))||void 0===t?void 0:t.bounds)&&void 0!==n?n:null}function j(e,t){let n=e.posPx.add(t);return new a.bR(n,n.add(e.sizePx))}function D(e,t){return(0,i.jsxs)("g",{children:[(0,i.jsx)("circle",{cx:e.x,cy:e.y,r:6,stroke:"#000000",fill:"white"}),";",(0,i.jsx)("line",{x1:e.x-4,y1:e.y,x2:e.x+4,y2:e.y,stroke:"#000000",strokeWidth:1}),";",(0,i.jsx)("line",{x1:e.x,y1:e.y-4,x2:e.x,y2:e.y+4,stroke:"#000000",strokeWidth:1}),";"]},t)}function I(e,t,n){let o=e.sub(t).normalize(),l=new a.AO(o.y,-o.x),r=e.mulAdd(o,-5).mulAdd(l,-2),s=e.mulAdd(o,-5).mulAdd(l,2),u="M".concat(r.x,",").concat(r.y," L").concat(e.x,",").concat(e.y," L").concat(s.x,",").concat(s.y,"Z");return(0,i.jsx)("g",{children:(0,i.jsx)("path",{d:u,fill:E.line,className:c().dataPath})},n)}P.push({groupName:"Intro",entries:[]}),F(f.nz.Intro_Intro,"Introduction",[]),F(f.nz.Intro_Prelim,"Preliminaries",[]),P.push({groupName:"Components",entries:[]}),F(f.nz.Input_Detail_Embedding,"Embedding",["tokEmbed","posEmbed"],!0),F(f.nz.Input_Detail_LayerNorm,"Layer Norm",["ln1","ln2","lnf"]),F(f.nz.Input_Detail_SelfAttention,"Self Attention",["selfAttend"]),F(f.nz.Input_Detail_Projection,"Projection",["selfAttend"]),F(f.nz.Input_Detail_Mlp,"MLP",["feedForward"]),F(f.nz.Input_Detail_Transformer,"Transformer",["transformer"]),F(f.nz.Input_Detail_Softmax,"Softmax",["softmaxOut"]),F(f.nz.Input_Detail_Output,"Output",["lnf","linear","softmaxOut"],!0),!function e(t){var n,o,i,r;if(t.padX=null!==(n=t.padX)&&void 0!==n?n:0,t.padY=null!==(o=t.padY)&&void 0!==o?o:0,t.type===l.Block){let n=new a.AO(0,2*t.padY*20);for(let o of t.items)e(o),n.x=Math.max(n.x,o.sizePx.x),n.y+=o.sizePx.y;n.x+=20*t.padX,t.sizePx=n}else t.type===l.Gap?t.width=0:t.type===l.PosEmbed&&(t.width=10),t.width=null!==(i=t.width)&&void 0!==i?i:1,t.height=null!==(r=t.height)&&void 0!==r?r:1,t.sizePx=new a.AO(20*t.width,20*t.height)}(R),function e(t,n){if(t.posPx=n,t.type===l.Block){let n=t.sizePx.x/2,o=new a.AO(20*t.padX,20*t.padY);for(let l of t.items)e(l,new a.AO(n-l.sizePx.x/2,o.y)),o.y+=l.sizePx.y}}(R,new a.AO(10.5,90.5));let L=function(){if(!b)return null;let e=b.getContext("2d");e.font="16px Merriweather";let t=["How"," to"," predict"],n=[2437,284,4331],o=["rgba(107,64,216,.3)","rgba(104,222,122,.4)","rgba(244,172,54,.4)","rgba(239,65,70,.4)","rgba(39,181,234,.4)"],l=[],s=[0];for(let n of t)l.push(e.measureText(n).width+1),s.push(s[s.length-1]+l[l.length-1]);let c=[" text"," tokens"," words"],u=[.8,.5,.3],d=[2420,16326,2456],f=c.map(t=>e.measureText(t).width+1),h=o[l.length],m=s[s.length-1],p=Math.max(...f),x=m+p+28+6,y=R.sizePx.x/2-x/2+20.5;return{node:(0,i.jsxs)("g",{transform:"translate(".concat(y," ").concat(20,")"),children:[t.map((e,t)=>(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)("rect",{x:s[t],y:0,width:l[t]+1,height:20,fill:o[t]}),(0,i.jsx)("text",{x:s[t],y:16,fontSize:14,children:e.replaceAll(" ","\xa0")}),(0,i.jsx)("text",{x:s[t]+l[t]/2,y:30,fontSize:9,textAnchor:"middle",fill:"#338a",children:n[t]})]},t)),c.map((e,t)=>(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)("rect",{x:m,y:-10+20*t,width:f[t]+1,height:20,fill:h}),(0,i.jsx)("text",{x:m,y:-10+20*t+16,fontSize:12,fillOpacity:u[t],children:e.replaceAll(" ","\xa0")}),(0,i.jsx)("text",{x:m+p+28,y:-10+20*t+13,fontSize:9,textAnchor:"end",fill:"#338a",children:d[t]})]},t)),(0,i.jsx)("rect",{x:m+1,y:-9,width:p+28+4,height:20*c.length-2,fill:"none",stroke:h,strokeDasharray:"4,4"})]}),inputPos:new a.AO(y,60),inputWidth:m,outputPos:new a.AO(y+m,10+20*c.length+2),outputWidth:p+28+4}}();function U(e){let t=e.ids.map(C).filter(d.DX);if(!e.groupIds)return t;{let e=new a.bR;return t.forEach(t=>e.combineInPlace(t)),[e]}}let S=j(R,new a.AO(0,0)).max.y+10;return(0,i.jsxs)("div",{children:[!1,(0,i.jsxs)("div",{className:c().tocDiagram,children:[(0,i.jsxs)("svg",{viewBox:"0 0 310 ".concat(S),width:"310px",height:S,ref:y,children:[null==L?void 0:L.node,function e(t,n){var r,s,f,h,m;let p,x;let y=t.posPx,g=t.sizePx,v="translate(".concat(y.x,", ").concat(y.y,")"),b=null!==(s=t.color)&&void 0!==s?s:"#00000000",w=null===(r=u.ZP(b))||void 0===r?void 0:r.darker(.5).toString(),_=!1===(p=(0,d.DX)(A)?A:O,(x=M.find(e=>e.id===p))?x.ids.includes(null!==(m=t.id)&&void 0!==m?m:""):null)&&((0,d.DX)(A)||(0,d.DX)(o))?.5:1,k=null;switch(t.type){case l.Cell:let T=Array.isArray(t.label)?t.label:[t.label];k=(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("rect",{className:c().cell,width:g.x,height:g.y,fill:null!==(f=t.color)&&void 0!==f?f:"#00000000",rx:3,ry:3,stroke:w,strokeWidth:1}),T.map((e,t)=>(0,i.jsx)("text",{x:g.x/2,y:(t+.75)*20,width:g.x,fontSize:11,textAnchor:"middle",children:e},t))]});break;case l.PosEmbed:let B=t.sizePx.mul(.5),z=B.x-40;k=(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("line",{className:c().gap,x1:B.x,x2:B.x,y1:0,y2:g.y,stroke:E.line}),(0,i.jsx)("text",{fontSize:11,textAnchor:"end",x:z-14,y:B.y+2.75,children:"pos embed"}),(0,i.jsx)("circle",{cx:z,cy:B.y,r:10,stroke:E.line,fill:"none"}),";",(0,i.jsx)("line",{x1:z+14,x2:B.x-10,y1:B.y,y2:B.y,stroke:E.line,strokeWidth:1}),";",(0,i.jsx)("text",{textAnchor:"middle",x:z,y:B.y+5,fontSize:18,children:"~"}),I(new a.AO(B.x-8,B.y),new a.AO(B.x-12,B.y),"posEmbedArrow"),D(B,"posEmbed")]});break;case l.Block:let R="llm"===t.special?"2 2":void 0;k=(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("rect",{className:c().block,width:g.x,height:g.y,fill:null!==(h=t.color)&&void 0!==h?h:"#000000",rx:3,ry:3,strokeDasharray:R,stroke:w}),t.items.map((t,n)=>e(t,n)),function(){let e=t.items.filter(e=>"exit"===e.gapType),n=t.items.filter(e=>"add"===e.gapType),o=[];for(let t=0;t<e.length;t++){let l=e[t],r=n[t],s=l.posPx.y+.25*l.sizePx.y,u=r.posPx.y+r.sizePx.y/2,d=l.posPx.x+l.sizePx.x,f=r.posPx.x+8,h=g.x-10,m="M".concat(d,",").concat(s," L").concat(h,",").concat(s," L").concat(h,",").concat(u," L").concat(f+4,",").concat(u);o.push((0,i.jsx)("path",{d:m,fill:"none",strokeLinejoin:"round",opacity:_,className:c().dataPath},t)),o.push(I(new a.AO(f,u),new a.AO(f+10,u),"residual-arrow-".concat(t)))}return o}(),"transformer"===t.special&&(0,i.jsx)("text",{fontSize:13,textAnchor:"start",x:4,y:14,fill:"#555",children:"transformer i"}),"llm"===t.special&&(0,i.jsx)("text",{fontSize:13,textAnchor:"start",x:4,y:14,fill:"#333",children:"LLM"})]}),_=1;break;case l.Gap:function P(e){let t=Math.round(.3*g.y),n="M".concat(g.x/2,",").concat(t," L").concat(e,",").concat(t," L").concat(e,",").concat(g.y-2);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("path",{d:n,stroke:"black",fill:"none",className:c().dataPath}),I(new a.AO(e,g.y),new a.AO(e,g.y-10),"multihead-arrow")]})}k=(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("line",{className:c().gap,x1:0,y1:0,x2:0,y2:g.y,stroke:"black"}),"add"===t.gapType&&D(new a.AO(g.x/2,g.y/2),"add"),t.arrow&&I(new a.AO(g.x/2,g.y),new a.AO(g.x/2,0),"0"),"multihead"===t.gapType&&(0,i.jsxs)(i.Fragment,{children:[P(g.x/2-30),P(g.x/2+30)]})]})}return(0,i.jsx)("g",{transform:v,opacity:_,children:k},n)}(R,0),function(){let e=C("tokEmbed");if(!L||!e)return null;let t=L.inputPos.x+4,n=L.inputPos.x+L.inputWidth-4,o=Math.round(L.inputPos.y),l=o+10,r="M".concat(t,",").concat(o," L").concat(t+4,",").concat(l," L").concat(n-4,",").concat(l," L").concat(n,",").concat(o),s=(t+n)/2,u=new a.AO(e.center().x,e.min.y),d=u.y-10,f="M".concat(s,",").concat(l," L").concat(s,",").concat(d," L").concat(u.x,",").concat(d," L").concat(u.x,",").concat(u.y-2);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("path",{d:r+f,className:c().dataPath}),I(u,new a.AO(u.x,u.y-10),"multihead-arrow")]})}(),function(){let e=C("softmaxOut"),t=C("llm");if(!L||!e||!t)return null;let n=new a.AO(e.center().x,e.max.y),o=n.y+10,l=t.max.x-10,r=t.min.y+10,s=new a.AO(L.outputPos.x+L.outputWidth/2,L.outputPos.y),u="M".concat(n.x,",").concat(n.y," L").concat(n.x,",").concat(o," L").concat(l,",").concat(o," L").concat(l,",").concat(r," L").concat(s.x,",").concat(r," L").concat(s.x,",").concat(s.y+2);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("path",{d:u,className:c().dataPath}),I(s,new a.AO(s.x,s.y+10),"multihead-arrow")]})}(),(t=null!=A?A:O,(n=M.find(e=>e.id===t))?U(n).map((e,t)=>{let n,o,l,s;return n=new a.AO(4,4),o=e.min.sub(n),l=e.max.add(n),s=E.focus,(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)("defs",{children:(0,i.jsxs)("mask",{id:"hole"+t,children:[(0,i.jsx)("rect",{x:o.x-30,y:o.y-30,width:l.x-o.x+60,height:l.y-o.y+60,fill:"white"}),(0,i.jsx)("rect",{x:o.x,y:o.y,width:l.x-o.x,height:l.y-o.y,fill:"black"})]})}),(0,i.jsx)("rect",{x:o.x,y:o.y,width:l.x-o.x,height:l.y-o.y,fill:s,mask:"url(#hole".concat(t,")"),style:{filter:"drop-shadow(0px 0px 5px ".concat(s,")")}}),(0,i.jsx)("rect",{x:o.x,y:o.y,width:l.x-o.x,height:l.y-o.y,fill:"none",stroke:"#338a",strokeWidth:2,strokeDasharray:"8,4"})]},t)}):[]),function(){if(!x)return null;let e=x.getBoundingClientRect(),t=j(R,new a.AO(0,0)).max.x+10,n=0,o=[];for(let l of M){let r=l.id,s=h.entries.get(r);if(!s)continue;let c=s.getBoundingClientRect(),u=new a.AO(c.left-e.left-4,c.top-e.top+c.height/2),d=U(l);if(0===d.length)continue;let f=[...d.map(e=>e.center().y),u.y],m=Math.min(...f),p=Math.max(...f),x=t,y="M".concat(x,",").concat(m," L").concat(x,",").concat(p," M").concat(x,",").concat(u.y," L").concat(u.x,",").concat(u.y),g=(A?l.id===A:l.id===O)?1:.1,v=()=>({stroke:E.focus,strokeWidth:1,fill:"none",strokeOpacity:g});for(let e of(o.push((0,i.jsx)("path",{...v(),d:y},n++)),U(l))){let t=new a.AO(e.max.x+8,e.center().y),l="M".concat(t.x,",").concat(t.y," L").concat(x,",").concat(t.y);o.push((0,i.jsx)("path",{...v(),d:l},n++))}t+=4}return o}()]}),(0,i.jsxs)("div",{className:c().toc,children:[(0,i.jsx)("div",{className:c().tocTitle,children:"Table of Contents"}),P.map((e,t)=>(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)("div",{className:c().tocGroupTitle,children:e.groupName}),e.entries.map((e,t)=>(0,i.jsx)(v,{entryManager:h,title:e.title,id:e.id,active:e.id===O,hover:e.id===A,setHover:T,setActive:z},t))]},t))]})]})]})};class g{setEl(e,t){if(t)return this.entries.set(e,t),()=>{this.entries.delete(e)};this.entries.delete(e)}constructor(){this.subscriptions=new x.tH,this.entries=new Map}}let v=(0,r.memo)(function(e){let{entryManager:t,id:n,title:o,active:l,hover:a,setHover:s,setActive:u}=e,d=(0,r.useCallback)(e=>{t.setEl(n,e)},[t,n]);return(0,i.jsx)("div",{ref:d,className:(0,h.Z)("cursor-pointer p-1 pl-3 "+c().menuEntry,l&&"bg-blue-200",a&&"bg-blue-800 text-white"),onClick:function(e){u(e,n,!l)},onMouseEnter:e=>{s(e,n,!0)},onMouseLeave:e=>{s(e,n,!1)},children:o})})},7898:function(e,t,n){"use strict";n.d(t,{C1:function(){return c},Dp:function(){return m},Nn:function(){return y},Ux:function(){return d},WY:function(){return u},X1:function(){return f},b1:function(){return x},s1:function(){return s},yU:function(){return h},yk:function(){return p}});var o=n(9107),l=n(9073),i=n(6843),r=n(9158),a=n(7361);async function s(){let e=document.createElement("img"),t=new Promise((t,n)=>{e.onload=()=>t(e),e.onerror=()=>n()});e.src="fonts/font-atlas.png";let n=fetch("fonts/font-def.json",{credentials:"include",mode:"no-cors"}).then(e=>e.json()),[o,l]=await Promise.all([t,n]);return{fontAtlasImage:o,fontDef:l}}function c(e,t){let n=e.gl,l=t.fontDef,r=n.createTexture();n.bindTexture(n.TEXTURE_2D,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t.fontAtlasImage);let s=(0,i.tQ)(e.shaderManager,"font","#version 300 es\n        precision highp float;\n        ".concat(a.$t,"\n        uniform sampler2D u_transformTex;\n        layout (location = 0) in vec2 a_position;\n        layout (location = 1) in vec2 a_uv;\n        layout (location = 2) in float a_textId;\n        out vec2 v_uv;\n        out vec4 v_fgColor;\n        out vec4 v_bgColor;\n\n        void main() {\n            int texWidth = textureSize(u_transformTex, 0).x;\n            int texOffset = int(a_textId) * ").concat(5,";\n            int y = texOffset / texWidth;\n            int x = texOffset % texWidth;\n            vec4 t0 = texelFetch(u_transformTex, ivec2(x + 0, y), 0);\n            vec4 t1 = texelFetch(u_transformTex, ivec2(x + 1, y), 0);\n            vec4 t2 = texelFetch(u_transformTex, ivec2(x + 2, y), 0);\n            vec4 t3 = texelFetch(u_transformTex, ivec2(x + 3, y), 0);\n            vec4 c = texelFetch(u_transformTex, ivec2(x + 4, y), 0);\n            mat4 transform = mat4(t0, t1, t2, t3);\n\n            gl_Position = u_view * u_model * transform * vec4(a_position, 0.0, 1.0);\n            v_uv = a_uv;\n            v_fgColor = c;\n            v_bgColor = vec4(0, 0, 0, 0);\n        }\n\n    "),"#version 300 es\n        precision highp float;\n        uniform sampler2D u_tex;\n        uniform float pxRange; // set to distance field's pixel range\n        in vec2 v_uv;\n        in vec4 v_fgColor;\n        in vec4 v_bgColor;\n        out vec4 color;\n\n        float median(float r, float g, float b) {\n            return max(min(r, g), min(max(r, g), b));\n        }\n\n        float screenPxRange() {\n            vec2 unitRange = vec2(pxRange) / vec2(textureSize(u_tex, 0));\n            vec2 screenTexSize = vec2(1.0) / fwidth(v_uv);\n            return max(0.5*dot(unitRange, screenTexSize), 1.0);\n        }\n\n        void main() {\n            vec3 msd = texture(u_tex, v_uv).rgb;\n            float sd = median(msd.r, msd.g, msd.b);\n            float screenRange = screenPxRange();\n            float screenPxDistance = screenRange*(sd - 0.5);\n            float opacity = clamp(screenPxDistance + 0.5, 0.0, 1.0);\n\n            float blurOpacity = 0.0; //smoothstep(0.5 - 0.4, 0.5, sd);\n\n            if (opacity == 0.0 && blurOpacity == 0.0) {\n                discard;\n            }\n            color = mix(vec4(0,0,0,1.0) * blurOpacity, v_fgColor, opacity);\n        }\n    ",["u_tex","u_transformTex","pxRange"],{uboBindings:{ModelViewUbo:a.$c.ModelView}});(0,i.OM)(e.shaderManager);let c=s.locs;n.useProgram(s.program),n.uniform1i(c.u_tex,0),n.uniform1i(c.u_transformTex,1);let u=[];for(let e of l.faces){let t=new Int16Array((0,o.RG)(e.chars)),n=t.length/12,l=new Map,i=new Map,r=[];for(let e=0;e<n;e++){let n=12*e,o={id:t[n+0],index:t[n+1],char:String.fromCharCode(t[n+2]),x:t[n+3],y:t[n+4],width:t[n+5],height:t[n+6],xoffset:t[n+7],yoffset:t[n+8],xadvance:t[n+9],page:t[n+10],chnl:t[n+11]};l.set(o.char,o),i.set(o.id,o),r.push(o)}let a=new Int16Array((0,o.RG)(e.kernings)),s=a.length/3,c=new Map;for(let e=0;e<s;e++){let t=3*e,n={first:a[t+0],second:a[t+1],amount:a[t+2]},o=i.get(n.first).char,l=i.get(n.second).char;c.set("".concat(o).concat(l),n.amount)}u.push({name:e.name,common:e.common,charMap:l,kernMap:c})}return{gl:n,faceInfos:u,program:s,atlasTex:r}}function u(e,t){let n=e.gl,o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texImage2D(n.TEXTURE_2D,0,n.RGBA32F,1024,Math.ceil(5),0,n.RGBA,n.FLOAT,null);let l=n.createVertexArray();n.bindVertexArray(l);let r=n.createBuffer();return(0,i.FT)(n,r,{},[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_texIndex",size:1}]),{atlas:e,vao:l,transformTex:o,vertBuffer:(0,i.gX)(n,n.ARRAY_BUFFER,r,1024,20,t),localTexBuffer:new Float32Array(20480),segmentsUsed:0,segmentCapacity:1024,glSegmentCapacity:1024,sharedRender:t}}function d(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3?arguments[3]:void 0,l=o?e.atlas.faceInfos.find(e=>e.name===o):e.atlas.faceInfos[0],i=0,r="";for(let e of t){let t=l.charMap.get(e);if(!t)continue;let n="".concat(r).concat(e);i+=(l.kernMap.get(n)||0)+t.xadvance,r=e}return i*n/l.common.lineHeight*1.04}function f(e,t,n){return d(e,t,n.size,n.faceName)}function h(e,t,n,o,l){m(e,t,l.color,n,o,l.size,l.mtx,l.faceName)}function m(e,t,n,o,a,s,c,u){let d=u?e.atlas.faceInfos.find(e=>e.name===u):e.atlas.faceInfos[0];d||(d=e.atlas.faceInfos[0]);let f=e.sharedRender.activePhase,h=e.vertBuffer.localBufs[f];(0,i.tZ)(h,5*t.length),e.segmentsUsed===Math.floor(204.8)&&(e.segmentsUsed+=1);let m=e.segmentsUsed,p=h.buf,x=h.usedEls*e.vertBuffer.strideFloats,y=1/d.common.scaleW,g=1/d.common.scaleH,v=0,b=null!=o?o:0,w=null!=a?a:0,_="",A=(s=null!=s?s:1)/d.common.lineHeight*1.04;for(let e of t){let t=d.charMap.get(e);if(!t)continue;let n="".concat(_).concat(e);b+=(d.kernMap.get(n)||0)*A;let o=[t.x*y,(t.x+t.width)*y],l=[t.y*g,(t.y+t.height)*g],i=[b+t.xoffset*A,b+(t.xoffset+t.width)*A],r=[w+t.yoffset*A,w+(t.yoffset+t.height)*A],a=[0,1,0,0,1,1,1,1,0,0,1,0];for(let e=0;e<6;e++){let t=a[2*e],n=a[2*e+1];p[x++]=i[t],p[x++]=r[n],p[x++]=o[t],p[x++]=l[n],p[x++]=m}b+=t.xadvance*A,_=e,v+=1}if(h.usedEls+=6*v,c=null!=c?c:new l.OO,n=null!=n?n:new r.T8(1,1,1,1),e.segmentsUsed>=e.segmentCapacity){let t=2*e.segmentCapacity,n=new Float32Array(20*t);n.set(e.localTexBuffer),e.localTexBuffer=n}e.localTexBuffer.set(c,20*e.segmentsUsed+0),e.localTexBuffer.set(n.toArray(),20*e.segmentsUsed+16),e.segmentsUsed+=1}function p(e){let t=e.atlas.gl;if(t.bindTexture(t.TEXTURE_2D,e.transformTex),e.segmentCapacity>e.glSegmentCapacity){let n=Math.ceil(20*e.segmentCapacity/4/1024);t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,1024,n,0,t.RGBA,t.FLOAT,null),e.glSegmentCapacity=1024*n/4}{let n=Math.ceil(20*e.segmentsUsed/4/1024);t.texSubImage2D(t.TEXTURE_2D,0,0,0,1024,n,t.RGBA,t.FLOAT,e.localTexBuffer)}(0,i.Sr)(t,e.vertBuffer)}function x(e,t){let n=e.atlas,o=n.gl;o.disable(o.CULL_FACE),o.depthMask(!1),o.useProgram(n.program.program);let l=n.program.locs;o.uniform1f(l.pxRange,4),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,n.atlasTex),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,e.transformTex),o.bindVertexArray(e.vao);let i=e.vertBuffer.localBufs[t];o.drawArrays(o.TRIANGLES,i.glOffsetEls,i.usedEls),o.depthMask(!0)}function y(e){(0,i.BX)(e.vertBuffer),e.segmentsUsed=0}},6350:function(e,t,n){"use strict";n.d(t,{E:function(){return v},HP:function(){return s},Q:function(){return c},cc:function(){return g},fJ:function(){return b},j0:function(){return h},xW:function(){return w},zi:function(){return a}});var o=n(9073),l=n(6843),i=n(9158),r=n(7361);function a(e,t){let n=e.gl,o=n.createVertexArray();n.bindVertexArray(o);let i=n.createBuffer(),a=(0,l.FT)(n,i,{},[{name:"a_position",size:3},{name:"a_lineDirA",size:3},{name:"a_lineDirB",size:3},{name:"a_color",size:4},{name:"a_thickness",size:1},{name:"a_firstPair",size:1},{name:"a_normal",size:3},{name:"a_dash",size:1},{name:"a_t",size:1}]),s=(0,l.gX)(n,n.ARRAY_BUFFER,i,1024,a,null),c=n.createBuffer();return{gl:n,vao:o,floatBuf:s,indexBuf:(0,l.EO)(n,c,1024,t),lineShader:(0,l.tQ)(e,"line","#version 300 es\n        precision highp float;\n        ".concat(r.$t,"\n        uniform vec2 u_viewSizeInv;\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_lineDirA;\n        layout(location = 2) in vec3 a_lineDirB;\n        layout(location = 3) in vec4 a_color;\n        layout(location = 4) in float a_thickness;\n        layout(location = 5) in float a_firstPair;\n        layout(location = 6) in vec3 a_normal;\n        layout(location = 7) in float a_dash;\n        layout(location = 8) in float a_t;\n        out vec2 v_linePos;\n        out vec4 v_color;\n        out float v_thickness;\n        out float v_dash;\n        void main() {\n\n            float mul = 1.0;\n            if (gl_VertexID % 2 == 0) {\n                mul = -1.0;\n            }\n\n            bool firstPair = a_firstPair > 0.0;\n\n            float width;\n\n            if (length(a_normal) == 0.0) {\n                vec4 clipPos = u_view * u_model * vec4(a_position, 1);\n                vec2 screenPos = clipPos.xy / clipPos.w;\n\n                vec4 lineDirAClip = u_view * u_model * vec4(a_position + a_lineDirA, 1);\n                vec2 lineDirA = normalize(lineDirAClip.xy / lineDirAClip.w - screenPos);\n                vec4 lineDirBClip = u_view * u_model * vec4(a_position + a_lineDirB, 1);\n                vec2 lineDirB = normalize(lineDirBClip.xy / lineDirBClip.w - screenPos);\n\n                vec2 avgDir = normalize(lineDirA + lineDirB);\n                vec2 activeDir = firstPair ? lineDirA : lineDirB;\n\n                float scale = sqrt(2.0) / length(lineDirA + lineDirB);\n                vec2 offset = vec2(-avgDir.y, avgDir.x);\n\n                if (scale > 5.0) {\n                    bool isOuter = cross(vec3(lineDirA, 0), vec3(lineDirB, 0)).z * mul < 0.0;\n                    if (isOuter) {\n                        offset = vec2(-activeDir.y, activeDir.x);\n                        scale = 1.0 / sqrt(2.0);\n                    } else {\n                        offset = vec2(-activeDir.y, activeDir.x);\n                        scale = 1.0 / sqrt(2.0);\n                    }\n                }\n\n                width = a_thickness * 2.0;\n                vec2 linePos = screenPos + offset * u_viewSizeInv * width * mul * scale;\n\n                gl_Position = vec4(linePos.xy * clipPos.w, clipPos.z, clipPos.w);\n                v_thickness = a_thickness;\n\n            } else {\n\n                width = a_thickness * 2.0;\n                vec3 activeDir = firstPair ? a_lineDirA : a_lineDirB;\n\n                vec3 avgDir = normalize(a_lineDirA + a_lineDirB);\n                vec3 offset = normalize(cross(a_normal, avgDir));\n                // need to scale by the amount of angle between the two line directions\n                float scale = sqrt(2.0) / length(a_lineDirA + a_lineDirB);\n\n                // if we exceed the miter limit (90 degrees), we need to clamp the line width, and draw a bevel instead.\n                // the inner corner stays the same, but the outer corner is a bevel.\n\n                if (scale > 2.0) {\n                    bool isOuter = cross(a_lineDirA, a_lineDirB).z * mul < 0.0;\n\n                    if (isOuter) {\n                        offset = normalize(cross(a_normal, activeDir));\n                        scale = 1.0 / sqrt(2.0);\n                    }\n                }\n\n                vec3 linePos = a_position + offset * mul * width * scale;\n\n                gl_Position = u_view * u_model * vec4(linePos, 1);\n                v_thickness = 100.0;\n\n            }\n\n            v_dash = a_dash;\n            v_color = a_color;\n            v_linePos = vec2(mul * width, a_t);\n        }\n    "),"#version 300 es\n        precision highp float;\n        in vec2 v_linePos;\n        in vec4 v_color;\n        in float v_thickness;\n        in float v_dash;\n        out vec4 o_color;\n\n        void main() {\n            float lineWidth = v_thickness - 1.0;\n            float edge0 = lineWidth / 2.0;\n            float edge1 = lineWidth / 2.0 + fwidth(v_linePos.x);\n            float t = 1.0 - smoothstep(edge0, edge1, abs(v_linePos.x));\n\n            if (v_dash > 0.0) {\n                float dashPos = mod(v_linePos.y, v_dash);\n                if (dashPos > v_dash / 2.0) {\n                    t = 0.0;\n                }\n            }\n\n            if (t == 0.0) {\n                discard;\n            }\n\n            o_color = v_color * t;\n        }\n    ",["u_viewSizeInv"],{uboBindings:{ModelViewUbo:r.$c.ModelView}}),sharedRender:t}}function s(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{thick:+(t.thick||1),color:t.color||new i.T8(1,1,1,1),mtx:t.mtx||o.OO.identity,n:t.n||void 0,closed:t.closed||!1,dash:null!==(e=t.dash)&&void 0!==e?e:0}}function c(e,t,n,o){h(e,o.thick,o.color,t,n,o.n,o.mtx,o.dash)}let u=new i.AO,d=new i.AO,f=new i.AO;function h(e,t,n,o,r,a,s,c,h){let m=e.sharedRender.activePhase,p=e.floatBuf.localBufs[0],x=p.buf,y=e.indexBuf.localBufs[m],g=y.buf;(0,l.tZ)(p,4),(0,l.BH)(y,5),s?(s.mulVec3Affine_(o,u),s.mulVec3Affine_(r,d)):(u.copy_(o),d.copy_(r)),c=null!=c?c:0,f.x=d.x-u.x,f.y=d.y-u.y,f.z=d.z-u.z;let v=f.len(),b=1/v;f.x*=b,f.y*=b,f.z*=b;let w=[u,u,d,d];a=null!=a?a:i.AO.zero;let _=p.usedEls*p.strideFloats,A=y.usedVerts;for(let e=0;e<4;e++)x[_+0]=w[e].x,x[_+1]=w[e].y,x[_+2]=w[e].z,x[_+3]=f.x,x[_+4]=f.y,x[_+5]=f.z,x[_+6]=f.x,x[_+7]=f.y,x[_+8]=f.z,x[_+9]=n.x,x[_+10]=n.y,x[_+11]=n.z,x[_+12]=n.w,x[_+13]=t,x[_+14]=1,x[_+15]=a.x,x[_+16]=a.y,x[_+17]=a.z,x[_+18]=c,x[_+19]=e<2?0:v,_+=p.strideFloats,g[A+e]=p.usedEls+e;g[A+4]=4294967295,p.usedEls+=4,y.usedVerts+=5}let m=new Float32Array(6),p=m.subarray(0,3),x=m.subarray(3,6),y=new Float32Array(0);function g(e,t,n){var o,r;let a=e.sharedRender.activePhase,s=e.floatBuf.localBufs[0],c=s.buf,u=e.indexBuf.localBufs[a],d=u.buf,f=t.length,h=(null!==(o=n.n)&&void 0!==o?o:i.AO.zero).clone();if(n.mtx){y.length<t.length&&(y=new Float32Array(t.length));for(let e=0;e<t.length;e+=3)n.mtx.mulVec3AffineArr_(t,e,y,e);t=y,n.mtx.mulVec3AffineVec_(h,h)}let m=f/3+(n.closed?1:0);(0,l.tZ)(s,4*m),(0,l.BH)(u,4*m+1),n.closed&&(i.GU.sub_(t,0,t,f-3,x,0),i.GU.normalize_(x,0,x,0));let g=null!==(r=n.dash)&&void 0!==r?r:0,v=n.color.x,b=n.color.y,w=n.color.z,_=n.color.w,A=n.thick,k=h.x,T=h.y,O=h.z,B=0;for(let e=0;e<m;e++){let o=3*e;n.closed&&e===m-1&&(o=0);let l=0;!n.closed&&e<m-1||n.closed&&e!==m-2?(i.GU.sub_(t,o+3,t,o,p,0),l=i.GU.len_(p,0),i.GU.normalize_(p,0,p,0)):n.closed&&e===m-2&&(i.GU.sub_(t,0,t,f-3,p,0),l=i.GU.len_(p,0),i.GU.normalize_(p,0,p,0));let r=s.usedEls*s.strideFloats,a=u.usedVerts,h=0!=e||n.closed?x:p,y=e!=m-1||n.closed?p:x,z=n.closed&&e===m-1?2:4;for(let e=0;e<z;e++)i.GU.copy_(t,o,c,r),i.GU.copy_(h,0,c,r+3),i.GU.copy_(y,0,c,r+6),c[r+9]=v,c[r+10]=b,c[r+11]=w,c[r+12]=_,c[r+13]=A,c[r+14]=e>2?0:1,c[r+15]=k,c[r+16]=T,c[r+17]=O,c[r+18]=g,c[r+19]=B,r+=s.strideFloats,d[a+e]=s.usedEls+e;s.usedEls+=z,u.usedVerts+=z,B+=l,i.GU.copy_(p,0,x,0)}d[u.usedVerts]=4294967295,u.usedVerts+=1}function v(e){let t=e.gl;(0,l.Sr)(t,e.floatBuf),(0,l.ZZ)(t,e.indexBuf)}function b(e,t){let n=e.gl,o=e.indexBuf.localBufs[t];if(0===o.usedVerts)return;n.disable(n.CULL_FACE),n.depthMask(!1),n.useProgram(e.lineShader.program),n.bindVertexArray(e.vao);let l=e.lineShader.locs;n.uniform2f(l.u_viewSizeInv,1/n.canvas.width,1/n.canvas.height),n.drawElements(n.TRIANGLE_STRIP,o.usedVerts,n.UNSIGNED_INT,o.glOffsetBytes),n.depthMask(!0)}function w(e){(0,l.BX)(e.floatBuf),(0,l.bq)(e.indexBuf)}},7361:function(e,t,n){"use strict";var o,l;n.d(t,{$7:function(){return r},$c:function(){return i},$t:function(){return s},Md:function(){return a},i$:function(){return o}});let i={ModelView:0,Block:1,BlockAccess:2,blur:3};function r(e){let t=e.gl,n=t.createBuffer();return t.bindBuffer(t.UNIFORM_BUFFER,n),t.bufferData(t.UNIFORM_BUFFER,128,t.DYNAMIC_DRAW),t.bindBufferBase(t.UNIFORM_BUFFER,i.ModelView,n),{gl:t,modelViewUbo:n,modelViewBuf:new Float32Array(32),activePhase:o.Opaque,numPhases:4}}function a(e,t,n){let{gl:o,modelViewUbo:l,modelViewBuf:i}=e;i.set(t,0),i.set(n,16),o.bindBuffer(o.UNIFORM_BUFFER,l),o.bufferSubData(o.UNIFORM_BUFFER,0,i)}(l=o||(o={}))[l.Opaque=0]="Opaque",l[l.Arrows=1]="Arrows",l[l.Overlay=2]="Overlay",l[l.Overlay2D=3]="Overlay2D";let s="\n    layout(std140) uniform ModelViewUbo {\n        uniform mat4 u_model;\n        uniform mat4 u_view;\n    };"},1499:function(e,t,n){"use strict";n.d(t,{QD:function(){return s},fg:function(){return r},jF:function(){return a}});var o=n(6843),l=n(9158),i=n(7361);function r(e){let t=e.gl,n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,1,1,0,1,0,0,0,0,0]),t.STATIC_DRAW);let l=t.createVertexArray();t.bindVertexArray(l),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,3,t.FLOAT,!1,0,0);let r=t.createBuffer(),a=(0,o.FT)(t,r,{divisor:1,locOffset:2},[{name:"a_offset",size:3},{name:"a_size",size:3},{name:"a_nCells",size:2},{name:"a_threadDir",size:2,nCols:3}]);return{gl:t,vao:l,quadVbo:n,instanceVbo:r,instanceBuf:(0,o.gX)(t,t.ARRAY_BUFFER,r,1024,a,null),numInstances:0,shader:(0,o.tQ)(e,"thread","#version 300 es\n        precision highp float;\n        ".concat(i.$t,"\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_normal;\n\n        uniform vec3 u_offset;\n        uniform vec3 u_size;\n        uniform vec2 u_nCells;\n        uniform mat3x2 u_threadDir;\n        out vec3 v_normal;\n        out vec3 v_modelPos;\n        out vec2 v_blockPos;\n        out vec2 v_squarePos;\n        void main() {\n            vec2 localPos = u_threadDir * vec3(a_position.xy, 1);\n            vec3 model_pos = a_position * u_size + u_offset;\n            gl_Position = u_view * u_model * vec4(model_pos, 1);\n            v_normal = a_normal;\n            v_modelPos = model_pos;\n            v_blockPos = localPos * abs(u_threadDir * vec3(u_nCells, 0));\n            v_squarePos = localPos;\n        }\n    "),"#version 300 es\n        precision highp float;\n        in vec3 v_normal;\n        in vec3 v_modelPos;\n        in vec2 v_blockPos;\n        in vec2 v_squarePos;\n        out vec4 o_color;\n        uniform vec2 u_nCells;\n        uniform vec3 u_camPos; // in model space\n        uniform vec3 u_baseColor;\n\n        void main() {\n            ivec2 blockPos = ivec2(v_blockPos - v_normal.xy * 0.0);\n\n            vec2 pxPerCell = 1.0 / fwidth(v_blockPos);\n            float maxPxPerCell = max(pxPerCell.x, pxPerCell.y);\n\n            vec4 color = vec4(0);\n\n            if (v_blockPos.y < 0.0) {\n                discard;\n            }\n\n            if (blockPos.y == 0) {\n                // draw head\n                vec2 d = fract(v_blockPos) - 0.5;\n                float d2 = sqrt(d.x * d.x + d.y * d.y);\n\n                // fwidth(d);\n                float deltad2_per_px = fwidth(d2); // fwidth(d2);\n\n                float t = 1.0 - smoothstep(0.45, 0.45 + 1.0 * deltad2_per_px, d2);\n\n                float t2 = smoothstep(0.35, 0.35 + 1.0 * deltad2_per_px, d2);\n\n                // if (d2 > 0.35 && d2 < 0.45) {\n                color = mix(color, vec4(u_baseColor, 1), min(t, t2));\n                // }\n            }\n\n            if (v_blockPos.y > (0.5 + 0.45)) {\n                float falloffY = 1.0 - clamp(v_blockPos.y / 10.0, 0.0, 1.0);\n\n                float cellPosX = fract(v_blockPos.x);\n                float distFromX = abs(cellPosX - 0.5);\n                // small side-to-side falloff based on distFromX for a glow effect\n                float falloffX = 1.0 - smoothstep(0.0, min(0.3, 5.0 * fwidth(v_blockPos.x)), distFromX);\n\n                color = mix(color, vec4(u_baseColor, 1), falloffX * falloffY);\n            }\n\n            // color = vec4(1, 0, 0, 1);\n\n            o_color = color;\n        }\n    ",["u_size","u_offset","u_baseColor","u_nCells","u_threadDir"],{uboBindings:{ModelViewUbo:i.$c.ModelView}}),threadInfos:[]}}function a(e,t,n,o,i,r,a,s,c){let u=o===l.JU.X?[0,-1,1,0,0,1]:[1,0,0,-1,0,1],d=new l.AO(n.x+i*t.cell,n.y+r*t.cell,n.z+n.dz),f=new l.AO(a*t.cell,s*t.cell,n.dz),h=new l.AO(a,s,0);e.threadInfos.push({pos:d,size:f,nCells:h,baseColor:c,threadDir:u})}function s(e){let{gl:t,shader:n,vao:o}=e;t.enable(t.POLYGON_OFFSET_FILL),t.disable(t.CULL_FACE),t.depthMask(!1),t.polygonOffset(-1,-2);let l=n.locs;for(let i of(t.useProgram(n.program),t.bindVertexArray(o),e.threadInfos)){let e=i.baseColor;t.uniform3f(l.u_offset,i.pos.x,i.pos.y,i.pos.z),t.uniform3f(l.u_size,i.size.x,i.size.y,i.size.z),t.uniform2f(l.u_nCells,i.nCells.x,i.nCells.y),t.uniform3f(l.u_baseColor,e.x,e.y,e.z),t.uniformMatrix3x2fv(l.u_threadDir,!1,i.threadDir),t.drawArrays(t.TRIANGLE_FAN,0,4)}e.threadInfos=[],t.disable(t.POLYGON_OFFSET_FILL),t.depthMask(!0)}},5429:function(e,t,n){"use strict";n.d(t,{HI:function(){return r},Ht:function(){return p},O8:function(){return x},bE:function(){return h},fe:function(){return u},m8:function(){return y},rI:function(){return m}});var o=n(6843),l=n(9158),i=n(7361);function r(e,t){let n=e.gl,l=n.createVertexArray();n.bindVertexArray(l);let r=n.createBuffer(),a=(0,o.FT)(n,r,{},[{name:"a_pos",size:3},{name:"a_normal",size:3},{name:"a_color",size:4},{name:"a_uv",size:2}]),s=(0,o.gX)(n,n.ARRAY_BUFFER,r,1024,a,null),c=n.createBuffer();return{gl:n,vao:l,vbo:s,ibo:(0,o.EO)(n,c,1024,t),triShader:(0,o.tQ)(e,"triangles","#version 300 es\n        precision highp float;\n        ".concat(i.$t,"\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_normal;\n        layout(location = 2) in vec4 a_color;\n        layout(location = 3) in vec2 a_uv;\n        out vec4 v_color;\n        out vec2 v_uv;\n        out vec3 v_normal;\n        void main() {\n            gl_Position = u_view * u_model * vec4(a_position, 1);\n            v_color = a_color;\n            v_normal = a_normal;\n            v_uv = a_uv;\n        }\n    "),"#version 300 es\n        precision highp float;\n        in vec2 v_uv;\n        in vec3 v_normal;\n        in vec4 v_color;\n        out vec4 o_color;\n\n        void main() {\n            o_color = v_color;\n        }\n    ",[],{uboBindings:{ModelViewUbo:i.$c.ModelView}}),sharedRender:t}}let a=new l.AO(0,0,1),s=new l.AO,c=new l.AO;function u(e,t,n,l,i){let r=e.sharedRender.activePhase,u=e.vbo.localBufs[0],d=e.ibo.localBufs[r];(0,o.tZ)(u,1),(0,o.BH)(d,1);let f=u.buf,h=d.buf,m=u.usedEls*u.strideFloats,p=d.usedVerts;i?(i.mulVec3Affine_(t,s),i.mulVec3AffineVec_(l||a,c)):(s.copy_(t),c.copy_(l||a)),f[m+0]=s.x,f[m+1]=s.y,f[m+2]=s.z,f[m+3]=c.x,f[m+4]=c.y,f[m+5]=c.z,f[m+6]=n.x,f[m+7]=n.y,f[m+8]=n.z,f[m+9]=n.w,f[m+10]=0,f[m+11]=0,h[p]=u.usedEls,u.usedEls+=1,d.usedVerts+=1}let d=new l.AO,f=new l.AO;function h(e,t,n,l,i){let r=!(arguments.length>5)||void 0===arguments[5]||arguments[5];if(d.x=n.x,d.y=t.y,d.z=t.z,f.x=t.x,f.y=n.y,f.z=n.z,u(e,t,l,void 0,i),u(e,f,l,void 0,i),u(e,d,l,void 0,i),u(e,n,l,void 0,i),r){let t=e.sharedRender.activePhase,n=e.ibo.localBufs[t];(0,o.BH)(n,1),n.buf[n.usedVerts++]=4294967295}}function m(e){let t=e.sharedRender.activePhase,n=e.ibo.localBufs[t];(0,o.BH)(n,1),n.buf[n.usedVerts++]=4294967295}function p(e){let t=e.gl;(0,o.Sr)(t,e.vbo),(0,o.ZZ)(t,e.ibo)}function x(e,t){let n=e.gl,o=e.ibo.localBufs[t];0!==o.usedVerts&&(n.depthMask(t===i.i$.Opaque),n.disable(n.CULL_FACE),n.useProgram(e.triShader.program),n.bindVertexArray(e.vao),n.drawElements(n.TRIANGLE_STRIP,o.usedVerts,n.UNSIGNED_INT,o.glOffsetBytes),n.depthMask(!0))}function y(e){(0,o.bq)(e.ibo),(0,o.BX)(e.vbo)}},383:function(e,t,n){"use strict";function o(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}n.d(t,{nz:function(){return a},Mw:function(){return eF},zn:function(){return eC},Kh:function(){return ej}});var l,i,r,a,s=n(4230),c=n(1499),u=n(2850),d=n(9107),f=n(1280),h=n(9158),m=n(2261),p=n(7437),x=n(6500),y=n.n(x),g=n(2265),v=n(1074),b=n(6554),w=n(7917),_=n(4485);function A(){let e=o(["Welcome to the walkthrough of the GPT large language model! Here we'll explore the model _nano-gpt_, with a mere 85,000 parameters.\n\nIts goal is a simple one: take a sequence of six letters: ",'\nand sort them in alphabetical order, i.e. to "ABBBCC".']);return A=function(){return e},e}function k(){let e=o(["We call each of these letters a ",", and the set of the model's different tokens make up its _vocabulary_:","\n\n    From this table, each token is assigned a number, its ",". And now we can enter this sequence of numbers into the model:","\n"],["We call each of these letters a ",", and the set of the model's different tokens make up its _vocabulary_:","\n\n    From this table, each token is assigned a number, its ",". And now we can enter this sequence of numbers into the model:","\\n"]);return k=function(){return e},e}function T(){let e=o(["In the 3d view, each green cell represents a number being processed, and each blue cell is a weight. ","\n    Each number in the sequence first gets turned into a 48 element vector (a size chosen for this particular model). This is called an _embedding_."]);return T=function(){return e},e}function O(){let e=o(["The embedding is then passed through the model, going through a series of layers, called transformers, before reaching the bottom."]);return O=function(){return e},e}function B(){let e=o(["So what's the output? A prediction of the next token in the sequence. So at the 6th entry, we get probabilities that the next token is\n        going to be 'A', 'B', or 'C'."]);return B=function(){return e},e}function z(){let e=o(["In this case, the model is pretty sure it's going to be 'A'. Now, we can feed this prediction back into the top of the model, and repeat\n    the entire process."]);return z=function(){return e},e}function E(e,t){return{lastBlockIdx:e.layout.cubes.filter(e=>"w"!==e.t).indexOf(t)-1}}function R(e,t,n,o){var l;let i=e.layout.cubes.filter(e=>"w"!==e.t),r=o?o.lastBlockIdx+1:0,a=i.indexOf(n),c=i.filter((e,t)=>t>=r&&t<=a).map(e=>{var t;return e.cx*e.cy*Math.pow(null!==(l=null===(t=e.deps)||void 0===t?void 0:t.dotLen)&&void 0!==l?l:1,.25)}),u=c.reduce((e,t)=>e+t,0),d=0,m=r,p=0;for(let e=r;e<=a;e++){let n=c[e-r]/u;if(d+=n,t.t<d){m=e,p=(t.t-(d-n))/n;break}}let x=i[m],y=h.JU.X,g=h.JU.Y;x.transpose&&(y=h.JU.Y,g=h.JU.X);let{cx:v}=(0,s.gW)(x,y),{cx:b}=(0,s.gW)(x,g),A=(0,f.t7)(0,v,p),k=Math.floor(A),T=(0,f.t7)(0,b,A-k),O=Math.floor(T),B=new h.AO().withSetAt(y,k).withSetAt(g,O),z=new h.AO(Math.floor(v/2),0,0);x===e.layout.residual0&&(z=new h.AO(2*v,-2,0)),t.t>=1&&(m=a);for(let e=r;e<m;e++){let t=i[e];t.access&&(t.access.disable=!1)}if(t.active&&t.t<1){for(let t of((0,w.Tl)(e,x,B),(0,_.iW)(e,x,B,z),e.layout.labels))for(let e of t.cubes)e===x&&(t.visible=1);x.highlight=.3;let t=(0,s.n2)(e.layout,x,y,A,0);if(t){for(let e of(0,s.L3)(x,y,null,k))e.access&&(e.access.disable=!1,e.highlight=.1);t.highlight=.4;let n=(0,s.n2)(e.layout,t,g,T,0);for(let e of(0,s.L3)(t,g,null,O))e.access&&(e.access.disable=!1);n&&(n.highlight=.7)}}else if(t.active){let e=i[a];e.access&&(e.access.disable=!1)}let E=null!=o?o:{lastBlockIdx:m};return E.lastBlockIdx=a,E}let M=()=>{let e=(0,v.f9)().display.tokenColors;return(0,p.jsx)("div",{className:y().tableWrap,children:(0,p.jsx)("div",{children:"CBABBC".split("").map((t,n)=>{let o=(0,m.c6)(m.Zy.Token);return e&&(o=h.T8.lerp(o,e.color2,e.mixes[n])),(0,p.jsxs)("span",{style:{color:o.toHexColor()},children:[t," "]},n)})})})},P=()=>{let e=(0,v.f9)().display.tokenIdxColors;return(0,p.jsx)("div",{className:y().tableWrap,children:(0,p.jsx)("div",{children:"CBABBC".split("").map((t,n)=>{let o=t.charCodeAt(0)-65,l=(0,m.c6)(m.Zy.TokenIdx);return e&&(l=h.T8.lerp(l,e.color2,e.mixes[n])),(0,p.jsxs)("span",{style:{color:l.toHexColor()},children:[o," "]},n)})})})},F=()=>(0,p.jsx)("div",{className:y().tableWrap,children:(0,p.jsx)("table",{className:y().table,children:(0,p.jsxs)("tbody",{children:[(0,p.jsxs)("tr",{className:y().tokString,style:{color:(0,m.c6)(m.Zy.Token).toHexColor()},children:[(0,p.jsx)("th",{children:"token"}),(0,p.jsx)("td",{children:"A"}),(0,p.jsx)("td",{children:"B"}),(0,p.jsx)("td",{children:"C"})]}),(0,p.jsxs)("tr",{className:y().tokIndex,style:{color:(0,m.c6)(m.Zy.TokenIdx).toHexColor()},children:[(0,p.jsx)("th",{children:"index"}),(0,p.jsx)("td",{children:"0"}),(0,p.jsx)("td",{children:"1"}),(0,p.jsx)("td",{children:"2"})]})]})})}),C=()=>{let[e,t]=(0,g.useState)([-.7,.7,-.1]),[n,o]=(0,g.useState)([-.7,.4,.8]),l=new h.T8(.3,.3,1),i=new h.T8(.3,.9,.3);return(0,p.jsx)("div",{className:y().tableWrap,children:(0,p.jsxs)("div",{className:y().cellInfoCols,children:[(0,p.jsxs)("div",{className:y().cellInfoCol,children:[(0,p.jsx)(j,{nums:n,color:i,mul:.5}),(0,p.jsx)(D,{nums:n,color:i,setNums:o}),(0,p.jsx)("div",{className:y().cellInfoText,children:"being processed"})]}),(0,p.jsxs)("div",{className:y().cellInfoCol,children:[(0,p.jsx)(j,{nums:e,color:l,mul:1}),(0,p.jsx)(D,{nums:e,color:l,setNums:t}),(0,p.jsx)("div",{className:y().cellInfoText,children:"weights"})]})]})})},j=e=>{let{color:t,nums:n,mul:o}=e,l=new h.T8(.5,.5,.5,1),i=h.T8.lerp(t,l,.9),r=i.mul(.98);r.w=1;let a=e=>{let n=(0,d.uZ)(Math.abs(e),0,1),o=new h.T8(0,0,0),l=new h.T8(.5,.5,.5);return e<0?h.T8.lerp(l,o,n).toHexColor():h.T8.lerp(l,t,n).toHexColor()};return(0,p.jsx)("div",{className:y().cellArrayHoriz,children:n.map((e,t)=>(0,p.jsx)("div",{className:y().cellRect,style:{backgroundColor:(t%2==0?i:r).toHexColor()},children:(0,p.jsx)("div",{className:y().cellCircle,style:{backgroundColor:a(e*(null!=o?o:1))}})},t))})},D=e=>{let{color:t,nums:n,max:o,setNums:l}=e,[i,r]=(0,g.useState)(null),a=t.mul(1);a.w=.5;let[,s]=(0,b.se)(function(e,t){let n=e.clientY-t.clientY,o=.5*i.clientHeight,r=[...t.data.nums];r[t.data.index]=(0,d.uZ)(r[t.data.index]-n/o,-1,1),null==l||l(r),e.preventDefault(),e.stopImmediatePropagation()});return(0,p.jsxs)("div",{className:y().graph,style:{width:30*n.length},ref:r,children:[(0,p.jsx)("div",{className:y().axisLeft}),(0,p.jsx)("div",{className:y().axisZero}),n.map((e,t)=>{let l=e/(null!=o?o:1);return(0,p.jsxs)("div",{className:y().graphCol,children:[(0,p.jsx)("div",{className:y().graphBar,style:{backgroundColor:a.toHexColor(),top:l<0?"50%":"".concat((.5-l/2)*100,"%"),height:"".concat(Math.abs(l)/2*100,"%")}}),(0,p.jsx)("div",{className:y().graphBarHit,onMouseDown:e=>{s(e,{index:t,nums:n}),e.stopPropagation(),e.preventDefault()},style:{top:"".concat((.5-l/2)*100,"%")}}),(0,p.jsx)("div",{className:y().graphBarLabel,style:{bottom:l<0?"50%":void 0,top:l>0?"50%":void 0},children:e.toFixed(1)})]},t)})]})};function I(){let e=o(["\nBefore we delve into the algorithm's intricacies, let's take a brief step back.\n\nThis guide focuses on _inference_, not training, and as such is only a small part of the entire machine-learning process.\nIn our case, the model's weights have been pre-trained, and we use the inference process to generate output. This runs directly in your browser.\n\nThe model showcased here is part of the GPT (generative pre-trained transformer) family, which can be described as a \"context-based token predictor\".\nOpenAI introduced this family in 2018, with notable members such as GPT-2, GPT-3, and GPT-3.5 Turbo, the latter being the foundation of the widely-used ChatGPT.\nIt might also be related to GPT-4, but specific details remain unknown.\n\nThis guide was inspired by the "," GitHub project, a minimal GPT implementation in ","\ncreated by ",".\nHis YouTube series "," and the minGPT project have been invaluable resources in the creation of this\nguide. The toy model featured here is based on one found within the minGPT project.\n\nAlright, let's get started!\n"]);return I=function(){return e},e}function L(e,t){return U((0,p.jsx)("a",{className:y().externalLink,href:t,target:"_blank",rel:"noopener noreferrer",children:e}))}function U(e){return{insertInline:e}}var S=n(7898),N=n(9073);function X(){let e=o(["\nWe saw previously how the tokens are mapped to a sequence of integers using a simple lookup table.\nThese integers, the ",", are the first and only time we see integers in the model.\nFrom here on out, we're using floats (decimal numbers).\n\nLet's take a look at how the 4th token (index 3) is used to generate the 4th column vector of our ","."]);return X=function(){return e},e}function W(){let e=o(["\nWe use the token index (in this case "," = ",") to select the 2nd column of the "," on the left.\nNote we're using 0-based indexing here, so the first column is at index 0.\n\nThis produces a column vector of size ",", which we describe as the token embedding.\n    "]);return W=function(){return e},e}function Z(){let e=o(["\nAnd since we're looking at our token "," in the 4th _position_ (t = ","), we'll take the 4th column of the ",".\n\nThis also produces a column vector of size ",", which we describe as the position embedding.\n    "]);return Z=function(){return e},e}function Y(){let e=o(["\nNote that both of these position and token embeddings are learned during training (indicated by their blue color).\n\nNow that we have these two column vectors, we simply add them together to produce another column vector of size ",".\n"]);return Y=function(){return e},e}function V(){let e=o(["\nWe now run this same process for all of the tokens in the input sequence, creating a set of vectors which incorporate both the token values and their positions.\n\n"]);return V=function(){return e},e}function G(){let e=o(["\nFeel free to hover over individual cells on the "," matrix to see the computations and their sources.\n\nWe see that running this process for all the tokens in the input sequence produces a matrix of size "," x ",".\nThe "," stands for ",", i.e., you can think of tokens later in the sequence as later in time.\nThe "," stands for ",', but is also referred to as "feature" or "dimension" or "embedding size". This length, ',',\nis one of the several "hyperparameters" of the model, and is chosen by the designer to in a tradeoff between model size and performance.\n\nThis matrix, which we\'ll refer to as the '," is now ready to be passed down through the model.\nThis collection of "," columns each of length "," will become a familiar sight throughout this guide.\n"]);return G=function(){return e},e}function H(){let e=o(["\n\nThe  "," matrix from the previous section is the input to our first Transformer block.\n\nThe first step in the Transformer block is to apply _layer normalization_ to this matrix. This is an\noperation that normalizes the values in each column of the matrix separately."]);return H=function(){return e},e}function J(){let e=o(["\nNormalization is an important step in the training of deep neural networks, and it helps improve the\nstability of the model during training.\n\nWe can regard each column separately, so let's focus on the 4th column (",") for now."]);return J=function(){return e},e}function q(){let e=o(["\nThe goal is to make the average value in the column equal to 0 and the standard deviation equal to 1. To do this,\nwe find both of these quantities ("," & ",") for the column and then subtract the average and divide by the standard deviation."]);return q=function(){return e},e}function Q(){let e=o(["\nThe notation we use here is E[x] for the average and Var[x] for the variance (of the column of length ","). The\nvariance is simply the standard deviation squared. The epsilon term (ε = ",") is there to prevent division by zero.\n\nWe compute and store these values in our aggregation layer since we're applying them to all values in the column.\n\nFinally, once we have the normalized values, we multiply each element in the column by a learned\n"," and then add a "," value, resulting in our ","."]);return Q=function(){return e},e}function K(){let e=o(["\nWe run this normalization operation on each column of the ",", and the result is\nthe ",", which is ready to be passed into the Self-Attention layer.\n"]);return K=function(){return e},e}var $=n(3014),ee=n(6875);function et(){let e=o(["\nThe self-attention layer is perhaps the heart of the Transformer and of GPT. It's the phase where the\ncolumns in our input embedding matrix \"talk\" to each other. Up until now, and in all other phases,\nthe columns can be regarded independently.\n\nThe self-attention layer is made up of several heads, and we'll focus on one of them for now."]);return et=function(){return e},e}function en(){let e=o(["\nThe first step is to produce three vectors for each of the "," columns from the ",".\nThese vectors are the Q, K, and V vectors:\n\n","\n\nTo produce one of these vectors, we perform a matrix-vector multiplication with a bias added. Each\noutput cell is some linear combination of the input vector. E.g. for the ",", this is done with a dot product between\na row of the "," and a column of the ","."]);return en=function(){return e},e}function eo(){let e=o(["\nThe dot product operation, which we'll see a lot of, is quite simple: We pair each element from\nthe first vector with the corresponding element from the second vector, multiply the pairs together\nand then add the results up."]);return eo=function(){return e},e}function el(){let e=o(["\n\nThis is a general and simple way of ensuring each output element can be influenced by all the\nelements in the input vector (where that influence is determined by the weights). Hence its frequent\nappearance in neural networks.\n\nWe repeat this operation for each output cell in the Q, K, V vectors:"]);return el=function(){return e},e}function ei(){let e=o(['\nWhat do we do with our Q (query), K (key), and V (value) vectors? The naming\ngives us a hint: "key" and "value" are reminiscent of a dictionary in software, with keys mapping to\nvalues. Then "query" is what we use to look up the value.\n\n',"\n\nIn the case of self-attention, instead of returning a single entry, we return some weighted\ncombination of the entries. To find that weighting, we take a dot product between a Q vector and each\nof the K vectors. We normalize that weighting, before finally using it to multiply with the\ncorresponding V vector, and then adding them all up.\n\n","\n\nFor a more concrete example, let's look at the 6th column (","), from which\nwe will query from:"]);return ei=function(){return e},e}function er(){let e=o(["\nThe {K, V} entries of our lookup are the 6 columns in the past, and the Q value is the current time.\n\nWe first calculate the dot product between the "," of the current column (",") and the ","\nof each of the those previous columns. These are then stored in the corresponding row (",")\nof the ","."]);return er=function(){return e},e}function ea(){let e=o(["\nThese dot products are a way of measuring the similarity between the two vectors. If they're very\nsimilar, the dot product will be large. If they're very different, the dot product will be small or\nnegative.\n\nThe idea of only using the query against past keys makes this _causal_ self-attention. That is,\ntokens can't \"see into the future\".\n\nAnother element is that after we take the dot product, we divide by sqrt(","), where\n"," is the length of the Q/K/V vectors. This scaling is done to prevent large values from\ndominating the normalization (softmax) in the next step.\n\nWe'll mostly skip over the softmax operation (described later); suffice it to say, each row is normalized to sum\nto 1."]);return ea=function(){return e},e}function es(){let e=o(["\nFinally, we can produce the output vector for our column (","). We look at the (",") row of the\n"," and for each element, multiply the corresponding "," of the\nother columns element-wise."]);return es=function(){return e},e}function ec(){let e=o(["\nThen we can add these up to produce the output vector. Thus, the output vector will be dominated by\nV vectors from columns that have high scores.\n\nNow we know the process, let's run it for all the columns."]);return ec=function(){return e},e}function eu(){let e=o(["\nAnd that's the process for a head of the self-attention layer. So the main goal of self-attention is\nthat each column wants to find relevant information from other columns and extract their values, and\ndoes so by comparing its _query_ vector to the _keys_ of those other columns. With the added restriction\nthat it can only look in the past.\n"]);return eu=function(){return e},e}function ed(e,t,n){return((0,d.uZ)(n,e,t)-e)/(t-e)}function ef(e,t,n,o,l){let i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},{layout:r}=e,{pinIdx:a,clamp:c,maxIdx:u,hidePopup:f}=i,m=n===h.JU.X?h.JU.Y:h.JU.X,{cx:p}=(0,s.gW)(t,m);a||(a=new h.AO(0,0,0));let x=(0,s.n2)(r,t,n,o,0);if(!x)return;let y=null!=u?u:p,g=l*y;c&&(g=(0,d.uZ)(g,0,y-1));let v=Math.floor(g);if(v>=y)return;(0,s.n2)(r,x,m,v+.5,0);let b=new h.AO(0,0,0);for(let l of(b.setAt(n,o),b.setAt(m,v),x&&!f&&((0,w.Tl)(e,t,b),(0,_.iW)(e,t,b,a)),(0,s.L3)(x,m,null,v)))l.access.disable=!1}function eh(e,t,n,o,l,i){let r,{color:a,size:s}=i,c=(0,$.wD)(t),u=(0,$.wD)(n);r=o===h.JU.X?new h.AO((0,f.t7)(c.br.x,u.tl.x,.5),(c.tl.y+c.br.y+u.tl.y+u.br.y)*.25,c.tl.z+e.layout.cell/2):new h.AO((c.tl.x+c.br.x+u.tl.x+u.br.x)*.25,(0,f.t7)(c.br.y,u.tl.y,.5),c.tl.z+e.layout.cell/2);let d={color:a,size:s,mtx:N.OO.fromTranslation(r)},m=(0,S.X1)(e.state.render.modelFontBuf,l,d);(0,S.yU)(e.state.render.modelFontBuf,l,-m/2,-d.size/2,d)}function em(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];let t=new h.T8(e.x,e.y,e.z,.5);return(0,p.jsx)("div",{className:"flex flex-col pb-[2px]",children:(0,d.VL)(3,0).map((n,o)=>(0,p.jsx)("div",{className:"w-3 h-3 border-2 mb-[-2px]",style:{borderColor:e.toHexColor(),backgroundColor:t.toHexColor()}},o))})}function ep(){let e=o(["\n\nThe softmax operation is used as part of self-attention, as seen in the previous section, and it\nwill also appear at the very end of the model.\n\nIts goal is to take a vector and normalize its values so that they sum to 1.0. However, it's not as\nsimple as dividing by the sum. Instead, each input value is first exponentiated.\n\n  a = exp(x_1)\n\nThis has the effect of making all values positive. Once we have a vector of our exponentiated\nvalues, we can then divide each value by the sum of all the values. This will ensure that the sum\nof the values is 1.0. Since all the exponentiated values are positive, we know that the resulting\nvalues will be between 0.0 and 1.0, which provides a probability distribution over the original values.\n\nThat's it for softmax: simply exponentiate the values and then divide by the sum.\n\nHowever, there's a slight complication. If any of the input values are quite large, then the\nexponentiated values will be very large. We'll end up dividing a large number by a very large number,\nand this can cause issues with floating-point arithmetic.\n\nOne useful property of the softmax operation is that if we add a constant to all the input values,\nthe result will be the same. So we can find the largest value in the input vector and subtract it\nfrom all the values. This ensures that the largest value is 0.0, and the softmax remains numerically\nstable.\n\nLet's take a look at the softmax operation in the context of the self-attention layer. Our input\nvector for each softmax operation is a row of the self-attention matrix (but only up to the diagonal).\n\nLike with layer normalization, we have an intermediate step where we store some aggregation values\nto keep the process efficient.\n\nFor each row, we store the max value in the row and the sum of the shifted & exponentiated values.\nThen, to produce the corresponding output row, we can perform a small set of operations: subtract the\nmax, exponentiate, and divide by the sum.\n\nWhat's with the name \"softmax\"? The \"hard\" version of this operation, called argmax, simply finds\nthe maximum value, sets it to 1.0, and assigns 0.0 to all other values. In contrast, the softmax\noperation serves as a \"softer\" version of that. Due to the exponentiation involved in softmax, the\nlargest value is emphasized and pushed towards 1.0, while still maintaining a probability distribution\nover all input values. This allows for a more nuanced representation that captures not only the most\nlikely option but also the relative likelihood of other options.\n"]);return ep=function(){return e},e}function ex(){let e=o(["\n\nAfter the self-attention process, we have outputs from each of the heads. These outputs are the\nappropriately mixed V vectors, influenced by the Q and K vectors.\n\nTo combine the "," from each head, we simply stack them on top of each other. So, for time\n",", we go from 3 vectors of length "," to 1 vector of length ","."]);return ex=function(){return e},e}function ey(){let e=o(["\n\nIt's worth noting that in GPT, the length of the vectors within a head (",") is equal to "," / num_heads.\nThis ensures that when we stack them back together, we get the original length, ",".\n\nFrom here, we perform the projection to get the output of the layer. This is a simple matrix-vector\nmultiplication on a per-column basis, with a bias added."]);return ey=function(){return e},e}function eg(){let e=o(["\n\nNow we have the output of the self-attention layer. Instead of passing this output directly to the\nnext phase, we add it element-wise to the input embedding. This process, denoted by the green\nvertical arrow, is called the _residual connection_ or _residual pathway_.\n"]);return eg=function(){return e},e}function ev(){let e=o(["\n\nLike layer normalization, the residual pathway is important for enabling effective learning in deep\nneural networks.\n\nNow with the result of self-attention in hand, we can pass it onto the next section of the transformer:\nthe feed-forward network.\n"]);return ev=function(){return e},e}function eb(){let e=o(["\n\nThe next half of the transformer block, after the self-attention, is the MLP (multi-layer\nperceptron). A bit of a mouthful, but here it's a simple neural network with two layers.\n\nLike with self-attention, we perform a "," before the vectors enter the MLP.\n\nIn the MLP, we put each of our "," length column vectors (independently) through:\n\n1. A "," with a "," added, to a vector of length ",".\n\n2. A GELU activation function (element-wise)\n\n3. A "," with a "," added, back to a vector of length ","\n\nLet's track one of those vectors:\n"]);return eb=function(){return e},e}function ew(){let e=o(["\nWe first run through the matrix-vector multiplication with bias added, expanding the vector to length ",". (Note that the output matrix is transposed here.\nThis is purely for vizualization purposes.)\n"]);return ew=function(){return e},e}function e_(){let e=o(["\nNext, we apply the GELU activation function to each element of the vector. This is a key part of any neural network, where we introduce some non-linearity into the model. The specific function used, GELU,\nlooks a lot like a ReLU function (computed as ","), but it has a smooth curve rather than a sharp corner.\n\n","\n\n"]);return e_=function(){return e},e}function eA(){let e=o(["\nWe then project the vector back down to length "," with another matrix-vector multiplication with bias added.\n"]);return eA=function(){return e},e}function ek(){let e=o(["\nLike in the self-attention + projection section, we add the result of the MLP to its input, element-wise.\n"]);return ek=function(){return e},e}function eT(){let e=o(["\nWe can now repeat this process for all of the columns in the input."]);return eT=function(){return e},e}function eO(){let e=o(["\nAnd that's the MLP completed. We now have the output of the transformer block, which is ready to be passed to the next block.\n"]);return eO=function(){return e},e}let eB=()=>{function e(e,t,n,o){let l=(t-e)/(o-n),i=e-l*n;return e=>l*e+i}let t=e(0,200,-3.2,3.2),n=e(160,0,-1.46,3.66),o=(0,d.wA)(100,-3.2,3.2),l=[-1,1,2,3].map(e=>({x:t(0),y:n(e),label:e})),i=[-3,-2,-1,1,2,3].map(e=>({x:t(e),y:n(0),label:e})),r="gray";return(0,p.jsx)("div",{className:"flex justify-center my-2",children:(0,p.jsxs)("svg",{viewBox:"0 0 ".concat(200," ").concat(160),width:200,height:160,className:"bg-slate-200 rounded",children:[(0,p.jsx)("line",{x1:t(-3.2),x2:t(3.2),y1:n(0),y2:n(0),stroke:"gray",strokeWidth:1}),(0,p.jsx)("line",{x1:t(0),x2:t(0),y1:n(-1.46),y2:n(3.66),stroke:"gray",strokeWidth:1}),(0,p.jsx)("path",{d:function(e){let l="";for(let i of o){let o=e(i);l+=(l?"L":"M")+"".concat(t(i),",").concat(n(o)," ")}return l}(e=>.5*e*(1+Math.tanh(Math.sqrt(2/Math.PI)*(e+.044715*Math.pow(e,3))))),stroke:(0,m.c6)(m.Zy.Intermediates).toHexColor(),fill:"none",strokeWidth:3}),l.map((e,t)=>(0,p.jsxs)("g",{transform:"translate(".concat(e.x,", ").concat(e.y,")"),children:[(0,p.jsx)("line",{x1:-5,x2:5,y1:0,y2:0,stroke:r,strokeWidth:1}),(0,p.jsx)("text",{x:10,y:5,fontSize:10,fill:r,children:e.label})]},t)),i.map((e,t)=>(0,p.jsxs)("g",{transform:"translate(".concat(e.x,", ").concat(e.y,")"),children:[(0,p.jsx)("line",{x1:0,x2:0,y1:-5,y2:5,stroke:r,strokeWidth:1}),(0,p.jsx)("text",{x:0,y:18,fontSize:10,textAnchor:"middle",fill:r,children:e.label})]},t))]})})};function ez(){let e=o(["\n\nAnd that's a complete transformer block!\n\nThese form the bulk of any GPT model and are repeated a number of times, with the output of one\nblock feeding into the next, continuing the residual pathway.\n\nAs is common in deep learning, it's hard to say exactly what each of these layers is doing, but we\nhave some general ideas: the earlier layers tend to focus on learning\nlower-level features and patterns, while the later layers learn to recognize and understand\nhigher-level abstractions and relationships. In the context of natural language processing, the\nlower layers might learn grammar, syntax, and simple word associations, while the higher layers\nmight capture more complex semantic relationships, discourse structures, and context-dependent meaning.\n\n"]);return ez=function(){return e},e}function eE(){let e=o(['\n\nFinally, we come to the end of the model. The output of the final transformer block is passed through\na layer normalization, and then we use a linear transformation (matrix multiplication), this time without a bias.\n\nThis final transformation takes each of our column vectors from length C to length nvocab. Hence,\nit\'s effectively producing a score for each word in the vocabulary for each of our columns. These\nscores have a special name: logits.\n\nThe name "logits" comes from "log-odds," i.e., the logarithm of the odds of each token. "Log" is\nused because the softmax we apply next does an exponentiation to convert to "odds" or probabilities.\n\nTo convert these scores into nice probabilities, we pass them through a softmax operation. Now, for\neach column, we have a probability the model assigns to each word in the vocabulary.\n\nIn this particular model, it has effectively learned all the answers to the question of how to sort\nthree letters, so the probabilities are heavily weighted toward the correct answer.\n\nWhen we\'re stepping the model through time, we use the last column\'s probabilities to determine the\nnext token to add to the sequence. For example, if we\'ve supplied six tokens into the model, we\'ll\nuse the output probabilities of the 6th column.\n\nThis column\'s output is a series of probabilities, and we actually have to pick one of them to use\nas the next in the sequence. We do this by "sampling from the distribution." That is, we randomly\nchoose a token, weighted by its probability. For example, a token with a probability of 0.9 will be\nchosen 90% of the time.\n\nThere are other options here, however, such as always choosing the token with the highest probability.\n\nWe can also control the "smoothness" of the distribution by using a temperature parameter. A higher\ntemperature will make the distribution more uniform, and a lower temperature will make it more\nconcentrated on the highest probability tokens.\n\nWe do this by dividing the logits (the output of the linear transformation) by the temperature before\napplying the softmax. Since the exponentiation in the softmax has a large effect on larger numbers,\nmaking them all closer together will reduce this effect.\n']);return eE=function(){return e},e}function eR(){let e=o(["These vectors now pass through the stages of the model, going through a series of transformers.",""]);return eR=function(){return e},e}function eM(){let e=o(["Let's start at the top. To compute the vectors at each time "," we do a couple of steps:"]);return eM=function(){return e},e}function eP(){let e=o(["\n\n1. From the ",", select the ","'th column."],["\\n\\n1. From the ",", select the ","'th column."]);return eP=function(){return e},e}function eF(){var e,t,n,o;return{phase:null!==(n=null===(e=u.N.state)||void 0===e?void 0:e.phase)&&void 0!==n?n:a.Intro_Intro,time:null!==(o=null===(t=u.N.state)||void 0===t?void 0:t.phaseTime)&&void 0!==o?o:0,viewDt:0,dt:0,prevTime:0,prevPhase:a.None,running:!1,speed:1,cameraInitial:null,commentary:null,times:[],phaseLength:0,dimHighlightBlocks:null,markDirty:()=>{},phaseData:new Map,phaseTransitiveData:null,phaseList:[{groupId:r.Intro,title:"Introduction",phases:[{id:a.Intro_Intro,title:"Overview"},{id:a.Intro_Prelim,title:"Preliminary"}]},{groupId:r.Detailed_Input,title:"Detailed",phases:[{id:a.Input_Detail_Embedding,title:"Embedding"},{id:a.Input_Detail_LayerNorm,title:"Layer Norm"},{id:a.Input_Detail_SelfAttention,title:"Self Attention"},{id:a.Input_Detail_Projection,title:"Projection"},{id:a.Input_Detail_Mlp,title:"MLP"},{id:a.Input_Detail_Transformer,title:"Transformer"},{id:a.Input_Detail_Softmax,title:"Softmax"},{id:a.Input_Detail_Output,title:"Output"}]}]}}function eC(e){return e.phaseList.find(t=>t.phases.find(t=>t.id===e.phase))}function ej(e,t){let n=e.walkthrough;if(n.viewDt=t.dt,n.running){let e=t.dt/1e3*n.speed;n.time+=e,n.dt=e,n.time>n.phaseLength&&(n.running=!1,n.time=n.phaseLength),t.markDirty()}u.N.state={phase:n.phase,phaseTime:n.time,camera:e.camera},n.prevPhase!==n.phase&&(n.phaseTransitiveData=null),n.cameraInitial=null,n.times=[],n.phaseLength=0,n.dimHighlightBlocks=null;let o={state:e,layout:e.layout,tools:(0,m.Mb)(e),walkthrough:n},l=eC(n).groupId;l===r.Intro?(function(e){let{breakAfter:t,afterTime:n,c_str:o}=(0,m.Mb)(e.state),{state:l,layout:i,walkthrough:r}=e;if(r.phase!==a.Intro_Intro)return;if((0,m.w4)(l,new h.AO(184.744,0,-636.82),new h.AO(296,16,13.5)),(0,m.KE)(r,null,0)(A(),(0,m.$Z)(M)).t>0){for(let e of i.cubes)"i"===e.t&&e.access&&(e.access.disable=!0);l.display.tokenIdxModelOpacity=(0,d.VL)(6,0)}let c=n(null,1.5,.4);(0,m.o0)(e.state,c,new h.AO(5.45,0,7.913),new h.AO(281.5,12.5,.519));let u=n(null,1,.2);if(c.active&&(l.display.topOutputOpacity=.2),u.active&&u.t<1){let e=[0,0,0,0,0,0];for(let t=0;t<6;t++){let n=(t+1.5)/8;e[t]=1-(0,d.uZ)(4*Math.abs(u.t-n),0,1)}l.display.tokenColors={mixes:e,color2:(0,m.c6)(m.Zy.Token)}}t();let f=o("_token_",0,m.Zy.Token),p=o("_token index_",0,m.Zy.TokenIdx);(0,m.KE)(r,u)(k(),f,(0,m.$Z)(F),p,(0,m.$Z)(P)),t();let x=n(null,1.5,.5);if(x.active){let e=(0,d.VL)(6,0);for(let t=0;t<6;t++){let n=(t+1.5)/8;e[t]=(0,d.uZ)((x.t-n)*4,0,1)}l.display.tokenIdxColors={mixes:e,color2:(0,m.c6)(m.Zy.TokenIdx)};let t=6*x.t;if(x.t<1)for(let e of((0,s.n2)(i,i.idxObj,h.JU.X,t,(0,d.uZ)(6-t,0,1)),(0,s.L3)(i.idxObj,h.JU.X,null,Math.min(5,Math.floor(t)))))e.access&&(e.access.disable=!1);else i.idxObj.access&&(i.idxObj.access.disable=!1)}t(),t((0,m.KE)(r)(T(),(0,m.$Z)(C)));{let e=n(null,1,.5),t=n(null,2,.5);if((0,m.o0)(l,e,new h.AO(14.1,0,-30.4),new h.AO(286,14.5,.8)),t.active){let e=6*t.t,n=(0,d.uZ)(6-e,0,2),o=Math.min(5,Math.floor(e));if(t.t<1){for(let t of((0,s.n2)(i,i.idxObj,h.JU.X,e,n),(0,s.L3)(i.idxObj,h.JU.X,null,o)))t.access&&(t.access.disable=!1);for(let t of((0,s.n2)(i,i.residual0,h.JU.X,e,n),(0,s.L3)(i.residual0,h.JU.X,null,o)))t.access&&(t.access.disable=!1)}else i.residual0.access&&(i.residual0.access.disable=!1)}}t(),(0,m.KE)(r)(O()),t();{let e=n(null,1,.5);(0,m.o0)(l,e,new h.AO(-23.16,0,-128.38),new h.AO(292.3,26.8,2.4));let t=R(l,n(null,5,.5),i.blocks[0].attnResidual),o=n(null,1,.5);(0,m.o0)(l,o,new h.AO(-78.7,0,-274.2),new h.AO(299.4,14.7,4.3)),R(l,n(null,3.5,.5),i.blocks[0].mlpResidual,t),o.active&&(i.blocks[0].transformerLabel.visible=o.t);let r=n(null,1,.5);(0,m.o0)(l,r,new h.AO(-147,0,-744.1),new h.AO(298.5,23.4,12.2)),R(l,n(null,5,.5),i.ln_f.lnResid,t);let a=n(null,1,.5);(0,m.o0)(l,a,new h.AO(-58.4,0,-1654.9),new h.AO(271.3,6.4,1.1)),R(l,n(null,2,.5),i.logitsSoftmax,t);let s=n(null,1,.5);if(e.active){let e=(0,d.VL)(6,0);if(s.active)for(let t=0;t<6;t++){let n=(t+1.5)/8;e[t]=(0,d.uZ)((s.t-n)*4,0,1)}l.display.tokenOutputColors={color1:new h.T8(0,0,0,0),color2:h.T8.fromHexColor("#000",1),mixes:e}}}(0,m.KE)(r)(B()),(0,m.KE)(r)(z()),t()}(o),function(e){let{state:t,walkthrough:n}=e;n.phase===a.Intro_Prelim&&((0,m.w4)(t,new h.AO(184.744,0,-636.82),new h.AO(296,16,13.5)),(0,m.KE)(n,null,0)(I(),L("minGPT","https://github.com/karpathy/minGPT"),L("PyTorch","https://pytorch.org/"),L("Andrej Karpathy","https://karpathy.ai/"),L("Neural Networks: Zero to Hero","https://karpathy.ai/zero-to-hero.html")))}(o)):l===r.Detailed_Input&&(function(e){let{walkthrough:t,tools:{c_str:n,afterTime:o,atTime:l,atEvent:i,commentary:r,commentaryPara:u,cleanup:p},layout:x,state:y}=e,g=y.camera,v=y.render,b=y.display;switch(t.phase){case a.Input_First:{let e=n("",0);r(eR(),e);let t=o(i(e),0,2),l=o(t,5,.2);l.active||(g.centerDesired=new h.AO(0,0,-30),g.angleZDesired=1.2,g.angleDesired=new h.AO(290,20));let a=x.cubes.filter(e=>"i"===e.t),s=(0,f.JF)(0,a.length,l.t),c=Math.floor(s);for(let e=Math.min(c,a.length-1);e>=0&&l.active;e--){let t=1-(s-e)/8;if(t<0)break;a[e].highlight=.8*t}if(c<a.length-1){let e=a[c];(0,m.GB)(v,x,e)}break}case a.Input_Detail_Tables:{let e=l(0,.1,.2);e.t=1;let t=x.tokEmbedObj;(0,s.G)(v,"token-embedding matrix",new h.AO(t.x-x.margin,t.y+t.dy/4,0),{align:s._Y.Right,valign:s.Bk.Middle,color:new h.T8(0,0,0,1).mul(e.t),size:3});let n=x.posEmbedObj;(0,s.G)(v,"position-embedding matrix",new h.AO(n.x+n.dx+x.margin,t.y+t.dy/4,0),{align:s._Y.Left,valign:s.Bk.Middle,color:new h.T8(0,0,0,1).mul(e.t),size:3}),(0,s.jy)(y,x,t,h.JU.X,m.Zy.n_vocab,e.t),(0,s.jy)(y,x,t,h.JU.Y,m.Zy.C,e.t),(0,s.jy)(y,x,n,h.JU.X,m.Zy.T,e.t),(0,s.jy)(y,x,n,h.JU.Y,m.Zy.C,e.t),(0,s.jy)(y,x,x.residual0,h.JU.X,m.Zy.T,e.t),(0,s.jy)(y,x,x.residual0,h.JU.Y,m.Zy.C,e.t)}break;case a.Input_Detail_TokEmbed:{var w,_;let e=n("t",1),t=r(eM(),e);(0,m.o0)(y,l(0),new h.AO(0,0,0),new h.AO);let i=l(0,.1,.2),a=o(i,1,.2),g=o(a,.1,.4),A=o(g,.2,1),k=o(A,.4,1),T=o(k,1,1),O=o(T,.3,1);p(O,[i,g,k,T]);let B=o(O,5,0),z=null!==(_=null===(w=x.model)||void 0===w?void 0:w.inputBuf[3])&&void 0!==_?_:1;if(O.t<1){let e=(0,f.t7)(0,3,a.t),t=(0,f.JF)(1*i.t,3,g.t);(0,s.Sl)(v,x,x.residual0,h.JU.X,m.Zy.t,e,t/2,i.t),(0,s.n2)(x,x.residual0,h.JU.X,e+.5,t),(0,s.n2)(x,x.idxObj,h.JU.X,e+.5,t)}let E=n("token embedding matrix"),R=n("j");u(t)(eP(),E,R);let M=new h.T8(.5,.5,.5).mul(.6);if(x.model&&B.t<=0){let e=Array(x.tokEmbedObj.cx).fill(0);e[x.model.inputBuf[3]]=k.t,(0,s.Vz)(v,x,x.tokEmbedObj,M,A.t,3,0,null,{color2:(0,m.c6)(m.Zy.n_vocab),mixes:e})}if(x.model&&k.t>0&&O.t<=1){(0,s.n2)(x,x.tokEmbedObj,h.JU.X,z,0),(0,s.L3)(x.tokEmbedObj,h.JU.X,z,z)[0].highlight=(0,f.t7)(0,.2,k.t),b.tokenColors={color2:(0,m.c6)(m.Zy.n_vocab),mixes:(0,d.BF)(x.idxObj.cx,3,k.t)};let e=.3*x.cell,t=.3*x.cell+3,n=(0,m.c6)(m.Zy.n_vocab).mul(k.t);(0,s.or)(v,x,x.idxObj,x.tokEmbedObj,n,e,t,3,z,.5)}if(x.model&&B.t<1&&(0,m.GB)(v,x,x.residual0),x.model&&T.t>0&&O.t<=0){let e=(0,s.L3)(x.residual0,h.JU.X,3,3)[0];if(e){e.access={...e.access,src:x.model.vocabEmbed.output,disable:!1};let t=T.t*e.cy,n=Math.floor(t);for(let o of(n<e.cy&&((0,s.Yf)(v,x,x.tokEmbedObj,x.residual0,new h.AO(z,n,0),new h.AO(3,n,0),new h.T8(1,0,0,1)),(0,c.jF)(v.threadRender,x,e,h.JU.Y,0,0,1,n+1,new h.T8(1,0,0,1)),(0,c.jF)(v.threadRender,x,x.tokEmbedObj,h.JU.Y,z,0,1,n+1,new h.T8(1,0,0,1)),(0,c.jF)(v.threadRender,x,x.posEmbedObj,h.JU.Y,3,0,1,n+1,new h.T8(1,0,0,1))),(0,s.n2)(x,e,h.JU.Y,t,0),(0,s.L3)(e,h.JU.Y,Math.floor(t)+1,null)))o.access={...e.access,disable:!0}}}if(x.model&&B.active){let e=x.idxObj.cx,t=x.residual0.cy,n=B.t*e,o=Math.floor(n),l=(n-o)*t,i=x.model.inputBuf[o];for(let t of(b.tokenColors={color2:(0,m.c6)(m.Zy.n_vocab),mixes:(0,d.BF)(e,o,1)},(0,s.n2)(x,x.residual0,h.JU.X,o+.5,0),(0,s.L3)(x.residual0,h.JU.X,null,o-1)))t.access={...t.access,disable:!1};let r=(0,s.L3)(x.residual0,h.JU.X,o,o)[0];if(r){r.highlight=.2,r.access={...r.access,disable:!1};let e=l+.5,t=Math.floor(l),n=new h.T8(1,0,0,1).mul(.3);for(let a of((0,s.Yf)(v,x,x.tokEmbedObj,x.residual0,new h.AO(i,t,0),new h.AO(o,t,0),n),(0,s.Yf)(v,x,x.posEmbedObj,x.residual0,new h.AO(o,t,0),new h.AO(o,t,0),n),(0,c.jF)(v.threadRender,x,x.residual0,h.JU.Y,o,0,1,t+1,new h.T8(1,0,0,1)),(0,c.jF)(v.threadRender,x,x.tokEmbedObj,h.JU.Y,i,0,1,t+1,new h.T8(1,0,0,1)),(0,c.jF)(v.threadRender,x,x.posEmbedObj,h.JU.Y,o,0,1,t+1,new h.T8(1,0,0,1)),(0,s.n2)(x,r,h.JU.Y,e,0),(0,s.L3)(r,h.JU.Y,Math.floor(l)+1,null)))a.access={...a.access,disable:!0}}let a=(0,d.BF)(x.tokEmbedObj.cx,i,1);(0,s.Vz)(v,x,x.tokEmbedObj,M,A.t,3,0,null,{color2:(0,m.c6)(m.Zy.n_vocab),mixes:a});let u=.3*x.cell,f=.3*x.cell+3,p=(0,m.c6)(m.Zy.n_vocab).mul(A.t);(0,s.or)(v,x,x.idxObj,x.tokEmbedObj,p,u,f,o,i,.5);let y=(0,s.n2)(x,x.tokEmbedObj,h.JU.X,i+.5,0);y&&(y.highlight=.2);let g=(0,s.n2)(x,x.posEmbedObj,h.JU.X,o+.5,0);g&&(g.highlight=.2)}}}}(o),function(e){var t;let{walkthrough:n,state:o,tools:{c_str:l,c_blockRef:i,c_dimRef:r,afterTime:c,cleanup:u,breakAfter:d},layout:p}=e,x=o.render;if(n.phase!==a.Input_Detail_Embedding)return;(0,m.w4)(o,new h.AO(15.654,0,-80.905),new h.AO(287,14.5,3.199)),n.dimHighlightBlocks=[p.idxObj,p.tokEmbedObj,p.posEmbedObj,p.residual0],(0,m.KE)(n)(X(),i("_token indices_",o.layout.idxObj,m.Zy.TokenIdx),i("_input embedding_",o.layout.residual0)),d();let y=c(null,1),g=c(null,.3);d(),(0,m.KE)(n)(W(),l("B",m.Zy.Token),r("1",m.Zy.TokenIdx),i("_token embedding matrix_",o.layout.tokEmbedObj),r("_C_ = 48",m.Zy.C)),d();let v=c(null,.3),b=c(null,.8);d(),(0,m.KE)(n)(Z(),l("B",m.Zy.Token),r("3",m.Zy.T),i("_position embedding matrix_",o.layout.posEmbedObj),r("_C_ = 48",m.Zy.C)),d();let w=c(null,.8);d(),(0,m.KE)(n)(Y(),r("_C_ = 48",m.Zy.C)),d();let A=c(null,.8),k=c(null,.8),T=c(null,.8),O=c(null,.8),B=c(null,.8),z=c(null,0),M=c(null,.8);d(),(0,m.KE)(n)(V()),d();let P=c(null,5);d(),(0,m.KE)(n)(G(),i("_input embedding_",o.layout.residual0),r("_T_",m.Zy.T),r("_C_",m.Zy.C),r("_T_",m.Zy.T),r("_time_",m.Zy.T),r("_C_",m.Zy.C),r("_channel_",m.Zy.C),r("_C_",m.Zy.C),i("_input embedding_",o.layout.residual0),r("T",m.Zy.T),r("C",m.Zy.C)),u(z,[A,k,T,O,B]),u(M,[g,v,b,w]),(0,m.o0)(o,y,new h.AO(7.6,0,-33.1),new h.AO(290,15.5,.8));let F=null;(g.t>0||M.t>0)&&0===P.t&&((0,s.n2)(p,p.idxObj,h.JU.X,3.5,4*g.t),p.residual0.access.disable=!0,p.residual0.opacity=(0,f.t7)(1,.1,v.t),(F=(0,s.n2)(p,p.residual0,h.JU.X,3.5,4*g.t)).highlight=.3,F.opacity=(0,f.t7)(1,0,v.t));let C=null!==(t=(0,_._n)(p.idxObj,new h.AO(3,0,0)))&&void 0!==t?t:1,j=null,D=null;if(b.t>0){let e=(0,s.n2)(p,p.tokEmbedObj,h.JU.X,C+.5,4*b.t);(j=(0,s.Z2)(p,e)).t="i",e.highlight=.3;let t=new h.AO(e.x,e.y,e.z),n=new h.AO(F.x,F.y,F.z).add(new h.AO(-2,0,3)),o=t.lerp(n,A.t);j.x=o.x,j.y=o.y,j.z=o.z}if(w.t>0){let e=(0,s.n2)(p,p.posEmbedObj,h.JU.X,3.5,4*w.t);(D=(0,s.Z2)(p,e)).t="i",e.highlight=.3;let t=new h.AO(e.x,e.y,e.z),n=new h.AO(F.x,F.y,F.z).add(new h.AO(2,0,3)),o=t.lerp(n,k.t);D.x=o.x,D.y=o.y,D.z=o.z}if(T.t>0&&j&&D&&O.t<1)for(let e=0;e<p.shape.C;e++){let t=new h.AO((j.x+j.dx+D.x)/2,j.y+p.cell*(e+.5),j.z+j.dz/2),n=T.t>(e+1)/p.shape.C,o=(0,f.t7)(0,1,n?1:0),l={color:new h.T8(0,0,0,1).mul(o),size:1.5,mtx:N.OO.fromTranslation(t)},i=(0,S.X1)(x.modelFontBuf,"+",l);(0,S.yU)(x.modelFontBuf,"+",-i/2,-l.size/2,l)}let I=F?new h.AO(F.x,F.y,F.z):new h.AO,L=I.add(new h.AO(0,0,3));if(O.t>0&&j&&D){let e=new h.AO(j.x,j.y,j.z),t=new h.AO(D.x,D.y,D.z),n=e.lerp(L,O.t),o=t.lerp(L,O.t);j.x=n.x,j.y=n.y,j.z=n.z,D.x=o.x,D.y=o.y,D.z=o.z,O.t>.95&&(j.opacity=0,D.opacity=0,F.opacity=1,F.highlight=0,F.access.disable=!1,F.x=L.x,F.y=L.y,F.z=L.z)}if(B.t>0){let e=L.lerp(I,B.t);F.x=e.x,F.y=e.y,F.z=e.z}if(z.t>0&&F&&(F.opacity=1,F.highlight=0,F.access.disable=!1),P.t>0){p.residual0.access.disable=!0;let e=E(o,p.residual0);R(o,P,p.residual0,e)}}(o),function(e){let{walkthrough:t,layout:n,state:o,tools:{afterTime:l,c_str:i,c_blockRef:r,c_dimRef:c,breakAfter:u,cleanup:x}}=e,{C:y}=n.shape;if(t.phase!==a.Input_Detail_LayerNorm)return;let g=n.blocks[0].ln1;(0,m.w4)(o,new h.AO(-6.68,0,-65.256),new h.AO(281,9,2.576)),t.dimHighlightBlocks=[n.residual0,...g.cubes],(0,m.KE)(t,null,0)(H(),r("_input embedding_",o.layout.residual0)),u();let v=l(null,1),b=l(null,1,1),A=l(null,1),k=l(null,.5);u(),(0,m.KE)(t)(J(),c("t = 3",m.Zy.T)),u();let T=l(null,.5);u(),(0,m.KE)(t)(q(),r("mean (μ)",g.lnAgg1),r("std dev (σ)",g.lnAgg2)),u();let O=l(null,.5),B=l(null,.5);u(),(0,m.KE)(t)(Q(),c("C",m.Zy.C),(0,p.jsxs)(p.Fragment,{children:["1\xd710",(0,p.jsx)("sup",{children:"-5"})]}),r("weight (γ)",g.lnSigma),r("bias (β)",g.lnMu),r("normalized values",g.lnResid)),u(),x(l(null,.2),[O,B]);let z=l(null,2);u(),(0,m.KE)(t)(K(),r("input embedding matrix",n.residual0),r("normalized input embedding",g.lnResid)),u();let M=l(null,.5);x(M,[T]),M.t>0&&(z.t=0);let P=l(null,2),F=l(null,6);(0,m.o0)(o,v,new h.AO(21.2,0,-102.9),new h.AO(281.5,11,1.7));let C=n.blocks[0].ln1,j=n.residual0;j.highlight=(0,f.t7)(0,.3,b.t);let D=new Set([n.residual0,...C.cubes]);for(let e of n.cubes)D.has(e)||(e.opacity=(0,f.t7)(1,0,b.t));for(let e of D)e!=n.residual0&&"w"!==e.t&&(e.access.disable=!0);let I=n.residual0.y,L=C.lnResid.y;n.residual0.y=(0,f.t7)(I,L,A.t),A.t>=0&&(j.highlight=(0,f.t7)(.3,0,A.t)),(0,m.o0)(o,k,new h.AO(-14.1,0,-187.1),new h.AO(270,4,.7));let U=(0,f.t7)(0,2,T.t),S=(0,f.t7)(1,.3,T.t);if(C.lnAgg1.opacity=S,C.lnAgg2.opacity=S,C.lnResid.opacity=S,j.opacity=S,T.t>0){let e=(0,s.n2)(n,C.lnAgg1,h.JU.X,3.5,U),t=(0,s.n2)(n,C.lnAgg2,h.JU.X,3.5,U),l=(0,s.n2)(n,C.lnResid,h.JU.X,3.5,U),i=(0,s.n2)(n,j,h.JU.X,3.5,U);e.opacity=1,t.opacity=1,l.opacity=1,i.opacity=1;let r=new h.AO(3,0,0);if(O.t>0){let t=new h.AO(0,10,0);(0,w.Tl)(o,C.lnAgg1,r),(0,_.iW)(o,C.lnAgg1,r,t),e.access.disable=!1,i.highlight=.3}if(B.t>0){let e=new h.AO(9,9,0);(0,w.Tl)(o,C.lnAgg2,r),(0,_.iW)(o,C.lnAgg2,r,e),t.access.disable=!1}if(z.t>0){e.access.disable=!1,t.access.disable=!1;let i=new h.AO(-10,0,0),r=z.t*y,a=(0,d.uZ)(Math.floor(r),0,y-1),c=new h.AO(3,a,0);(0,w.Tl)(o,C.lnResid,c),(0,_.iW)(o,C.lnResid,c,i),(0,s.n2)(n,l,h.JU.Y,a+.5,0).highlight=.3,(0,s.L3)(l,h.JU.Y,0,a).forEach(e=>{e.access.disable=!1})}}if(P.t>0)try{let e=E(o,C.lnAgg1);R(o,P,C.lnAgg2,e),R(o,F,C.lnResid,e)}catch(e){console.log(e)}}(o),function(e){let t,n,o,l,{walkthrough:i,layout:r,state:c,tools:{afterTime:u,c_str:x,c_blockRef:y,c_dimRef:g,breakAfter:v,cleanup:b}}=e,{C:A,A:k,nHeads:T}=r.shape;if(i.phase!==a.Input_Detail_SelfAttention)return;let O=r.blocks[0],B=O.heads[2];(0,m.w4)(c,new h.AO(-125.258,0,-178.805),new h.AO(294,12.8,2.681)),i.dimHighlightBlocks=[r.residual0,O.ln1.lnResid,...B.cubes],(0,m.KE)(i,null,0)(et()),v();let z=u(null,1),M=u(null,2),P=u(null,1),F={t0_dissolveHeads:(t=e.tools.afterTime)(null,1,.5),t2_alignqkv:t(null,1,.5)};v(),(0,m.KE)(i)(en(),g("T",m.Zy.T),y("normalized input embedding matrix",O.ln1.lnResid),U((0,p.jsxs)("ul",{children:[(0,p.jsxs)("li",{children:["Q: ",(0,p.jsx)(ee.T,{blk:B.qBlock,children:"Query vector"})]}),(0,p.jsxs)("li",{children:["K: ",(0,p.jsx)(ee.T,{blk:B.kBlock,children:"Key vector"})]}),(0,p.jsxs)("li",{children:["V: ",(0,p.jsx)(ee.T,{blk:B.vBlock,children:"Value vector"})]})]})),y("Q vectors",B.qBlock),y("Q-weight matrix",B.qWeightBlock),y("input matrix",O.ln1.lnResid)),v();let C=u(null,1),j=u(null,3);v(),(0,m.KE)(i)(eo()),v();let D=u(null,2,.5),I=u(null,1,.5),L=u(null,2),X=u(null,2,.5),W=u(null,1,.5),Z=u(null,2,.5),Y=u(null,.5);v(),(0,m.KE)(i)(el()),v(),b(u(null,.25,.5),[C]);let V=u(null,5);v(),(0,m.KE)(i)(ei(),U((0,p.jsxs)("div",{className:"ml-4",children:[(0,p.jsx)("div",{className:"mt-1 text-center italic",children:"Software analogy"}),(0,p.jsx)("div",{className:"text-sm mt-1 mb-1 text-gray-600",children:"Lookup table:"}),(0,p.jsx)("div",{className:"font-mono",children:'table = { "key0": "value0", "key1": "value1", ... }'}),(0,p.jsx)("div",{className:"text-sm mt-1 mb-1 text-gray-600",children:"Query Process:"}),(0,p.jsx)("div",{className:"font-mono",children:'table["key1"] => "value1"'})]})),U((n=(0,m.c6)(m.Zy.Intermediates),o=(0,m.c6)(m.Zy.A),l=(0,m.c6)(m.Zy.Aggregates),(0,p.jsxs)("div",{className:"ml-4",children:[(0,p.jsx)("div",{className:"mt-1 text-center italic",children:"Self Attention"}),(0,p.jsx)("div",{className:"text-sm mt-2 mb-1 text-gray-600",children:"Lookup table:"}),(0,p.jsxs)("div",{className:"font-mono flex items-center",children:["K:",(0,p.jsx)("div",{className:"mx-2 my-1",children:em(n)}),(0,p.jsx)("div",{className:"mx-2 my-1",children:em(n)}),(0,p.jsx)("div",{className:"mx-2 my-1",children:em(n)})]}),(0,p.jsxs)("div",{className:"font-mono flex items-center",children:["V:",(0,p.jsx)("div",{className:"mx-2 my-1",children:em(o)}),(0,p.jsx)("div",{className:"mx-2 my-1",children:em(o)}),(0,p.jsx)("div",{className:"mx-2 my-1",children:em(o)})]}),(0,p.jsx)("div",{className:"text-sm mt-2 mb-1 text-gray-600",children:"Query Process:"}),(0,p.jsx)("div",{className:"font-mono flex items-center",children:(0,p.jsxs)("div",{className:"flex items-center",children:["Q: ",(0,p.jsx)("div",{className:"mx-2 my-1",children:em(l)})]})}),(0,p.jsxs)("div",{className:"font-mono flex items-center -ml-2 mt-2",children:[(0,p.jsxs)("div",{className:"flex items-center mx-2",children:["w0 = ",(0,p.jsx)("div",{className:"m-1",children:em(l)}),".",(0,p.jsx)("div",{className:"m-1",children:em(n)})]}),(0,p.jsxs)("div",{className:"flex items-center mx-2",children:["w1 = ",(0,p.jsx)("div",{className:"m-1",children:em(l)}),".",(0,p.jsx)("div",{className:"m-1",children:em(n)})]}),(0,p.jsxs)("div",{className:"flex items-center mx-2",children:["w2 = ",(0,p.jsx)("div",{className:"m-1",children:em(l)}),".",(0,p.jsx)("div",{className:"m-1",children:em(n)})]})]}),(0,p.jsxs)("div",{className:"font-mono flex items-center my-2",children:["[w0n, w1n, w2n] =\xa0",(0,p.jsx)("span",{className:"italic",children:"normalization"}),"([w0, w1, w2])"]}),(0,p.jsxs)("div",{className:"font-mono flex items-center",children:["result = w0n * ",(0,p.jsx)("div",{className:"ml-2 mr-2 my-1",children:em(o)}),"\xa0+\xa0 w1n * ",(0,p.jsx)("div",{className:"ml-2 mr-2 my-1",children:em(o)}),"\xa0+\xa0 w2n * ",(0,p.jsx)("div",{className:"ml-2 mr-2 my-1",children:em(o)})]})]}))),g("t = 5",m.Zy.T)),v();let G=u(null,1);v(),(0,m.KE)(i)(er(),y("Q vector",B.qBlock),g("t = 5",m.Zy.T),y("K vectors",B.kBlock),g("t = 5",m.Zy.T),y("attention matrix",B.attnMtx)),v();let H=u(null,3);v(),(0,m.KE)(i)(ea(),g("A",m.Zy.A),g("A",m.Zy.A)),v();let J=u(null,1),q=u(null,2);v(),(0,m.KE)(i)(es(),g("t = 5",m.Zy.T),g("t = 5",m.Zy.T),y("normalized self-attention matrix",B.attnMtxSm),y("V vector",B.vBlock)),v();let Q=u(null,.4,.5),K=u(null,1,.5),ep=u(null,1,.5),ex=u(null,1,.5),ey=u(null,1,.5),eg=u(null,1,.5),ev=u(null,.5,.5);v(),(0,m.KE)(i)(ec()),v();let eb=u(null,.5,.5);b(eb,[G]);let ew=u(null,8);if(v(),(0,m.KE)(i)(eu()),(0,m.o0)(c,z,new h.AO(-192.1,0,-214.8),new h.AO(293.5,49,2.3)),(0,m.o0)(c,P,new h.AO(-92.7,0,-219),new h.AO(286,12.8,1.4)),M.t>0){O.selfAttendLabel.visible=(0,f.t7)(0,1,10*M.t);let e=M.t*T,t=(0,d.uZ)(Math.floor(e),0,T-1),n=(0,f.t7)(0,1,(e-t)/.3),o=O.heads[t];for(let e of(o.headLabel.visible=n,o.headLabel.cubes))e.highlight=.4*n}if(F.t0_dissolveHeads.t>0){let e=O.heads[2],t=F.t0_dissolveHeads.t;for(let n of e.headLabel.cubes)n.highlight=.4*(0,f.t7)(1,0,4*t);B.qBlock.access.disable=!0,B.kBlock.access.disable=!0,B.vBlock.access.disable=!0}if(function(e,t){let{layout:n}=e,{t0_dissolveHeads:o,t2_alignqkv:l}=t,i=n.blocks[0].heads[2],r=n.blocks[0];for(let e=0;e<r.heads.length;e++)if(2!=e)for(let t of r.heads[e].cubes)t.opacity=(0,f.JF)(1,0,o.t);{let e=i.attnMtx.z,t=r.ln1.lnResid.z,n=(0,f.JF)(0,t-e,l.t);for(let e of i.cubes)e.z+=n}{let e=[[i.qBlock,i.qWeightBlock,i.qBiasBlock],[i.kBlock,i.kWeightBlock,i.kBiasBlock],[i.vBlock,i.vWeightBlock,i.vBiasBlock]],t=r.ln1.lnResid.z,o=i.qBlock.dy+n.margin,s=i.qBlock.y,c=[-(2*o),-o,0];for(let n=0;n<3;n++){let o=(0,f.JF)(e[n][0].y,s+c[n],l.t),i=(0,f.JF)(e[n][0].z,t,l.t);for(let t of e[n])t.y=o,t.z=i}let u=e=>e.y+e.dy/2,d=n.cubes.indexOf(r.ln1.lnResid),h=(0,f.JF)(0,u(r.ln1.lnResid)-u(i.kBlock),l.t);for(let e=0;e<d;e++)n.cubes[e].opacity=(0,f.JF)(1,.2,l.t);let m=!1;for(let e=d+1;e<n.cubes.length;e++){let t=n.cubes[e];if(t.y+=h,m){var a;t.opacity=Math.min((0,f.JF)(1,.2,l.t),null!==(a=t.opacity)&&void 0!==a?a:1)}m=m||t===i.vOutBlock}}}(e,F),(0,m.o0)(c,I,new h.AO(-53,0,-155.5),new h.AO(274.1,8.5,.4)),(0,m.o0)(c,W,new h.AO(-92.7,0,-219),new h.AO(286,12.8,1.4)),C.t>0){let t=(0,f.t7)(1,.2,C.t);B.qBlock.opacity=t,B.kBlock.opacity=t,B.vBlock.opacity=t,O.ln1.lnResid.opacity=t;let n=(0,f.t7)(0,2,C.t),o=(0,s.n2)(r,B.qBlock,h.JU.X,3.5,n),l=(0,s.n2)(r,O.ln1.lnResid,h.JU.X,3.5,n);if(o.opacity=1,l.opacity=1,j.t>0){let e=j.t*k,t=(0,d.uZ)(Math.floor(e),0,k-1),n=new h.AO(3,t,0),i=new h.AO(3,0,0);for(let e of((0,w.Tl)(c,B.qBlock,n),(0,_.iW)(c,B.qBlock,n,i),(0,s.n2)(r,o,h.JU.Y,t+.5,0),(0,s.L3)(o,h.JU.Y,null,t)))e.access.disable=!1;l.highlight=.3}let i=new h.AO(l.x-26,l.y,l.z+5),a=new h.AO(i.x+r.cell,i.y-12*r.cell,i.z),u=new h.AO(a.x-3*r.cell,a.y,a.z);if(D.t>0&&0===Y.t){let t=(0,s.L3)(B.qWeightBlock,h.JU.Y,k-1,null)[0],n=(0,s.BE)(r,t,h.JU.X),o=(0,s.BE)(r,l,h.JU.Y),d=0;for(let t=0;t<A;t++){let l=t/(A-1),s=.5*(1-l),u=ed(s,s+.5,D.t),p=(0,$.wD)(n[t]),x=i.add(new h.AO(0,t*r.cell*1.2)),y=(0,$.wD)(o[t]),g=i.add(new h.AO(2*r.cell,t*r.cell*1.2));W.t>0&&(x=g=new h.AO(i.x+r.cell,i.y-12*r.cell,x.z)),(0,$.Rp)(n[t],p.tl.lerp(x,u)),(0,$.Rp)(o[t],y.tl.lerp(g,u));let v=(0,f.t7)(0,.15,L.t)+(0,f.t7)(0,.85,X.t),b=.9*l,w=ed(b,b+.1,v);if(w>0&&0==W.t){let e=(0,$.wD)(n[t]),l=(0,$.wD)(o[t]),i=new h.AO((0,f.t7)(e.tl.x,a.x,2*w),(0,f.t7)(e.tl.y,a.y,w),e.tl.z),s=new h.AO((0,f.t7)(l.tl.x,a.x,2*w),(0,f.t7)(l.tl.y,a.y,w),e.tl.z);if((0,$.Rp)(n[t],i),(0,$.Rp)(o[t],s),t>0&&w>0){let t=new h.AO((0,f.t7)(e.br.x,l.tl.x,.5),(0,f.t7)(d,i.y,.5),e.tl.z+r.cell/2),n=N.OO.fromTranslation(t),o={color:m.wL.Black,size:1.5,mtx:n},a=(0,S.X1)(c.render.modelFontBuf,"+",o);(0,S.yU)(c.render.modelFontBuf,"+",-a/2,-o.size/2,o)}d=i.y+r.cell}u>=1&&eh(e,n[t],o[t],h.JU.X,"x",{size:1.5,color:m.wL.Black})}if(Z.t>=0){let t=(0,s.L3)(B.qBiasBlock,h.JU.Y,k-1,null)[0],o=(0,$.wD)(t),l=o.tl.lerp(u,ed(0,.4,Z.t));(0,$.Rp)(t,l);let i=ed(.6,1,Z.t);l=(o=(0,$.wD)(t)).tl.lerp(a,i),(0,$.Rp)(t,l),Z.t>.4&&eh(e,t,n[n.length-1],h.JU.X,"+",{size:1.5,color:m.wL.Black})}}if(Y.t>0){let e=(0,s.L3)(B.qWeightBlock,h.JU.Y,k-1,null)[0];(0,s.L3)(B.qBiasBlock,h.JU.Y,k-1,null)[0].opacity=Y.t,e.opacity=Y.t,l.opacity=Y.t;let t=(0,s.L3)(o,h.JU.Y,k-1,null)[0],n=(0,$.wD)(t).tl.lerp(a,1-Y.t);(0,$.Rp)(t,n)}}if(V.t>0){let e=E(c,B.qBlock);R(c,V,B.vBlock,e)}if(G.t>0&&ew.t<=0){let e=(0,f.t7)(1,.2,G.t);B.qBlock.opacity=e,B.kBlock.opacity=e,B.vBlock.opacity=e;let t=(0,s.n2)(r,B.qBlock,h.JU.X,5.5,0);for(let e of((0,s.n2)(r,B.kBlock,h.JU.X,5.5,0),(0,s.n2)(r,B.vBlock,h.JU.X,5.5,0),[...(0,s.L3)(B.kBlock,h.JU.X,null,5),...(0,s.L3)(B.vBlock,h.JU.X,null,5),t]))e.opacity=1;B.attnMtx.access.disable=!0,B.attnMtxSm.access.disable=!0,B.attnMtxAgg1.access.disable=!0,B.attnMtxAgg2.access.disable=!0,B.qBlock.opacity=1,B.kBlock.opacity=1,B.vBlock.opacity=1}if((0,m.o0)(c,G,new h.AO(-91.5,0,-227.9),new h.AO(270.1,-38.4,.8)),H.t>0&&ew.t<=0){let e=(0,d.uZ)(Math.floor(6*H.t),0,5),t=new h.AO(e,5,0),n=new h.AO(5,0,0);J.t<=0&&((0,w.Tl)(c,B.attnMtx,t),(0,_.iW)(c,B.attnMtx,t,n));let o=(0,s.n2)(r,B.attnMtx,h.JU.Y,5,0);for(let t of((0,s.n2)(r,o,h.JU.X,e,0),(0,s.L3)(o,h.JU.X,null,e)))t.access.disable=!1}if(J.t>0&&ew.t<=0){let e=ed(0,.5,J.t),t=ed(.5,1,J.t),n=q.t>0;ef(c,B.attnMtxAgg2,h.JU.Y,5,e,{pinIdx:new h.AO(5,0,0),clamp:!0,hidePopup:n}),t>0&&ef(c,B.attnMtxAgg1,h.JU.Y,5,t,{pinIdx:new h.AO(-12,0,0),clamp:!0,hidePopup:n})}if(q.t>0&&ew.t<=0){let e=Q.t>0;ef(c,B.attnMtxSm,h.JU.Y,5,q.t,{pinIdx:new h.AO(5,0,0),clamp:!0,maxIdx:6,hidePopup:e})}Q.t>0&&ew.t<=0&&(B.vOutBlock.access.disable=!0);{(0,m.o0)(c,Q,new h.AO(-91.9,0,-267.9),new h.AO(270.1,-7.5,.7));let t=(0,$.wD)(B.vBlock).tl.add(new h.AO(0,4,5)),n=t.add(new h.AO(0,r.cell*(k/2-.5)));if(K.t>0&&eg.t<=0){let o=[];for(let e of(0,s.L3)(B.vBlock,h.JU.X,null,5))o.push(...(0,s.BE)(r,e,h.JU.X));let l=[],i=(0,s.L3)(B.attnMtxSm,h.JU.Y,5,5)[0];for(let e of(0,s.L3)(i,h.JU.X,null,5))for(let t of(0,s.BE)(r,e,h.JU.X))l.push((0,s.Z2)(r,t));for(let i=0;i<6;i++){var e_;let a=null!==(e_=(0,_._n)(B.attnMtxSm,new h.AO(i,5,0)))&&void 0!==e_?e_:.2,s=(0,$.wD)(o[i]).tl,c=t.add(new h.AO(i*r.cell*5,0,0));(0,$.Rp)(o[i],s.lerp(c,K.t));let u=(0,$.wD)(l[i]).tl,d=n.add(new h.AO(i*r.cell*5-2*r.cell,0));(0,$.Rp)(l[i],u.lerp(d,ep.t)),ex.t>0&&(d=(u=d).add(new h.AO(2*r.cell,0)),(0,$.Rp)(l[i],u.lerp(d,ex.t)),l[i].opacity=1-ex.t,o[i].highlight=(0,f.t7)(0,1.5*a,ex.t)),ep.t>.8&&ex.t<.7&&eh(e,o[i],l[i],h.JU.X,"x",{color:m.wL.Black,size:1.5}),ey.t>0&&(s=c,c=t.add(new h.AO(0,0,1*a)),(0,$.Rp)(o[i],s.lerp(c,ey.t))),ex.t>.6&&i>0&&ey.t<.7&&eh(e,o[i-1],o[i],h.JU.X,"+",{color:m.wL.Black,size:1.5})}}if(eg.t>0&&ev.t<=0){let e=ed(0,.5,eg.t),n=(0,s.n2)(r,B.vOutBlock,h.JU.X,5.5,2*e);for(let t of(n.access.disable=!0,n.opacity=(0,f.t7)(1,0,e),(0,s.L3)(B.vBlock,h.JU.X,null,5)))t.opacity=eg.t;let o=(0,s.Z2)(r,n);o.access.disable=!1,o.opacity=1;let l=(0,$.wD)(n).tl;(0,$.Rp)(o,t.lerp(l,eg.t))}if(ev.t>0){let e=2*(0,f.t7)(1,0,ev.t);(0,s.n2)(r,B.vOutBlock,h.JU.X,5.5,e).access.disable=!1}}if((0,m.o0)(c,eb,new h.AO(-99.7,0,-230.1),new h.AO(275.6,-4.4,1.2)),ew.t>0){for(let e of[B.attnMtx,B.attnMtxSm,B.attnMtxAgg1,B.attnMtxAgg2,B.vOutBlock])e.access.disable=!0;let e=E(c,B.attnMtx);R(c,ew,B.vOutBlock,e)}}(o),function(e){let{walkthrough:t,state:n}=e;t.phase===a.Input_Detail_Softmax&&((0,m.w4)(n,new h.AO(-24.35,0,-1702.195),new h.AO(283.1,.6,1.556)),(0,m.KE)(t,null,0)(ep()))}(o),function(e){let{walkthrough:t,state:n,layout:o,tools:{breakAfter:l,afterTime:i,c_blockRef:r,c_dimRef:s,cleanup:c}}=e;if(t.phase!==a.Input_Detail_Projection)return;(0,m.w4)(n,new h.AO(-73.167,0,-270.725),new h.AO(293.606,2.613,1.366));let u=o.blocks[0];t.dimHighlightBlocks=[...u.heads.map(e=>e.vOutBlock),u.projBias,u.projWeight,u.attnOut];let d=u.heads.map(e=>e.vOutBlock);(0,m.KE)(t,null,0)(ex(),r("output vectors",d),s("t = 4",m.Zy.T),s("A = 16",m.Zy.A),s("C = 48",m.Zy.C)),l();let p=i(null,1,.5),x=i(null,1);l(),(0,m.KE)(t)(ey(),s("A = 16",m.Zy.A),s("C",m.Zy.C),s("C",m.Zy.C)),l();let y=i(null,3);l(),(0,m.KE)(t)(eg()),l();let g=i(null,1,.5),v=i(null,3);if(c(g,[p,x]),l(),(0,m.KE)(t)(ev()),l(),p.active)for(let e of u.heads)for(let t of e.cubes)t!==e.vOutBlock&&(t.opacity=(0,f.JF)(1,0,p.t));if(x.active){let e=u.attnOut.z;for(let t=0;t<u.heads.length;t++){let n=u.heads[t],o=n.vOutBlock.y+n.vOutBlock.dy*(t-u.heads.length+1);n.vOutBlock.y=(0,f.t7)(n.vOutBlock.y,o,x.t),n.vOutBlock.z=(0,f.t7)(n.vOutBlock.z,e,x.t)}}let b=E(n,u.attnOut);y.active&&R(n,y,u.attnOut,b),(0,m.o0)(n,g,new h.AO(-8.304,0,-175.482),new h.AO(293.606,2.623,2.618)),v.active&&R(n,v,u.attnResidual,b)}(o),function(e){let{walkthrough:t,state:n,layout:o,tools:{afterTime:l,c_blockRef:i,c_dimRef:r,breakAfter:c,cleanup:u}}=e;if(t.phase!==a.Input_Detail_Mlp)return;let d=o.blocks[0];(0,m.w4)(n,new h.AO(-154.755,0,-460.042),new h.AO(289.1,-8.9,2.298)),t.dimHighlightBlocks=[d.ln2.lnResid,d.mlpAct,d.mlpFc,d.mlpFcBias,d.mlpFcWeight,d.mlpProjBias,d.mlpProjWeight,d.mlpResult,d.mlpResidual],(0,m.KE)(t)(eb(),i("layer normalization",d.ln2.lnResid),r("C = 48",m.Zy.C),i("linear transformation",d.mlpFcWeight),i("bias",d.mlpFcBias),r("4 * C",m.Zy.C4),i("linear transformation",d.mlpProjWeight),i("bias",d.mlpProjBias),r("C",m.Zy.C)),c();let x=l(null,1);c(),(0,m.KE)(t)(ew(),r("4 * C",m.Zy.C4)),c();let y=l(null,3);c(),(0,m.KE)(t)(e_(),(0,p.jsx)("code",{children:"max(0, x)"}),(0,p.jsx)(eB,{})),c();let g=l(null,3);c(),(0,m.KE)(t)(eA(),r("C",m.Zy.C)),c();let v=l(null,3);c(),(0,m.KE)(t)(ek()),c();let b=l(null,3);c(),(0,m.KE)(t)(eT()),c();let A=l(null,1,.5);u(A,[x]);let k=l(null,6);c(),(0,m.KE)(t)(eO());let T=d.ln2.lnResid,O=d.mlpFc,B=d.mlpAct,z=d.mlpResult,M=d.mlpResidual;function P(e,t,n){if(0===x.t||k.t>0)return;n&&(e.access.disable=!0);let l=(0,s.n2)(o,e,t,3.5,(0,f.t7)(0,1,x.t));for(let t of e.subs)t.opacity=(0,f.t7)(1,.2,x.t);return l.opacity=1,l}P(T,h.JU.X,!1);let F=P(O,h.JU.Y,!0),C=P(B,h.JU.Y,!0),j=P(z,h.JU.X,!0),D=P(M,h.JU.X,!0);function I(e,t,l,i){if(0===l)return;let r=e.transpose?h.JU.Y:h.JU.X,a=e.transpose?h.JU.X:h.JU.Y,{cx:c}=(0,s.gW)(e,a),u=Math.floor((0,f.t7)(0,c,l)),d=new h.AO().setAt(r,3).setAt(a,u).round_();if(t)for(let e of((0,s.n2)(o,t,a,u,0),(0,s.L3)(t,a,0,u)))e.access.disable=!1;l<1?((0,_.iW)(n,e,d,i),(0,w.Tl)(n,e,d)):t&&(t.access.disable=!1)}if(I(O,F,y.t,new h.AO(40)),I(B,C,g.t,new h.AO(O.cx/2,-15)),I(z,j,v.t,new h.AO(z.cx/2,-15)),I(M,D,b.t,new h.AO(z.cx/2,-15)),A.t>.4&&(O.access.disable=!0,B.access.disable=!0,z.access.disable=!0,M.access.disable=!0),k.t>0){let e=E(n,T);R(n,k,M,e)}}(o),function(e){let{walkthrough:t,state:n}=e;t.phase===a.Input_Detail_Transformer&&((0,m.w4)(n,new h.AO(-135.531,0,-353.905),new h.AO(291.1,13.6,5.706)),(0,m.KE)(t,null,0)(ez()))}(o),function(e){let{walkthrough:t,state:n}=e;t.phase===a.Input_Detail_Output&&((0,m.w4)(n,new h.AO(-20.203,0,-1642.819),new h.AO(281.6,-7.9,2.298)),(0,m.KE)(t,null,0)(eE()))}(o)),n.prevPhase=n.phase,n.prevTime=n.time}(l=r||(r={}))[l.Intro=0]="Intro",l[l.Detailed_Input=1]="Detailed_Input",(i=a||(a={}))[i.None=0]="None",i[i.Intro_Intro=1]="Intro_Intro",i[i.Input_First=2]="Input_First",i[i.Input_Detail_Tables=3]="Input_Detail_Tables",i[i.Input_Detail_TokEmbed=4]="Input_Detail_TokEmbed",i[i.LayerNorm1=5]="LayerNorm1",i[i.Intro_Prelim=6]="Intro_Prelim",i[i.Input_Detail_Embedding=7]="Input_Detail_Embedding",i[i.Input_Detail_LayerNorm=8]="Input_Detail_LayerNorm",i[i.Input_Detail_SelfAttention=9]="Input_Detail_SelfAttention",i[i.Input_Detail_Softmax=10]="Input_Detail_Softmax",i[i.Input_Detail_Projection=11]="Input_Detail_Projection",i[i.Input_Detail_Mlp=12]="Input_Detail_Mlp",i[i.Input_Detail_Transformer=13]="Input_Detail_Transformer",i[i.Input_Detail_Output=14]="Input_Detail_Output"},2261:function(e,t,n){"use strict";n.d(t,{$Z:function(){return s},GB:function(){return w},KE:function(){return h},Mb:function(){return c},W:function(){return g},Yp:function(){return d},Zy:function(){return l},c6:function(){return y},o0:function(){return x},oB:function(){return v},oj:function(){return f},w4:function(){return p},wL:function(){return b}});var o,l,i=n(9107),r=n(7898),a=n(9158);function s(e){return{insert:()=>e}}function c(e){let t=e.walkthrough;function n(e,n,o){return u(t,e,n,o)}function o(e,o,l){return n((e=null!=e?e:t.times[t.times.length-1]).start+e.duration+e.wait,o,l)}return{atTime:n,atEvent:function(e){return n(e.start,e.duration)},afterTime:o,cleanup:function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.times;if(e.t>0)for(let t of n)t.t=1-e.t,e.t>=1&&(t.active=!1)},commentary:function(t){for(var n=arguments.length,o=Array(n>1?n-1:0),l=1;l<n;l++)o[l-1]=arguments[l];return m(e,null,t,...o)},commentaryPara:function(t){return function(n){for(var o=arguments.length,l=Array(o>1?o-1:0),i=1;i<o;i++)l[i-1]=arguments[i];return m(e,t,n,...l)}},c_str:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.T;return{str:e,duration:t,start:0,t:0,color:y(n)}},c_blockRef:function(e,t,n){let o=Array.isArray(t)?t[0]:t;return null!=n||(n="i"===o.t?l.Intermediates:"w"===o.t?l.Weights:l.Aggregates),{str:e,duration:0,start:0,t:0,color:y(n),blk:t}},c_dimRef:function(e,t){return{str:e,duration:0,start:0,t:0,color:y(t),dim:t}},breakAfter:function(e){if(!(e=null!=e?e:t.times[t.times.length-1]))return;let n=o(e,.001);t.running&&t.time-t.dt<n.start&&t.time>=n.start&&(t.running=!1,t.speed=1,t.time=n.start+n.duration),n.isBreak=!0}}}function u(e,t,n,o){let l={name:"",start:t,duration:n=null!=n?n:0,wait:o=null!=o?o:0,t:0===n?e.time>t?1:0:(0,i.uZ)((e.time-t)/n,0,1),active:e.time>t};return e.times.push(l),e.phaseLength=Math.max(e.phaseLength,t+n+o),l}function d(e){return e.start+e.duration+e.wait}function f(e){return"strings"in e}function h(e,t,n){return function(o){for(var l=arguments.length,i=Array(l>1?l-1:0),r=1;r<l;r++)i[r-1]=arguments[r];(t=null!=t?t:e.times[e.times.length-1])&&(t.start,t.duration,t.wait);let a={...u(e,t?d(t):0,null!=n?n:.2),strings:o,values:i};return e.times[e.times.length-1]=a,a}}function m(e,t,n){for(var o,l,s=arguments.length,c=Array(s>3?s-3:0),d=3;d<s;d++)c[d-3]=arguments[d];let f=null!==(o=null==t?void 0:t.duration)&&void 0!==o?o:0,h=0,m=t?t.lineOffset+30.599999999999998:10,p=n.map(e=>e.replace(/([ \n])+/g," "));for(let e=0;e<c.length+1;e++)f+=p[e].length/400,e<c.length&&"t"in c[e]&&(c[e].start=f,f+=c[e].duration);let x=e.walkthrough.time;function y(t,n,o,l,s){for(;t.startsWith("\n\n");)m+=20.4,h=0,t=t.substring(2);let c=t=t.replace(/([ \n])+/g," "),u=0,d=(0,r.Ux)(e.render.modelFontBuf,t,17);h+d>500?(m+=20.4,h=0,c=t.trimStart(),u=d=(0,r.Ux)(e.render.modelFontBuf,c,17)):u=h+d;let f=new a.T8(.5,.5,.5,1).mul(.5);if(x>n){let e=null!=l?l:new a.T8(.1,.1,.1,1),t=(0,i.uZ)((x-n)/(o-n),0,1);f=a.T8.lerp(f,e,t)}h=u}f=null!==(l=null==t?void 0:t.duration)&&void 0!==l?l:0;for(let e=0;e<c.length+1;e++){for(let t of p[e].split(/(?=[ \n]+)/).filter(e=>" "!==e)){let e=f+t.length/400;y(t,f,e),f=e}if(e<c.length&&"t"in c[e]){let t=c[e];t.start=f,y(c[e].str,f,t.color,t.fontFace),f+=t.duration}}let g={...u(e.walkthrough,0,f,0),stringsArr:n,values:c,lineOffset:m,colNum:h,commentaryList:[]};return g.commentaryList=[g],t?(t.lineOffset=m,t.colNum=h,t.duration=f,t.commentaryList=[...t.commentaryList,g]):e.walkthrough.commentary=g,g}function p(e,t,n){var o,l,i;let r=e.walkthrough;r.cameraInitial={angle:n,center:t};let a=(null!==(o=r.phaseTransitiveData)&&void 0!==o||(r.phaseTransitiveData={}),r.phaseTransitiveData);if(0===r.time&&(null!==(l=a.cameraSrc)&&void 0!==l||(a.cameraSrc={angle:e.camera.angle,center:e.camera.center}),null!==(i=a.cameraT)&&void 0!==i||(a.cameraT=0),a.cameraT<1)){let t=a.cameraSrc,n=r.cameraInitial,o=a.cameraT;e.camera.angle=t.angle.lerp(n.angle,o),e.camera.center=t.center.lerp(n.center,o),a.cameraT=o+r.viewDt/1e3*1.5,r.markDirty()}}function x(e,t,n,o){var l,i,r,a;let s=e.walkthrough,c=s.phaseData.get(s.phase);c||s.phaseData.set(s.phase,c={cameraData:null}),c.cameraData||(c.cameraData=new Map);let u=null===(l=[...c.cameraData.entries()].filter(e=>{let[n,o]=e;return n<t.start}).pop())||void 0===l?void 0:l[1],d=c.cameraData.get(t.start);d||c.cameraData.set(t.start,d={initialCaptured:u?void 0:null!==(i=s.cameraInitial)&&void 0!==i?i:{angle:e.camera.angle,center:e.camera.center},target:{angle:o,center:n}});let f=null!==(a=null!==(r=null==u?void 0:u.target)&&void 0!==r?r:s.cameraInitial)&&void 0!==a?a:d.initialCaptured,h={center:n,angle:o},m=s.running||s.time!==s.prevTime,p=s.prevTime>=t.start&&s.prevTime<=t.start+t.duration;if(f&&m&&(t.active||p)){let n=t.t;e.camera.angle=f.angle.lerp(h.angle,n),e.camera.center=f.center.lerp(h.center,n)}}function y(e){switch(e){case l.t:case l.T:return a.T8.fromHexColor("#359da8");case l.A:return a.T8.fromHexColor("#d368a4");case l.C:case l.C4:return a.T8.fromHexColor("#ce2983");case l.Token:return new a.T8(.3,.7,.3,1);case l.TokenIdx:return a.T8.fromHexColor("#1b495d");case l.n_vocab:return a.T8.fromHexColor("#7c3c8d");case l.Intermediates:return a.T8.fromHexColor("#00ad00");case l.Weights:return b.Weights;case l.Aggregates:return a.T8.fromHexColor("#e3a300")}return new a.T8(0,0,0)}function g(e){switch(e){case l.TokenIdx:return"Token Index";case l.C4:return"C * 4";default:return l[e]}}function v(e){switch(e){case l.B:return"b";case l.T:return"t";case l.A:return"a";case l.C:case l.C4:return"c";default:return l[e]}}(o=l||(l={}))[o.None=0]="None",o[o.t=1]="t",o[o.T=2]="T",o[o.C=3]="C",o[o.B=4]="B",o[o.A=5]="A",o[o.n_vocab=6]="n_vocab",o[o.n_heads=7]="n_heads",o[o.n_layers=8]="n_layers",o[o.Token=9]="Token",o[o.TokenIdx=10]="TokenIdx",o[o.C4=11]="C4",o[o.Intermediates=12]="Intermediates",o[o.Weights=13]="Weights",o[o.Aggregates=14]="Aggregates";let b={Weights:new a.T8(.3,.3,1),Intermediates:new a.T8(.4,.8,.4),Aggregates:new a.T8(1,.8,.3),Black:new a.T8(0,0,0)};function w(e,t,n){let o=!1;for(let e of t.cubes)o||e!==n||(o=!0),o&&"i"===e.t&&function e(t){var n;t.access&&(t.access.disable=!0),null===(n=t.subs)||void 0===n||n.forEach(e)}(e)}},1280:function(e,t,n){"use strict";n.d(t,{JF:function(){return i},pn:function(){return r},t7:function(){return l}});var o=n(9107);function l(e,t,n){return e+(t-e)*(0,o.uZ)(n,0,1)}function i(e,t,n){return n<=0?e:n>=1?t:e+(t-e)*n*n*(3-2*n)}function r(e,t){return Math.ceil(e/t)*t}},9073:function(e,t,n){"use strict";n.d(t,{OO:function(){return l}});var o=n(9158);class l extends Float32Array{g(e,t){return this[4*t+e]}s(e,t,n){this[4*t+e]=n}add(e){let t=new l;for(let n=0;n<16;n++)t[n]=this[n]+e[n];return t}sub(e){let t=new l;for(let n=0;n<16;n++)t[n]=this[n]-e[n];return t}mul(e){let t=new l;for(let n=0;n<4;n++)for(let o=0;o<4;o++){let l=0;for(let t=0;t<4;t++)l+=this[4*t+o]*e[4*n+t];t[4*n+o]=l}return t}mulVec4(e){let t=this[0]*e.x+this[4]*e.y+this[8]*e.z+this[12]*e.w,n=this[1]*e.x+this[5]*e.y+this[9]*e.z+this[13]*e.w,l=this[2]*e.x+this[6]*e.y+this[10]*e.z+this[14]*e.w,i=this[3]*e.x+this[7]*e.y+this[11]*e.z+this[15]*e.w;return new o.T8(t,n,l,i)}mulVec3Proj(e){let t=this.mulVec4(new o.T8(e.x,e.y,e.z,1)),n=1/t.w;return new o.AO(t.x*n,t.y*n,t.z*n)}mulVec3ProjVec(e){let t=this.mulVec4(new o.T8(e.x,e.y,e.z,0));return new o.AO(t.x,t.y,t.z)}mulVec3Affine(e){let t=new o.AO;return this.mulVec3Affine_(e,t),t}mulVec3Affine_(e,t){let n=this[0]*e.x+this[4]*e.y+this[8]*e.z+this[12],o=this[1]*e.x+this[5]*e.y+this[9]*e.z+this[13],l=this[2]*e.x+this[6]*e.y+this[10]*e.z+this[14];t.x=n,t.y=o,t.z=l}mulVec3AffineArr_(e,t,n,o){let l=e[t],i=e[t+1],r=e[t+2];n[o+0]=this[0]*l+this[4]*i+this[8]*r+this[12],n[o+1]=this[1]*l+this[5]*i+this[9]*r+this[13],n[o+2]=this[2]*l+this[6]*i+this[10]*r+this[14]}mulVec3AffineVec_(e,t){let n=this[0]*e.x+this[4]*e.y+this[8]*e.z,o=this[1]*e.x+this[5]*e.y+this[9]*e.z,l=this[2]*e.x+this[6]*e.y+this[10]*e.z;t.x=n,t.y=o,t.z=l}static fromRowMajor(e){e.length>0&&Array.isArray(e[0])&&(e=e.flatMap(e=>e));let t=e;16!==t.length&&console.log("need 16 elements");let n=new l;for(let e=0;e<4;e++)for(let o=0;o<4;o++)n[4*e+o]=t[4*o+e];return n}static fromColMajor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e.length-t<16&&console.log("need 16 elements");let n=new l;for(let o=0;o<16;o++)n[o]=e[t+o];return n}static fromTranslation(e){let t=new l;return t[12]=e.x,t[13]=e.y,t[14]=e.z,t}static fromScaleTranslation(e,t){let n=new l;return n[0]=e.x,n[5]=e.y,n[10]=e.z,n[12]=t.x,n[13]=t.y,n[14]=t.z,n}static fromAxisAngle(e,t){let n,o,i,r,a,s,c,u,d=new l;return n=e.normalize(),o=Math.cos(t),i=Math.sin(t),r=n.x,a=n.y,s=n.z,c=1-o,u=0,d[0]=r*r*c+o,d[u+1]=a*r*c+s*i,d[u+2]=s*r*c-a*i,d[(u=4)+0]=r*a*c-s*i,d[u+1]=a*a*c+o,d[u+2]=s*a*c+r*i,d[(u=8)+0]=r*s*c+a*i,d[u+1]=a*s*c-r*i,d[u+2]=s*s*c+o,d}static fromQuat(e){let t,n,o,i,r,a,s,c=new l;return n=0===(t=e.lenSq())?0:2/t,o=e.x,i=e.y,r=e.z,a=e.w,s=0,c[0]=1-n*(i*i+r*r),c[s+1]=n*(o*i+a*r),c[s+2]=n*(o*r-a*i),c[(s=4)+0]=n*(o*i-a*r),c[s+1]=1-n*(o*o+r*r),c[s+2]=n*(i*r+a*o),c[(s=8)+0]=n*(o*r+a*i),c[s+1]=n*(i*r-a*o),c[s+2]=1-n*(o*o+i*i),c}static fromScale(e){let t=new l;return t[0]=e.x,t[5]=e.y,t[10]=e.z,t}static fromLookAt(e,t,n){let i=e.sub(t).normalize(),r=n.normalize(),a=o.AO.cross(r,i).normalize();r=o.AO.cross(i,a);let s=new l;return s[0]=a.x,s[1]=r.x,s[2]=i.x,s[4]=a.y,s[5]=r.y,s[6]=i.y,s[8]=a.z,s[9]=r.z,s[10]=i.z,s[12]=-e.dot(a),s[13]=-e.dot(r),s[14]=-e.dot(i),s}static fromPersp(e,t,n,o){let i=n*Math.tan(e/2*Math.PI/180)*2,r=new l;return r[0]=2*n/(i*t),r[5]=2*n/i,r[10]=-o/(o-n),r[11]=-1,r[14]=-o*n/(o-n),r[15]=0,r}static fromOrtho(e,t,n,o,i,r){let a=new l;return a[0]=2/(t-e),a[5]=2/(o-n),a[10]=-2/(r-i),a[12]=-(t+e)/(t-e),a[13]=-(o+n)/(o-n),a[14]=-(r+i)/(r-i),a}static zeros(){let e=new l;return e[0]=0,e[5]=0,e[10]=0,e[15]=0,e}decomposeToTRS(){let e,t=o.AO.fromArray(this,12),n=new o.AO(o.AO.fromArray(this,0).len(),o.AO.fromArray(this,4).len(),o.AO.fromArray(this,8).len()),l=this[0]+this[5]+this[10];if(l>0){let t=Math.sqrt(1+l),n=.5/t;e=new o.T8((this[6]-this[9])*n,(this[8]-this[2])*n,(this[1]-this[4])*n,.5*t)}else if(this[0]>this[5]&&this[0]>this[10]){let t=Math.sqrt(1+this[0]-this[5]-this[10]),n=.5/t;e=new o.T8(.5*t,(this[1]+this[4])*n,(this[8]+this[2])*n,(this[6]-this[9])*n)}else if(this[5]>this[10]){let t=Math.sqrt(1+this[5]-this[0]-this[10]),n=.5/t;e=new o.T8((this[4]+this[1])*n,.5*t,(this[9]+this[6])*n,(this[8]-this[2])*n)}else{let t=Math.sqrt(1+this[10]-this[0]-this[5]),n=.5/t;e=new o.T8((this[8]+this[2])*n,(this[9]+this[6])*n,.5*t,(this[1]-this[4])*n)}return[t,e,n]}invertTRS(){let e=new l,t=o.AO.fromArray(this,0),n=o.AO.fromArray(this,4),i=o.AO.fromArray(this,8),r=o.AO.fromArray(this,12);return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[12]=-t.dot(r),e[13]=-n.dot(r),e[14]=-i.dot(r),e}determinant(){let e=new Float64Array(this),t=new Int32Array(5);return i(e,t,4),function(e,t,n){let o=e[0];for(let t=1;t<n;t++)o*=e[t*n+t];return t[n]-n&1?-o:o}(e,t,4)}invert(){let e=new Float64Array(this),t=new Int32Array(5);i(e,t,4);let n=new l;return function(e,t,n,o){for(let l=0;l<n;l++){for(let i=0;i<n;i++){o[i*n+l]=t[i]===l?1:0;for(let t=0;t<i;t++)o[i*n+l]-=e[i*n+t]*o[t*n+l]}for(let t=n-1;t>=0;t--){for(let i=t+1;i<n;i++)o[t*n+l]-=e[t*n+i]*o[i*n+l];o[t*n+l]/=e[t*n+t]}}}(e,t,4,n),n}toString(){let e="\n";for(let t=0;t<4;t++){e+=0===t?"[[":" [";for(let n=0;n<4;n++){let o=this.g(t,n);e+=(o<0?"":" ")+o.toFixed(3)+(3===n?"]":", ")}e+=3===t?"]":"\n"}return e}constructor(){super(16),this[0]=this[5]=this[10]=this[15]=1}}function i(e,t,n){for(let e=0;e<=n;e++)t[e]=e;for(let o=0;o<n;o++){let l=0,i=o;for(let t=o;t<n;t++){let r=Math.abs(e[t*n+o]);r>l&&(l=r,i=t)}if(l<1e-9)return!1;if(i!==o){let l=t[o];t[o]=t[i],t[i]=l;for(let t=0;t<n;t++){let l=e[o*n+t];e[o*n+t]=e[i*n+t],e[i*n+t]=l}t[n]+=1}for(let t=o+1;t<n;t++){e[t*n+o]/=e[o*n+o];for(let l=o+1;l<n;l++)e[t*n+l]-=e[t*n+o]*e[o*n+l]}}}l.identity=new l},5666:function(e,t,n){"use strict";n.d(t,{k:function(){return l}});var o=n(9107);class l{randint(e,t){return(0,o.uZ)(Math.floor(this.random()*(t-e)+e),e,t-1)}constructor(e){var t,n,o,l,i;let r;this.normal=()=>Math.sqrt(-2*Math.log(this.random()))*Math.cos(2*Math.PI*this.random()),this.random=(n=(r=function(e){for(var t=0,n=1779033703^e.length;t<e.length;t++)n=(n=Math.imul(n^e.charCodeAt(t),3432918353))<<13|n>>>19;return function(){return n=Math.imul((n=Math.imul(n^n>>>16,2246822507))^n>>>13,3266489909),(n^=n>>>16)>>>0}}(null!=(t=null==e?void 0:e.toString())?t:Math.random().toString()))(),o=r(),l=r(),i=r(),function(){n>>>=0,o>>>=0,l>>>=0,i>>>=0;var e=n+o|0;return n=o^o>>>9,o=l+(l<<3)|0,l=(l=l<<21|l>>>11)+(e=e+(i=i+1|0)|0)|0,(e>>>0)/4294967296})}}},6843:function(e,t,n){"use strict";n.d(t,{BH:function(){return h},BX:function(){return d},EO:function(){return f},FT:function(){return a},OM:function(){return r},Sr:function(){return u},ZZ:function(){return m},bq:function(){return p},gX:function(){return s},mD:function(){return l},tQ:function(){return i},tZ:function(){return c}});var o=n(1280);function l(e){return{gl:e,vertShaders:new Map,fragShaders:new Map,programs:[],unlinkedPrograms:[]}}function i(e,t,n,o,l,i){var r;"shaderManager"in e&&(e=e.shaderManager);let a=e.gl,s=a.createProgram();function c(e,t,n,o){let l=o.get(t);return l||(l=a.createShader(e),a.shaderSource(l,t),a.compileShader(l),o.set(t,l)),a.attachShader(s,l),l}let u=c(a.VERTEX_SHADER,n,"vert",e.vertShaders),d=c(a.FRAGMENT_SHADER,o,"frag",e.fragShaders),f={};if(l)for(let e of l)f[e]=-1;let h={name:t,program:s,vertSource:n,fragSource:o,vertShader:u,fragShader:d,locs:f,uboBindings:null!==(r=null==i?void 0:i.uboBindings)&&void 0!==r?r:{},ready:!1};return e.unlinkedPrograms.push(h),h}function r(e){let t=e.gl;for(let n of e.unlinkedPrograms)t.linkProgram(n.program);for(let l of e.unlinkedPrograms){let e=l.program;if(t.getProgramParameter(e,t.LINK_STATUS)){for(let n of Object.keys(l.locs)){let o=t.getUniformLocation(e,n);o||console.log("uniform of ".concat(l.name," not found: ").concat(n," (may just be unused)")),l.locs[n]=o}for(let n of(l.ready=!0,Object.keys(l.uboBindings))){let o=t.getUniformBlockIndex(e,n);o<0&&console.log("ubo of ".concat(l.name," not found: ").concat(n," (may just be unused)")),t.uniformBlockBinding(e,o,l.uboBindings[n])}}else{if(t.getProgramInfoLog(e)){var n;let o="---- '".concat(l.name,"' program info log ----");console.log("".concat(o,"\n")+(null===(n=t.getProgramInfoLog(e))||void 0===n?void 0:n.replace("\x00","").trimEnd()))}o(l.vertShader,l.name,"vert"),o(l.fragShader,l.name,"frag")}}function o(e,n,o){let l=t.getShaderInfoLog(e);if(l){let e="---- ".concat(n," ").concat(o," shader info log ----");console.log("".concat(e,"\n")+l.replace("\x00","").trimEnd())}}e.programs.push(...e.unlinkedPrograms),e.unlinkedPrograms=[]}function a(e,t,n,o){var l,i;e.bindBuffer(e.ARRAY_BUFFER,t);let r=n.locOffset||0,a=n.bufOffset||0,s=n.divisor||0,c=0;for(let e of o)c+=4*e.size*(null!==(l=e.nCols)&&void 0!==l?l:1);for(let t of o)for(let n=0;n<(null!==(i=t.nCols)&&void 0!==i?i:1);n++)e.enableVertexAttribArray(r),e.vertexAttribPointer(r,t.size,e.FLOAT,!1,c,a),e.vertexAttribDivisor(r,s),a+=4*t.size,r++;return c}function s(e,t,n,l,i,r){var a;let s=(null==r?void 0:r.numPhases)||1;if(t===e.UNIFORM_BUFFER){let t=Math.max(null!==(a=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT))&&void 0!==a?a:0,64);i=(0,o.pn)(i,t)}let c=i/4;e.bindBuffer(t,n),e.bufferData(t,l*i,e.DYNAMIC_DRAW);let u=[];for(let e=0;e<s;e++)u.push({buf:new Float32Array(l*c),strideFloats:c,strideBytes:i,capacityEls:l,usedEls:0,glOffsetEls:0});return{target:t,buf:n,strideFloats:c,strideBytes:i,glCapacityEls:l,localBufs:u}}function c(e,t){let n=e.usedEls+t;if(n>e.capacityEls){for(;n>e.capacityEls;)e.capacityEls*=2;let t=new Float32Array(e.capacityEls*e.strideFloats);t.set(e.buf),e.buf=t}}function u(e,t){e.bindBuffer(t.target,t.buf);let n=0;for(let e=0;e<t.localBufs.length;e++)n+=t.localBufs[e].usedEls;if(n>t.glCapacityEls){for(;n>t.glCapacityEls;)t.glCapacityEls*=2;e.bufferData(t.target,t.glCapacityEls*t.strideBytes,e.DYNAMIC_DRAW)}let o=0;for(let n=0;n<t.localBufs.length;n++){let l=t.localBufs[n];l.glOffsetEls=o,l.usedEls>0&&e.bufferSubData(t.target,o*t.strideBytes,l.buf.subarray(0,l.usedEls*l.strideFloats)),o+=l.usedEls}}function d(e){for(let t=0;t<e.localBufs.length;t++)e.localBufs[t].usedEls=0}function f(e,t,n,o){let l=(null==o?void 0:o.numPhases)||1;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,4*n,e.DYNAMIC_DRAW);let i=[];for(let e=0;e<l;e++)i.push({buf:new Uint32Array(n),capacityVerts:n,usedVerts:0,glOffsetBytes:0});return{buf:t,glCapacityVerts:n,localBufs:i}}function h(e,t){let n=e.usedVerts+t;if(n>e.capacityVerts){let t=2*e.capacityVerts;for(;n>t;)t*=2;let o=new Uint32Array(t);o.set(e.buf),e.capacityVerts=t,e.buf=o}}function m(e,t){e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.buf);let n=0;for(let e=0;e<t.localBufs.length;e++)n+=t.localBufs[e].usedVerts;if(n>t.glCapacityVerts){for(;n>t.glCapacityVerts;)t.glCapacityVerts*=2;e.bufferData(e.ELEMENT_ARRAY_BUFFER,4*t.glCapacityVerts,e.DYNAMIC_DRAW)}let o=0;for(let n=0;n<t.localBufs.length;n++){let l=t.localBufs[n];l.glOffsetBytes=4*o;let i=l.buf.subarray(0,l.usedVerts);l.usedVerts>0&&e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,4*o,i),o+=l.usedVerts}}function p(e){for(let t=0;t<e.localBufs.length;t++)e.localBufs[t].usedVerts=0}},2048:function(e){e.exports={title:"Commentary_title__9oCTc",tocBackground:"Commentary_tocBackground__oThfn",walkthroughViewport:"Commentary_walkthroughViewport__cj_wY",walkthroughText:"Commentary_walkthroughText__grBzj",walkthroughParas:"Commentary_walkthroughParas__iceMD",chapterControls:"Commentary_chapterControls__08VdM",chapterTitle:"Commentary_chapterTitle__ejBeS",controls:"Commentary_controls__odOrv",btn:"Commentary_btn__qpOgN",prevNextBtn:"Commentary_prevNextBtn__uw7Ei",commentaryBreak:"Commentary_commentaryBreak__s9i5H",playPause:"Commentary_playPause__NctlD",jump:"Commentary_jump__uT7ow",dividerLine:"Commentary_dividerLine__XTLaK",activeRange:"Commentary_activeRange__0ny0d",beadOfLight:"Commentary_beadOfLight__9Cwgu",sectionHighlightWrap:"Commentary_sectionHighlightWrap__2QQKY"}},8248:function(e){e.exports={view:"LayerView_view__Tjb_T",sidebar:"LayerView_sidebar__rYQhV",canvasWrap:"LayerView_canvasWrap__Nz_uj",canvas:"LayerView_canvas__UYk4I",canvasEventSurface:"LayerView_canvasEventSurface__1KPkQ"}},3426:function(e){e.exports={timelineBase:"PhaseTimeline_timelineBase__i4V5a",timelineLine:"PhaseTimeline_timelineLine__2OIT9",timelineCaret:"PhaseTimeline_timelineCaret___TlTl",timelineCaretHit:"PhaseTimeline_timelineCaretHit__W86E2",timelineEvt:"PhaseTimeline_timelineEvt__KNUJx",timelineEvtStart:"PhaseTimeline_timelineEvtStart__kD_4g",timelineEvtEnd:"PhaseTimeline_timelineEvtEnd__AitmT",timelineBaseHoriz:"PhaseTimeline_timelineBaseHoriz__jvRf8",timelineLineHoriz:"PhaseTimeline_timelineLineHoriz__YXMM6",timelineCaretHoriz:"PhaseTimeline_timelineCaretHoriz__D8clA",timelineCaretHitHoriz:"PhaseTimeline_timelineCaretHitHoriz__8EXt8",timelineEvtHoriz:"PhaseTimeline_timelineEvtHoriz__eHPvT",timelineEvtStartHoriz:"PhaseTimeline_timelineEvtStartHoriz__ThdRv",timelineEvtEndHoriz:"PhaseTimeline_timelineEvtEndHoriz__D0yl2"}},2008:function(e){e.exports={split:"Sidebar_split___9RZf",walkthrough:"Sidebar_walkthrough__Gkr1T",timelineLeft:"Sidebar_timelineLeft__e8aE_",content:"Sidebar_content__M6iat",phaseGroupTitle:"Sidebar_phaseGroupTitle__Li2MO",phase:"Sidebar_phase__6CZQs",active:"Sidebar_active__5aKCi",phaseTitle:"Sidebar_phaseTitle__r6mbd",topSplit:"Sidebar_topSplit__cAaab",camStats:"Sidebar_camStats__l3zK5",title:"Sidebar_title__hqVHx",toc:"Sidebar_toc__ncbvo",helpers:"Sidebar_helpers__EJodm",popup:"Sidebar_popup__V9b4I",mainMenu:"Sidebar_mainMenu__jd7I1",menu:"Sidebar_menu__z2UJk",menuTopBar:"Sidebar_menuTopBar__PPm6Z"}},3010:function(e){e.exports={modalWindow:"WelcomePopup_modalWindow__3eNZb",modalWindowBackdrop:"WelcomePopup_modalWindowBackdrop__gSWbu",opacityFadeIn:"WelcomePopup_opacityFadeIn__hLBQy",header:"WelcomePopup_header__WCDcc",body:"WelcomePopup_body__U1IBd",image:"WelcomePopup_image__zzf1U",text:"WelcomePopup_text__jnyN5",footer:"WelcomePopup_footer__AG95A",infoBtn:"WelcomePopup_infoBtn__SAr9n"}},5784:function(e){e.exports={tocDiagram:"TocDiagram_tocDiagram__eJiui",toc:"TocDiagram_toc__yJlTr",tocTitle:"TocDiagram_tocTitle__H3jtZ",tocGroupTitle:"TocDiagram_tocGroupTitle__EzX1I",menuEntry:"TocDiagram_menuEntry__xVQYF",active:"TocDiagram_active__FzTAa",hover:"TocDiagram_hover__52Xwi",dataPath:"TocDiagram_dataPath__UCjX8",gap:"TocDiagram_gap__VTpn2"}},6500:function(e){e.exports={tableWrap:"Walkthrough_tableWrap__zEbW3",table:"Walkthrough_table__zkmDL",tokString:"Walkthrough_tokString__YKnMY",tokIndex:"Walkthrough_tokIndex__lJuNg",cellInfoCols:"Walkthrough_cellInfoCols__GkQL9",cellInfoCol:"Walkthrough_cellInfoCol__ESJaY",cellInfoText:"Walkthrough_cellInfoText__wEYEf",cellArrayHoriz:"Walkthrough_cellArrayHoriz__rFO1E",cellRect:"Walkthrough_cellRect__3Oc7J",cellCircle:"Walkthrough_cellCircle__4IZwo",graph:"Walkthrough_graph__klTBM",graphCol:"Walkthrough_graphCol__36PIM",graphBar:"Walkthrough_graphBar__X15Rd",graphBarLabel:"Walkthrough_graphBarLabel__mMc6E",graphBarHit:"Walkthrough_graphBarHit___0SS5",axisZero:"Walkthrough_axisZero__uHUMa",externalLink:"Walkthrough_externalLink__8Y7Rh"}}},function(e){e.O(0,[676,685,72,517,261,678,971,596,744],function(){return e(e.s=8868)}),_N_E=e.O()}]);
//# sourceMappingURL=page-7a4079abac54a06a.js.map